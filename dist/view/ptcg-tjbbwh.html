<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>统计报表维护</title>
    <link rel="stylesheet" href="../css/base.css"/>
    <link rel="stylesheet" href="../css/ptcg.css">
</head>
<body>
<div class="query-condition mt10 tac">
    <form id="query-report-form">
        <div class="query-condition-p">
            <span class="common-field w65">项目单位：</span>
            <div dict-type="tree" dict-root="xzqhdm" dict-name="xmdwdm" id="xmdwdm"></div>
            <span class="common-field w100">报表名称：</span>
            <input type="text" class="common-input mr15" name="bbmkmc">
            <span class="common-field w100">制定者：</span>
            <div dict-type="select" dict-name="zdzzh" id="zdzzh"></div>
            <p class="query-reset">
                <b class="cm-query-btn" id="query-btn"></b>
                <b class="cm-reset-btn" id="reset-btn"></b>
            </p>
        </div>
        <div class="query-condition-p">
            <span class="common-field w65">制定日期：</span>
            <input type="text" name="createDateBegin" class="query-date"/>~<input type="text" name="createDateEnd" class="query-date mr15"/>
        </div>
    </form>
</div>
<div id="query-result" class="mt20">
    <div class="new-color-bar">
        <span class="title">统计报表列表（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div">
            <b class="cm-add-btn hideplus" id="add-report"></b>
        </div>
    </div>
    <table id="statistical-reports-table" class="typical-tb" cellpadding="5">
        <thead>
            <th>序号</th>
            <th>项目代码</th>
            <th>项目单位</th>
            <th>报表代码</th>
            <th>报表名称</th>
            <th>报表简介</th>
            <th>制定人</th>
            <th sort-name="createDate">制定日期</th>
            <th>操作</th>
        </thead>
        <tbody tpsource="#statistical-reports-list"></tbody>
    </table>
    <div class="paging"></div>
</div>
<!--新增弹窗-->
<div id="add-report-block" class="hide">
    <form id="add-form">
        <div class="mt30">
            <span class="common-field w65"><span class="orangered">★ </span>项目单位：</span>
            <div dict-type="tree" dict-root="xzqhdm" dict-name="xmdwdm" dict-id="add-xmdwdm-display" id="add-xmdwdm" class="validate" data-options="required:true"></div>
            <input type="hidden" name="xmdwmc" id="add-xmdwmc">
            <span class="common-field w65"><span class="orangered">★ </span>统计报表代码：</span>
            <input type="text" class="common-input validate" name="bbmkdm" data-options="required:true,validType:'letter'">
        </div>
        <div class="mt10">
            <span class="common-field w65"><span class="orangered">★ </span>统计报表名称：</span>
            <input type="text" class="common-input validate mr15" name="bbmkmc" data-options="required:true,validType:'extLength[1,100]'">
        </div>
        <div class="mt10">
            <span class="common-field vat w65"><span class="orangered">★ </span>报表简介：</span>
            <textarea name="bbjj" id="add-bbjj" class="common-textarea h104 validate" data-options="required:true,validType:'extLength[1,4000]'"></textarea>
        </div>
        <div class="mt10">
            <span class="common-field w65"><span class="orangered">★ </span>制定者：</span>
            <div dict-type="select" dict-name="zdzxm" id="add-zdzxm" class="dict validate mr15" data-options="required:true" return-value="true"></div>
            <span class="common-field w65"><span class="orangered">★ </span>制定日期：</span>
            <input type="text" id="add-zdrq" name="createDate" class="query-date validate mr15" data-options="required:true"/>
            <input type="hidden" name="zdzzh" id="add-zdzzh">
        </div>
        <p class="mt20 mb20 tcenter">
            <b id="add-save-btn" class="cm-save-btn mr15"></b>
            <b id="add-close-btn" class="cm-cancel-btn"></b>
        </p>
    </form>
</div>
<!--修改弹窗-->
<div id="edit-report-block" class="hide">
    <form id="edit-form">
        <input id="edit-id" name="mainId" type="hidden"/>
        <div class="mt30">
            <span class="common-field w65"><span class="orangered">★ </span>项目单位：</span>
            <div dict-type="tree" dict-root="xzqhdm" dict-name="xmdwdm" dict-id="edit-xmdwdm-display" id="edit-xmdwdm" class="dict validate" data-options="required:true"></div>
            <span class="common-field w65"><span class="orangered">★ </span>统计报表代码：</span>
            <input type="text" id="edit-bbmkdm" class="common-input validate" name="bbmkdm" data-options="required:true,validType:'letter'">
            <input type="hidden" name="xmdwmc" id="edit-xmdwmc">
        </div>
        <div class="mt10">
            <span class="common-field w65"><span class="orangered">★ </span>统计报表名称：</span>
            <input type="text" id="edit-bbmkmc" class="common-input validate mr15" name="bbmkmc" data-options="required:true,validType:'extLength[1,100]'">
        </div>
        <div class="mt10">
            <span class="common-field vat w65"><span class="orangered">★ </span>报表简介：</span>
            <textarea id="edit-bbjj" name="bbjj" class="common-textarea validate" data-options="required:true,validType:'extLength[1,4000]'"></textarea>
        </div>
        <div class="mt10">
            <span class="common-field w65"><span class="orangered">★ </span>制定者：</span>
            <div dict-type="select" dict-name="zdzxm" id="edit-zdzxm" class="dict validate mr15" data-options="required:true" return-value="true"></div>
            <input type="hidden" name="zdzzh" id="edit-zdzzh">
            <span class="common-field w65"><span class="orangered">★ </span>制定日期：</span>
            <input type="text" id="edit-zdrq" name="createDate" class="query-date validate mr15" data-options="required:true"/>
        </div>
        <p class="mt20 mb20 tcenter">
            <b id="edit-save-btn" class="cm-save-btn mr15"></b>
            <b id="edit-close-btn" class="cm-cancel-btn"></b>
        </p>
    </form>
</div>
<!--查看弹窗-->
<div id="check-report-block" class="hide">
    <div class="mt30">
        <span class="common-field w65">项目单位：</span>
        <input type="text" id="check-xmdwdm" class="common-input mr15">
        <span class="common-field w65">统计报表代码：</span>
        <input type="text" id="check-bbmkdm" class="readonly-input common-input" name="bbmkdm">
        <input type="hidden" name="xmdwmc" id="check-xmdwmc">
    </div>
    <div class="mt10">
        <span class="common-field w65">统计报表名称：</span>
        <input type="text" id="check-bbmkmc" class="readonly-input common-input" name="bbmkmc">
    </div>
    <div class="mt10">
        <span class="common-field vat w65">报表简介：</span>
        <textarea id="check-bbjj" name="bbjj" class="common-textarea" readonly></textarea>
    </div>
    <div class="mt10">
        <span class="common-field w65">制定者：</span>
        <input type="text" id="check-zdzxm" class="common-input">
        <span class="common-field w65">制定日期：</span>
        <input type="text" id="check-zdrq" name="createDate" class="readonly-input common-input mr15"/>
        <input type="hidden" name="zdzzh" id="check-zdzzh">
    </div>
    <div class="check-comments">
        <h3 class="comments-nav">评 论</h3>
        <dl class="mt20" tpsource="#comments"></dl>
        <h4 class="dim hidden mb15">暂无评论</h4>
    </div>
    <p class="mt20 mb20 tcenter">
        <!--<b id="check-copy-btn" class="cm-save-btn"></b>-->
        <b id="check-close-btn" class="cm-close-btn"></b>
    </p>
</div>
<!--评论弹窗-->
<div id="comments-report-block" class="hide">
    <div id="comments-temp">
        <table>
            <tr>
                <td class="comment-td">
                    <div class="user-info">
                        <i class="icon-user image-font"></i>
                        <p>
                            <span id="share-user" class="comments-author">rr</span>
                        </p>
                        <p>
                            <span class="bb-date">rr</span>
                        </p>
                    </div>
                </td>
                <td>
                    <div class="comments-title comments-showContent"></div>
                    <br>
                    <div class="comments-desc comments-showContent"></div>
                    <br>
                </td>
            </tr>
        </table>
        <hr class="split-line">
        <h3 class="comments-nav">评 论</h3>
        <dl class="mt20" tpsource="#comments"></dl>
    </div>
    <hr class="split-line">
    <form id="comments-form">
        <input id="comment-id" type="hidden" name="pid"/>
        <input id="create-pid" type="hidden" name="createPid">
        <input id="create-name" type="hidden" name="trueName">
        <textarea name="pjnr" id="comments-pjnr-text" placeholder="说点什么..." class="validate common-input" data-options="required:true,validType:'length[1,2000]'"></textarea>
    </form>
    <p class="mt20 mb20 tcenter">
        <b id="comments-save-btn" class="cm-save-btn mr15"></b>
        <b id="comments-close-btn" class="cm-cancel-btn"></b>
    </p>
</div>
</body>
<script type="text/template" id="comments">
    <dt class="pr">
        <i class="icon-user"></i>
        <p>
            <span>{trueName}</span>
            <span>{createDate}</span>
        </p>
    </dt>
    <dd class="comments-pjnr">{pjnr}</dd>
</script>
<script type="text/template" id="statistical-reports-list">
    <tr class="{$nth2}">
        <td>{rownum}</td>
        <td class="xmdwdm">{xmdwdm}</td>
        <td class="xmdwmc">{xmdwmc}</td>
        <td class="bbmkdm">{bbmkdm}</td>
        <td class="bbmkmc">{bbmkmc}</td>
        <td class="bbjj">
            <p class="brief-content">{bbjj}</p>
            <a href="javascript:void(0);" class="more-a" moreId="{id}">更多</a>
        </td>
        <td class="zdzxm">{zdzxm}</td>
        <td class="createDateStr">{createDateStr}</td>
        <td>
            <i class="icon-show-btn" title="查看" mainId="{id}"></i>
            <i class="icon-edit-btn hideplus{this.editLimit}" title="修改" mainId="{id}"></i>
            <a class="icon-remove-btn hideplus{deleteLimit}" title="删除" id="{id}" xmdwmc="{xmdwmc}"></a>
            <i class="icon-comments-btn hideplus{this.commentLimit}" title="评论" mainId="{id}"></i>
            <i class="icon-like-before-btn{sfyz} icon-like-after-btn" statementId="{id}"></i><em> {bbdzs.toString}</em>
        </td>
    </tr>
</script>
<script src="../../dist/js/base.js"></script>
<script>
    // 在doc准备好后,写js逻辑
    importing('dict','datepicker',function () {
        var reportListAction = top.path+'/api/0/ptcg/statement/list',//获得统计报表列表
            getPersonMsgAction = top.path+'/api/0/basic/project/user_info',
            saveAddAction = top.path+'/api/0/ptcg/statement/add',//新增
            saveEditAction = top.path+'/api/0/ptcg/statement/edit',//修改
            reportDeleteAction = top.path+'/api/0/ptcg/statement/delete',//删除
            hitAction = top.path+'/api/0/ptcg/statement/hit', //点赞
            saveCommentAction = top.path+'/api/0/ptcg/statement/comment',//提交评论
            commentsListAction = top.path+'/api/0/ptcg/statement/comment_list',//获取评论列表数据
            managerData,
            mngDict,
            addLimit = top.ops['ptcg-tjbbwh-add'],
            deleteLimit=top.ops['ptcg-tjbbwh-delete'],
            editLimit = top.ops['ptcg-tjbbwh-edit'],
            commentLimit = top.ops['ptcg-tjbbwh-comment'],
            pageData = [];

        var closeWin = function(winId,resetForm) {
            if(winId){
                $(winId).$close();
            }
            if(resetForm) {
                $(resetForm)[0].reset();
            }
            $('.validate').removeClass('validatebox-invalid');
        };
        function loadReportList(currentPage) {
            $('#query-result').pagingList({
                action:reportListAction,
                currentPage:currentPage,
                jsonObj:$('#query-report-form').serializeObject(),
                callback:pageBack
            });
        }
        function pageBack(data) {
            pageData = data;
            $('#statistical-reports-table').find('tbody').fixData({editLimit:editLimit,commentLimit:commentLimit}).template(data,function(item){
                item.deleteLimit = deleteLimit;
                if(item.zdzxm === top.trueName){
                    item.deleteLimit = '1';
                }
            });
            isShowMore();//报表简介更多显示
        }
        function init() {
            //加载模块语句列表数据
            loadReportList();
            //获取项目经理数据
            $get(getPersonMsgAction,{type:1},function (res) {
                managerData = res.data;
                mngDict=$('#edit-zdzxm').dict(managerData);
                $('#zdzzh').dict(managerData);
            });
        }
        function saveReport(action,params,winId,formId) {
            //验证
            $(winId+' .validate').validatebox();
            if($(winId+' .validatebox-invalid').length>0){
                return false;
            }
            //保存
            $post(action,params,function (res) {
                var msg = res.msg?res.msg:'保存成功！';
                closeWin(winId,formId);
                toast(msg,600).ok();
                //加载模块语句列表数据
                loadReportList($('.paging').data('currentPage'));
            },true);

        }
        function initWinData(xmdwdmId,zdzxmId,zdrqId,bbmkdmId,bbmkmcId,bbjjId,isComment) {
            var that = $(this),
                    pTd = that.parent(),
                    bbjjArr = pageData.where('o=>o.id=="'+that.attr('mainId')+'"').select('o=>o.bbjj');
            $(xmdwdmId).val(pTd.siblings('.xmdwdm').html());
            $(zdzxmId).val(pTd.siblings('.zdzxm').html());
            $(xmdwdmId).dictSelect(pTd.siblings('.xmdwdm').html());
            mngDict.dictSelect(pTd.siblings('.zdzxm').html());
            $(zdrqId).val(pTd.siblings('.createDateStr').html());
            $(bbmkdmId).val(pTd.siblings('.bbmkdm').html());
            $(bbmkmcId).val(pTd.siblings('.bbmkmc').html());
            $(bbjjId).html(bbjjArr[0].replace(/<br>|<br\/>/gm,''));
            if(isComment){
                $(zdzxmId).html(pTd.siblings('.zdzxm').html());
                $(bbmkmcId).html(pTd.siblings('.bbmkmc').html());
                $(zdzxmId+' span').html(pTd.siblings('.zdzxm').html());
                $(bbmkmcId).html('<span class="comment-title">报表名称</span>：'+pTd.siblings('.bbmkmc').html());
                $(bbjjId).html('<span class="comment-title">报表简介</span>：'+bbjjArr[0].replace(/<br>|<br\/>/gm,''));
                $('.bb-date').html("制定于 " + pTd.siblings('.createDateStr').html());
            }
        }
        function loadCommentsList(pid,tempId) {
            $post(commentsListAction,{pid:pid},function (res) {
//                log('commentsData:'+obj2str(res.data));
                $(tempId+' dl').template(res.data);//commentsData
                if(res.data.length == 0) {
                    $(".dim").removeClass("hidden");
                } else {
                    if(!$(".dim").hasClass("hidden")) {$(".dim").addClass("hidden")}
                }
            });
        }
        function setHiddenInputValue(editType) {
            var i=0;
            $('#'+editType+'-xmdwmc').val($('#'+editType+'-xmdwdm-display_displayValue').val());
            for(;i<managerData.length;i++){
                if($('#'+editType+'-zdzxm').find('select').val()==managerData[i].value){
                    $('#'+editType+'-zdzzh').val(managerData[i].key);
                }
            }
        }

        //定义验证规则
        $.extend($.fn.validatebox.defaults.rules, {
            letter: {
                validator: function (val) {
                    return /^[a-zA-Z0-9]{1,6}$/.test(val);
                },
                message: '请输入英文或数字，长度在1-6之间'
            }
        });

        init();

        //所属模块与对应页面联动
        $('#ssmk,#add-ssmk').on('change',function () {
            createMatchPageOption(this.id,$(this).val());
        });
        //查询
        $('#query-btn').on('click',function () {
//            if($('.sort-arrow')) $('.sort-arrow').remove();
            loadReportList();
        });
        //重置
        $('#reset-btn').on('click',function () {
            var queryForm = $('#query-report-form');
            queryForm[0].reset();
            queryForm.find('input').val('');
            $('#match-page').html('');
        });
        //打开新增弹窗
        $('#add-report').on('click',function () {
            $open('#add-report-block',{title:'统计报表新增',width:820,onClose:function () {
                closeWin('','#add-form');
            }});
            $('#add-xmdwdm').dict();
            $('#add-zdzxm').dict(managerData).dictSelect(top.trueName);
            $('#add-zdrq').val(Date.format('yyyy-mm-dd'));
        });
        //关闭新增弹窗
        $('#add-close-btn').on('click',function () {
            closeWin('#add-report-block','#add-form');
            $('#add-match-page').html('');
        });
        //保存新增内容
        $('#add-save-btn').on('click',function () {
            setHiddenInputValue('add');
            saveReport(saveAddAction,$('#add-form').serializeObject(),'#add-report-block','#add-form');
        });

        //关闭修改弹窗
        $('#edit-close-btn').on('click',function () {

            closeWin('#edit-report-block','#edit-form');
        });
        //保存修改内容
        $('#edit-save-btn').on('click',function () {
            setHiddenInputValue('edit');
            saveReport(saveEditAction,$('#edit-form').serializeObject(),'#edit-report-block','#edit-form');
        });
        //关闭查看弹窗
        $('#check-close-btn').on('click',function () {
            $('#check-report-block').$close();
        });
        //关闭评论弹窗
        $('#comments-close-btn').on('click',function () {
            closeWin('#comments-report-block','#comments-form');
        });
        //保存评论内容
        $('#comments-save-btn').on('click',function () {
            var commentsBlock = $('#comments-report-block');
            //验证
            commentsBlock.find('.validate').validatebox();
            if(commentsBlock.find('.validatebox-invalid').length>0){
                return false;
            }
            $('#create-pid').val(top.userName);
            $('#create-name').val(top.trueName);
            $post(saveCommentAction,$('#comments-form').serializeObject(),function (res) {
                toast('评论保存成功！').ok();
                loadCommentsList($('#comment-id').val(),'#comments-temp');
            });
        });

        $('#statistical-reports-table').on('click','.icon-edit-btn',function () {//打开修改弹窗
            $open('#edit-report-block',{title:'统计报表修改',width:820,onClose:function () {
                closeWin('','#edit-form');
            }});
            $('#edit-id').val($(this).attr('mainId'));
            $('#edit-xmdwdm').resetDict().dict();
//            log('managerData:'+managerData);
            $('#edit-zdrq').val(new Date().format('yyyy-mm-dd'));
            //初始化修改弹窗数据
            initWinData.call(this,'#edit-xmdwdm','#edit-zdzxm','#edit-zdrq','#edit-bbmkdm','#edit-bbmkmc','#edit-bbjj');
        }).on('click','.copy-a',function () {//复制查询参考语句
            $(this).prev().prev().select();
            document.execCommand('copy');
        }).on('click','.icon-show-btn',function () {//打开查看弹窗
            $open('#check-report-block',{title:'统计报表维护查看',width:820});
            //显示查看弹窗数据
//            initWinData.call(this,'#check-ssmk-str','#check-page-str','#check-sql');
            initWinData.call(this,'#check-xmdwdm','#check-zdzxm','#check-zdrq','#check-bbmkdm','#check-bbmkmc','#check-bbjj');
            loadCommentsList($(this).attr('mainId'),'#check-report-block');
        }).on('click','.icon-remove-btn',function () {//删除
            var id = $(this).attr('id');
            var xmdwmc = $(this).attr('xmdwmc');

            $confirm('确定删除'+xmdwmc+'的统计报表吗？',function (del) {
                if(del){
                    $post(reportDeleteAction,{id:id},function (res) {
                        var msg = res.msg?res.msg:'删除成功！';
                        toast(msg,600).ok();
                        //加载模块语句列表数据
                        loadReportList($('.paging').data('currentPage'));
                    });
                }
            });
        }).on('click','.icon-comments-btn',function () {//打开评论弹窗
            $open('#comments-report-block',{title:'统计报表评论',width:820,onClose:function () {
                closeWin('','#comments-form');
            }});
            $('#comment-id').val($(this).attr('mainId'));
            initWinData.call(this,'','.comments-author','','','.comments-title','.comments-desc',true);
            loadCommentsList($(this).attr('mainId'),'#comments-temp');
        }).on('click','.icon-like-after-btn',function () {//点赞
            var statementId = $(this).attr('statementId'),
                that= $(this);
            if(that.hasClass('icon-like-before-btn1')){
                toast('已经赞过了！');
                return false;
            }
            $post(hitAction,{statementId:statementId},function (res) {
                toast('点赞成功！').ok();
                //加载统计报表维护列表数据
                loadReportList($('.paging').data('currentPage'));
            });
        });
        if(addLimit){
            $('#add-report').removeClass('hideplus');
        }
        $('.query-date').datepicker();
        $('#xmdwdm').dict();
    });

</script>
</html>
