<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">	
	<title>模块语句管理</title>
	<link rel="stylesheet" href="../../dist/css/base.css"/>
	<link rel="stylesheet" href="../../dist/css/info-mng.css"/>
</head>
<body>
	<div class="query-condition mt10 tac">
		<form id="mkyj-form">
			<div class="query-condition-p">
					<span class="common-field w65">所属模块：</span>
					<select name="mkdm" id="ssmk" class="common-select mr15"></select>
					<span class="common-field w65">对应页面：</span>
					<select name="ymdm" id="match-page" class="common-select mr15"></select>
				<p class="query-reset">
					<b class="cm-query-btn mr15" id="query-btn"></b>
					<b class="cm-reset-btn" id="reset-btn"></b>
				</p>
			</div>
		</form>
	</div>
	<div id="query-result">
		<div class="new-color-bar">
			<span class="title">页面查询语句列表（共找到<span class="total-count"></span>条数据）</span>
			<div class="bar-btn-div">
				<b class="cm-add-btn"></b>
			</div>
		</div>
		<table id="module-sql-table" class="typical-tb">
			<thead>
			<th>序号</th>
			<th>所属模块</th>
			<th>对应页面</th>
			<th>查询参考语句</th>
			<th>备注</th>
			<th>操作</th>
			</thead>
			<tbody tpsource="#module-sql-list"></tbody>
		</table>
		<textarea id="copy-container"></textarea>
		<div class="paging"></div>
	</div>
	<!--新增弹窗-->
	<div id="add-sql-block" class="hide">
		<form id="add-form">
			<p class="mt30">
				<span class="common-field w65"><span class="orangered">★ </span>所属模块：</span>
				<select name="mkdm" id="add-ssmk" class="common-select validate mr15" data-options="required:true"></select>
				<span class="common-field w65"><span class="orangered">★ </span>对应页面：</span>
				<select name="ymdm" id="add-match-page" class="common-select mr15 validate" data-options="required:true">
					<option value=""></option>
				</select>
			</p>
			<p>
				<span class="common-field fl"><span class="orangered">★ </span>查询参考语句：</span>
				<textarea name="referSql" class="common-textarea sql-text validate" data-options="required:true"></textarea>
			</p>
			<p>
				<span class="common-field fl">备注：</span>
				<textarea name="bzl" class="common-textarea validate" data-options="validType:'extLength[0,4000]'"></textarea>
			</p>
			<p class="mt20 tcenter">
				<b id="add-save-btn" class="cm-save-btn mr15"></b>
				<b id="add-close-btn" class="cm-cancel-btn"></b>
			</p>
		</form>
	</div>
	<!--修改弹窗-->
	<div id="edit-sql-block" class="hide">
		<form id="edit-form">
			<input id="edit-id" name="mainId" type="hidden"/>
			<p class="mt30">
				<span class="common-field w65">所属模块：</span>
				<input id="edit-ssmk" name="mkdm" type="hidden">
				<input id="edit-ssmk-str" type="text" class="common-input readonly-input mr15" readonly/>
				<span class="common-field w65">对应页面：</span>
				<input id="edit-match-page" name="ymdm" type="hidden">
				<input id="edit-page-str" type="text" class="common-input readonly-input" readonly/>
			</p>
			<p>
				<span class="common-field fl"><span class="orangered">★ </span>查询参考语句：</span>
				<textarea id="edit-sql" name="referSql" class="common-textarea sql-text validate" data-options="required:true"></textarea>
			</p>
			<p>
				<span class="common-field fl">备注：</span>
				<textarea id="edit-remark" name="bzl" class="common-textarea validate" data-options="validType:'extLength[0,4000]'"></textarea>
			</p>
			<p class="mt20 tcenter">
				<b id="edit-save-btn" class="cm-save-btn mr15"></b>
				<b id="edit-close-btn" class="cm-cancel-btn"></b>
			</p>
		</form>
	</div>
	<!--查看弹窗-->
	<div id="check-sql-block" class="hide">
		<p>
			<span class="common-field w65">所属模块：</span>
			<input id="check-ssmk-str" type="text" class="common-input mr15" readonly/>
			<span class="common-field w65">对应页面：</span>
			<input id="check-page-str" type="text" class="common-input " readonly/>
		</p>
		<p>
			<span class="common-field fl">查询参考语句：</span>
			<textarea id="check-sql" class="common-textarea sql-text" data-options="required:true" readonly></textarea>
		</p>
		<p>
			<span class="common-field fl">备注：</span>
			<textarea id="check-remark" name="bzl" class="common-textarea" readonly></textarea>
		</p>
		<p class="mt20 tcenter">
			<b id="check-copy-btn" class="cm-save-btn mr15"></b>
			<b id="check-close-btn" class="cm-cancel-btn"></b>
		</p>
	</div>
</body>
<script type="text/template" id="module-sql-list">
	<tr class="{$nth2}">
		<td>{rownum}</td>
		<td class="mol-name">{mkmc}</td>
		<td class="page-name">{ymmc}</td>
		<!--<td><p class="brief-content">{used}</p><a class="more-a" href="javascript:void(0);" onclick="toggleMore(this,'{id}u');">更多</a></td>-->
		<td class="sql-content">
			<p class="brief-content">{referSql}</p>
			<a class="more-a" href="javascript:void(0);" moreId="{id}c">更多</a><!--toggleMoreContent(this,'{id}c');-->
			<a id="copy{rownum}" class="copy-a" href="javascript:void(0);" copyId="{id}">复制</a>
		</td>
		<td class="remark">
			<p class="brief-content" readonly>{bzl}</p>
			<a class="more-a" href="javascript:void(0);" moreId="{id}u">更多</a>
		</td>
		<td>
			<i class="icon-show-btn" title="查看" editid="{id}"></i>
			<i class="icon-edit-btn" title="修改" mkdm="{mkdm}" ymdm="{ymdm}" editid="{id}"></i>
			<i class="icon-remove-btn" title="删除" sqlId = "{id}"></i>
		</td>
	</tr>
</script>
<script src="../../dist/js/base.js"></script>
<script src="../../dist/js/info-mng.js"></script>
<script>
	// 在doc准备好后,写js逻辑
	importing(function () {
		var dictXtmkdmAction = top.path+'/api/dict/single/xtmkdm/json',
			dictPagedmAction = top.path+'/api/dict/pagedm/query/json',
			moduleListAction = top.path+'/api/0/basic/module/list',
			saveAddAction = top.path+'/api/0/basic/module/add',
			saveEditAction = top.path+'/api/0/basic/module/edit',
			sqlDeleteAction = top.path+'/api/0/basic/module/delete',
			pageData = [];

		var closeWin = function(winId,resetForm) {
			if(winId){
				$(winId).$close();
			}
			if(resetForm) {
				$(resetForm)[0].reset();
			}
			$('.validate').removeClass('validatebox-invalid');
		}
		function loadMkyjList(currentPage) {
			$('#query-result').pagingList({
				action:moduleListAction,
				currentPage:currentPage,
				jsonObj:$('#mkyj-form').serializeObject(),
				callback:pageBack
			});
		}
		function pageBack(data) {
			pageData = data;
			$('#module-sql-table').find('tbody').template(data,function (item) {
				var bzl = item.bzl;
				item.bzl = bzl?bzl.replace(/\n/gm,'<br>'):'';
			},true);
			//内容在4行内的不显示“更多”
			isShowMore();
			//修改
			$('.icon-edit-btn').on('click',function () {
				$open('#edit-sql-block',{title:'模块语句修改',width:820,onClose:function () {
					closeWin('','#edit-form');
				}});
				//初始化修改弹窗数据
				initWinData.call(this,'#edit-ssmk-str','#edit-page-str','#edit-sql','#edit-remark');
			});
			//复制查询参考语句
			$('.copy-a').on('click',function () {
				var referSqlArr = pageData.where('o=>o.id=="'+$(this).attr('copyId')+'"').select('o=>o.referSql');
				$('#copy-container').val(referSqlArr[0].replace(/<br>|<br\/>/gm,'')).select();
				document.execCommand('copy');
				toast('复制成功！');
			});
			//查看
			$('.icon-show-btn').on('click',function () {
				$open('#check-sql-block',{title:'模块语句查看',width:820});
				//显示查看弹窗数据
				initWinData.call(this,'#check-ssmk-str','#check-page-str','#check-sql','#check-remark');
			});
			//删除
			$('.icon-remove-btn').on('click',function () {
				var id = $(this).attr('sqlId');
				$confirm('确认要删除这条语句吗？',function (del) {
					if(del){
						$post(sqlDeleteAction,{id:id},function (res) {
							var msg = res.msg?res.msg:'删除成功！';
							toast(msg,600).ok();
							//加载模块语句列表数据
							loadMkyjList($('.paging').data('currentPage'));
						});
					}
				});

			});
		}
		function init() {
			//加载模块语句列表数据
			loadMkyjList();
			//生成所属模块下拉列表
			$get(dictXtmkdmAction,{},function (res) {
				createOption(res.data,'#ssmk');
			});
		}
		function createOption(data,selector) {
			var opt = '<option value="{key}">{value}</option>',
				i = 0,
				dataI = {},
				optVal = '',
				selectObj = $(selector);
			selectObj.html('');
			selectObj.append('<option value=""></option>');
			for(;i<data.length;i++){
				dataI = data[i];
				optVal = opt.replace('{key}',dataI.key).replace('{value}',dataI.value);
				selectObj.append(optVal);
			}
		}
		function saveSql(action,params,winId,formId) {
			//验证
			$(winId+' .validate').validatebox();
			if($('.validatebox-invalid').length>0){
				return false;
			}
			//保存
			$post(action,params,function (res) {
				var msg = res.msg?res.msg:'保存成功！';
				closeWin(winId,formId);
				toast(msg,600).ok();
				//加载模块语句列表数据
				loadMkyjList($('.paging').data('currentPage'));
			},true);

		}
		function initWinData(ssmkId,matchPageId,sqlId,remarkId) {
			var that = $(this),
					pTd = that.parent(),
					editId = that.attr('editid'),
					thatArr = pageData.where('o=>o.id=="'+editId+'"'),
					sqlArr = thatArr.select('o=>o.referSql'),
					remarkArr = thatArr.select('o=>o.bzl');
			$('#edit-ssmk').val(that.attr('mkdm'));
			$('#edit-match-page').val(that.attr('ymdm'));
			$('#edit-id').val(editId);
			$(ssmkId).val(pTd.siblings('.mol-name').html());
			$(matchPageId).val(pTd.siblings('.page-name').html());
			$(sqlId).val(sqlArr[0].replace(/<br>|<br\/>/gm,''));
			$(remarkId).val(remarkArr[0].replace(/<br>|<br\/>/gm,''));
		}
		function createMatchPageOption(ssmkId,queryString) {
			var	matchPage = (ssmkId === 'ssmk' ? '#match-page' : '#add-match-page');
			if(queryString){
				//生成对应页面下拉列表 queryString:所属模块的key
				$get(dictPagedmAction,{queryType:'1',queryString:queryString},function (res) {
					createOption(res.data,matchPage);
				},false,false);
			}else{
				$(matchPage).html('');
			}
		}

		init();

		//所属模块与对应页面联动
		$('#ssmk,#add-ssmk').on('change',function () {
			createMatchPageOption(this.id,$(this).val());
		});
		//查询
		$('#query-btn').on('click',function () {
			loadMkyjList();
		});
		//重置
		$('#reset-btn').on('click',function () {
			$('#mkyj-form')[0].reset();
			$('#match-page').html('');
		});
		//新增
		$('.cm-add-btn').on('click',function () {
			$open('#add-sql-block',{title:'模块语句新增',width:820,onClose:function () {
				closeWin('','#add-form');
			}});
			//生成所属模块下拉列表
			$get(dictXtmkdmAction,{},function (res) {
				createOption(res.data,'#add-ssmk');
			});
		});
		//关闭新增弹窗
		$('#add-close-btn').on('click',function () {
			closeWin('#add-sql-block','#add-form');
			$('#add-match-page').html('');
		});
		//保存新增内容
		$('#add-save-btn').on('click',function () {
			saveSql(saveAddAction,$('#add-form').serializeObject(),'#add-sql-block','#add-form');
		});

		//关闭修改弹窗
		$('#edit-close-btn').on('click',function () {
			closeWin('#edit-sql-block','#edit-form');
		});
		//保存修改内容
		$('#edit-save-btn').on('click',function () {
			saveSql(saveEditAction,$('#edit-form').serializeObject(),'#edit-sql-block','#edit-form');
		});
		//关闭查看弹窗
		$('#check-close-btn').on('click',function () {
			$('#check-sql-block').$close();
		});
		//查看弹窗复制
		$('#check-copy-btn').on('click',function () {
			$('#check-sql').select();
			document.execCommand('copy');
		});
	});

</script>
</html>
