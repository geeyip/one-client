<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>系统使用情况统计</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/ptcg.css">
</head>
<body id="sys-use-body">
<div class="query-condition">
    <div class="query-condition-p">
        <span class="common-field w65">统计月份：</span><dict id="dict-query-tjyf" dict-id="query-tjyf" dict-name="tjyf" dict-type="select" dict-root="custom" return-value="true" class="dict" empty="false"></dict>
        <span class="common-field w100">项目单位：</span><dict id="dict-query-xmdwdm" dict-id="query-xmdwdm" dict-name="xmdwdm" dict-type="tree" dict-root="custom" return-value="false" class="dict"></dict>
        <span class="common-field w100">项目经理：</span><dict id="dict-query-xmjl" dict-id="query-xmjl" dict-name="xmjl" dict-type="select" dict-root="custom" return-value="false" class="dict"></dict>
        <p class="query-reset">
            <b id="sys-use-stat-btn" class="cm-query-btn"></b>
            <b id="sys-use-export-btn" class="cm-save-btn"></b>
        </p>
    </div>
</div>
<!--<div id="sys-use-div" class="sticky-wrap">
    <div id="sys-use-export-div">
        <table class="typical-tb sys-use-table">
            <thead tpsource="#sys-use-title"></thead>
            <tbody tpsource="#sys-use-content"></tbody>
        </table>
    </div>
    <table class="typical-tb sticky-thead">
        <thead tpsource="#sys-use-title"></thead>
        <tbody class="hidden" tpsource="#sys-use-content"></tbody>
    </table>
    <table class="typical-tb sticky-col">
        <thead tpsource="#sys-use-col-title"></thead>
        <tbody tpsource="#sys-use-col-content"></tbody>
    </table>
    <table class="typical-tb sticky-intersect">
        <thead tpsource="#sys-use-intersect-title"></thead>
    </table>
</div>-->
<div id="sys-use-div" class="sticky-wrap">
    <div id="sys-use-export-div">
        <table class="typical-tb sys-use-table redefind-typical-tb">
            <thead tpsource="#sys-use-title"></thead>
            <tbody tpsource="#sys-use-content"></tbody>
        </table>
    </div>
    <table class="typical-tb sticky-col redefind-typical-tb">
        <thead>
        <tr>
            <th rowspan="3" style="min-width: 40px;max-width: 40px;height:90px;">序号</th>
            <th rowspan="3" style="min-width: 100px;max-width: 100px;height:90px;">项目单位</th>
        </tr>
        </thead>
        <tbody tpsource="#sys-use-col"></tbody>
    </table>
    <table class="typical-tb sticky-intersect redefind-typical-tb">
        <thead>
        <tr>
            <th rowspan="3" style="min-width: 40px;max-width: 40px;height:90px;">序号</th>
            <th rowspan="3" style="min-width: 100px;max-width: 100px;height:90px;">项目单位</th>
        </tr>
        </thead>
    </table>
    <table class="typical-tb sticky-thead redefind-typical-tb">
        <thead tpsource="#sys-use-title"></thead>
    </table>
</div>
</body>
<script type="text/template" id="sys-use-title">
    <tr>
        <th rowspan="3" style="min-width: 40px;max-width: 40px">序号</th>
        <th rowspan="3" style="min-width: 100px;max-width: 100px">项目单位</th>
        <th colspan="2">考核结果</th>
        {{dl:#<th colspan="{colspan}" {minWidth}>{name}</th>#}}
    </tr>
    <tr>
        <th colspan="2">总分</th>
        {{mk:#<th colspan="{colspan}" {minWidth}>{name}</th>#}}
    </tr>
    <tr>
        <th style="min-width: 64px;max-width: 64px">本次总分</th>
        <th style="min-width: 64px;max-width: 64px">上次总分</th>
        {{items:#<th {minWidth}>{itemc}</th>#}}
    </tr>
</script>
<script type="text/template" id="sys-use-content">
    <tr>
        <td style="min-width: 40px;max-width: 40px">{rownum}</td>
        <td style="min-width: 100px;max-width: 100px">{xmdwmc}</td>
        <td>{scoreCount}</td>
        <td>{beforeScoreCount}</td>
        {{items:#<td>{itemValue}</td>#}}
    </tr>
</script>
<script type="text/template" id="sys-use-col">
    <tr>
        <td style="min-width: 40px;max-width: 40px">{rownum}</td>
        <td style="min-width: 100px;max-width: 100px">{xmdwmc}</td>
    </tr>
</script>
<script src="../js/base.js"></script>
<script>
    importing('dict',function(){

        var queryTableHeadAction = top.path + '/api/0/ptcg/xtqk/tableHead',
            queryTableBodyAction = top.path + '/api/0/ptcg/xtqk/tableBody',
            xmdwAction = top.path + '/api/0/basic/project/project_unit',
            xmjlAction = top.path + '/api/0/basic/project/user_info',
            tjyfAction = top.path + '/api/0/ptcg/xtqk/month_info',
            queryExcelAction = top.path + '/api/0/ptcg/xtqk/excel',
            exportExcelAction = top.path + '/api/0/ptcg/xtqk/export';
        var contentData;//表格数据
        var tryCount=0;
        var tryQuery=function() {
            setTimeout(function () {
                if ($('#query-tjyf').children().length > 0) {
                    initForTitle();
                } else {
                    if(tryCount>15){
                        return false;
                    }
                    tryQuery();
                    tryCount++;
                }
            }, 80);
        };
//        $('.dict').dict();

        //统计月份
        function queryForTjyf(){
            $get(tjyfAction,{},function(res){
                $('#dict-query-tjyf').dict(res.data.unitInfo);
            });
        }
        //项目单位
        function queryForXmdw(){
            $get(xmdwAction,{},function(res){
                //console.log(res.data.unitInfo);
                $('#dict-query-xmdwdm').dict(res.data.unitInfo);
            });
        }
        //项目经理
        function queryForXmjl(){
            $get(xmjlAction,{type:'1'},function(res){
                $('#dict-query-xmjl').dict(res.data);
            })
        }

        //初始化表头
        function initForTitle(){
            $get(queryTableHeadAction,{},function(res){
                var titleData = res.data;
                //arrDl：存放大类  arrMk：存放模块信息  arrItem：存放统计项信息  arrMkTemp：存放所有模块
                var arrDl = [] , arrMk = [], arrItemTemp = [], arrMkTemp = [], arrItem = [];
                var minWidthPx;
                titleData.forEach(function(obj,i){
                    arrDl[i] = {colspan:0, name:'', minWidth:''};
                    arrDl[i].name = obj.dlmc;
                    obj.mk.forEach(function(e){
                        arrDl[i].colspan += e.items.length;
                    });
                    minWidthPx = obj.dlmc.length * 15;
                    arrDl[i].minWidth = 'style="min-width: '+minWidthPx+'px"';
                    //将所有模块数组存入arrMkTemp
                    arrMkTemp = arrMkTemp.concat(obj.mk);
                });
                arrMkTemp.forEach(function(obj,i){
                    arrMk[i] = {colspan:0, name:'', minWidth:''};
                    arrMk[i].name = obj.mkmc;
                    arrMk[i].colspan = obj.items.length;
                    minWidthPx = obj.mkmc.length * 15;
                    arrMk[i].minWidth = 'style="min-width: '+minWidthPx+'px"';
                    //将所有模块中的统计项传入arrItem
                    arrItemTemp = arrItemTemp.concat(obj.items);
                });
                arrItemTemp.forEach(function(obj,i){
                    arrItem[i] = {iteme:'',itemc:'',minWidth:''};
                    arrItem[i].iteme = obj.iteme;
                    arrItem[i].itemc = obj.itemc;
                    minWidthPx = obj.itemc.length * 15;
                    arrItem[i].minWidth = 'style="min-width: '+minWidthPx+'px"';
                });
                var warpData = {dl:arrDl,mk:arrMk,items:arrItem};
                $template('.sys-use-table thead',warpData);
                $template('.sticky-thead thead',warpData);
                queryForSysUse();
            });
        }

        //统计 查询数据
        function queryForSysUse(){
            $post(queryTableBodyAction,{tjsj:$('#query-tjyf').val(),xmdwdm:$('#query-xmdwdm').val(),xmjl:$('#query-xmjl').val()},function(res){
                contentData = res.data;
                $template('.sys-use-table tbody',contentData,function(item,i){
                    item.beforeScoreCount = parseFloat(item.beforeScoreCount).toFixed(2);
                    item.scoreCount = parseFloat(item.scoreCount).toFixed(2);
                    item.items.forEach(function(obj, i){
                        obj.itemValue = parseFloat(obj.itemValue).toFixed(2);
                    });
                });
                $template('.sticky-col tbody',contentData);
            },true);
        }

        //导出Excel
        function exportForSysUse(){
                location.href=action2link(exportExcelAction);
        }

        //固定表头
        function fixedThead(){
            var $div = $('#sys-use-div'), $thead = $('.sticky-thead'), $col = $('.sticky-col'), $intersect = $('.sticky-intersect'), $tr = $('.sticky-intersect thead tr'), $w = $(window);
            var offsetTop = $div.offset().top;
            /*$w.scroll(function(){
                if($w.scrollTop() > 55){
                    $thead.add($intersect).css({
                        opacity: 1,
                        top: $w.scrollTop()-offsetTop
                    });

                }else{
                    $thead.css({opacity: 0}).add($intersect).css({ top: 0});
                }

                if($w.scrollLeft() > 0){
                    $col.add($intersect).css({
                        opacity: 1,
                        left: $w.scrollLeft()-10
                    });
                }else{
                    $col.css({opacity: 0}).add($intersect).css({ left: 0});
                    $tr.css({
                        'border-right': '1px solid #ccc'
                    });
                }

            });*/
            $div.height(height-60);
            $div.scroll(function(){
                if($div.scrollTop() > 0){
                    $thead.add($intersect).css({
                        opacity: 1,
                        top: $div.scrollTop()
                    });

                }else{
                    $thead.css({opacity: 0}).add($intersect).css({ top: 0});
                }

                if($div.scrollLeft() > 0){
                    $col.add($intersect).css({
                        opacity: 1,
                        left: $div.scrollLeft()
                    });
                }else{
                    $col.css({opacity: 0}).add($intersect).css({ left: 0});
                    $tr.css({
                        'border-right': '1px solid #ccc'
                    });
                }

            });
        }

        //执行字典的自定义数据
        queryForXmdw();
        queryForXmjl();
        queryForTjyf();

        //初始化表头
        //initForTitle();
        //默认进入查询
        tryQuery();

        fixedThead();

        $('#sys-use-stat-btn').on('click',tryQuery);
        $('#sys-use-export-btn').on('click',function(){
            exportForSysUse();
        });
    });
</script>
</html>