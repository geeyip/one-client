
<div id="handel-fkxx-block">
    <p class="mt10">
        <span class="common-field fl"><span class="orangered"> </span>反馈内容：</span>
        <textarea id="fknr-cl-edit" name="fknr" rows="5" unselectable="on" readonly="true" ></textarea>
    </p>
    <form id="handel-fkxx-from">
        <div>
            <span class="common-field fl"><span class="orangered"> </span>图片信息：</span>
            <table id="handel-rights-table" class="fkxx-tabe" cellpadding="3">
                <thead>
                <tr id="tr-1-edit" class="hide">
                    <td> <img id="pic-0-edit" class="picshow hide"> </td>
                    <td> <img id="pic-1-edit" class="picshow hide">  </td>
                    <td> <img id="pic-2-edit" class="picshow hide"> </td>
                </tr>
                <tr id="tr-2-edit" class="hide">
                    <td> <img id="pic-3-edit" class="picshow hide"> </td>
                    <td> <img id="pic-4-edit" class="picshow hide"> </td>
                    <td> <img id="pic-5-edit" class="picshow hide"> </td>
                </tr>
                <tr id="tr-3-edit" class="hide">
                    <td class="h20"> 无</td>
                </tr>
                </thead>
            </table>
        </div>
        <div class="mt10">
            <span class="common-field fl"><span class="orangered">★ </span>问题类别：</span>
            <dict dict-type="select" dict-root="wtlxdm" dict-id="wtlxdmdict-cl" id="wtlxdm-cl-edit" dict-name="wtlxdm" empty="false" ></dict>
        </div>
        <p class="mt10">
            <span class="common-field fl"><span class="orangered">★ </span>处理反馈：</span>
            <textarea id="clfk-cl-edit" name="clfknr" rows="5" class="validate" data-options="required:true,validType:'extLength[0,4000]'" ></textarea>
        </p>
        <input id="fkxxId-cl-edit" name="id" class="hide" unselectable="on" readonly="true" type="text" />
        <input id="yctsearch-cl-edit" name="yctSearch" class="hide" unselectable="on" readonly="true" type="text" />
    </form>
    <p class="tcenter mg10">
        <b id="save-fkxx-submit-edit" class="cm-save-btn mr15"></b>
        <b id="save-fkxx-cancel-edit" class="cm-cancel-btn"></b>
    </p>
</div>
<script>
    $style(top.path+'/dist/css/multiWin.css');
    var searchPicDateAction = top.path + '/api/0/feedback/userfeed/pic',
            initPageDateAction = top.path + '/api/0/feedback/userfeed/list',
            saveFeedBackAction = top.path + '/api/1/feedback/userfeed/save';
    var thisWin;
    var formMsg; //是否从右下角消息处理方法进入反馈处理页面，判断是否执行更新右下角消息内容
    var feedbackEditLimit=top.ops['feedback-mng-handl'];

    //进入修改页面
    function intoEditFeedBack(id,editWin,type,currentPage,msg) {
        if(typeof  msg != 'undefined'){  //表示从右下角消息的处理方法进入处理页面 赋值formMsg
            formMsg = msg;
        }
        thisWin = editWin;
        $('#wtlxdm-cl-edit').dict();
        $('#clfk-cl-edit').val('');
        $('#wtlxdmdict-cl').val(1);
        $get(searchPicDateAction, {id: id}, function (res) {
            $('#fknr-cl-edit').val(res.data.yhfkxx.fknr);
            $('#fkxxId-cl-edit').val(id);
            $('#yctsearch-cl-edit').val(res.data.yhfkxx.yctSearch);
            for (var i = 0; i < res.data.pictureList.length; i++) { //拼接图片展示
                $('#pic-' + i + '-edit').removeClass("hide").attr("src", "data:image/jpg;base64," + res.data.pictureList[i].baseMin64Str);
            }
            if (res.data.pictureList.length != 0) {
                $('#tr-1-edit').removeClass("hide");
                if (res.data.pictureList.length > 3) {
                    $('#tr-2-edit').removeClass("hide");
                }
            } else {
                $('#tr-3-edit').removeClass("hide");
            }
        });
        $('#save-fkxx-cancel-edit').on('click',function(){
            if("fkxx"==type){
                queryPageData(true,currentPage);
            }else if("workbench"==type){
                getUserFeedbackList();
            }
            editWin.$close();
        });
        $('#save-fkxx-submit-edit').on('click',function(){
            saveFeedBack(type,currentPage);
        });
    }

    //保存事件
    function saveFeedBack(type,currentPage) {
        trimAllFeedBack('#handel-fkxx-block');
        $('.validate').validatebox();
        if ($('.validatebox-invalid').length > 0) {
            return false;
        }
        $post(saveFeedBackAction, $("#handel-fkxx-from").serializeObject(), function (res) {
            toast('保存成功！').ok();
            if("fkxx"==type){
                queryPageData(true,currentPage);
            }else if("workbench"==type){
                getUserFeedbackList();
            }
            if(typeof formMsg == 'undefined'){  //表示不是从右下角消息的处理按钮进入 反馈处理页面 需要执行更新右下角消息内容的方法
                $script(top.path+'/dist/js/message.js', function(){
                    var msgContentObj = top.document.getElementsByClassName('messager-body');
                    //消息内容更新
                    upModuleMsgContent(msgContentObj);
                });
            }
            thisWin.$close();
        }, true);
    }

    //参数去空格
    function trimAllFeedBack(selector) {
        $(selector+' input,'+selector+' textarea').each(function (i,el) {
            var value = $(el).val();
            $(el).val(value.trim());
        });
    }

    $('.picshow').previewBox();
</script>
