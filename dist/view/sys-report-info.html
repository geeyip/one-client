<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>报表信息维护</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/sys.css?version=0.99">
</head>
<body>

<div id="report-info-query" class="query-condition">
    <div class="query-condition-p">
        <span class="common-field w42">大类：</span><dict id="dict-query-dl" dict-id="query-dl" dict-name="queryDl" dict-type="select" dict-root="KHDLDM" class="dict"></dict>
        <span class="common-field w100">考核模块：</span><dict id="dict-query-mk" dict-id="query-mk" dict-name="queryMk" dict-type="select" dict-root="custom" return-value="false" class="dict"></dict>
        <p class="query-reset">
            <b class="cm-query-btn"></b>
            <b class="cm-reset-btn"></b>
        </p>
    </div>
</div>
<div id="report-info-query-result">
    <div class="new-color-bar">
        <span class="title">报表信息维护列表（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div">
            <b id="into-report-info-add" class="cm-add-btn hidePlus"></b>
        </div>
    </div>
    <table id="report-info-table" class="typical-tb" cellpadding="3">
        <thead>
            <th width="5%">序号</th>
            <th width="20%">大类</th>
            <th width="20%">考核模块</th>
            <th width="45%">统计项</th>
            <th width="10%">操作</th>
        </thead>
        <tbody tpsource="#report-info-list"></tbody>
    </table>
    <div class="paging"></div>
</div>
<div id="report-info-add-div" class="hide">
    <div id="report-info-add-value">
        <div class="report-info-add-title stick-title-bar">所属模块</div>
        <div>
            <span class="item-span"><span class="orangered">★ </span>大类：</span>
            <dict id="dict-report-info-add-dl" dict-id="report-info-add-dl" dict-name="addDl" dict-type="select" dict-root="KHDLDM" class="add-valid dict" data-options="required:true"></dict>
            <span class="item-span"><span class="orangered">★ </span>考核模块：</span>
            <dict id="dict-report-info-add-mk" dict-id="report-info-add-mk" dict-name="addMk" dict-type="select" dict-root="KHMKDM" class="add-valid dict" data-options="required:true"></dict>
        </div>
        <div class="report-info-add-title stick-title-bar">新增统计项<span class="report-info-points">（统计项英文名和后台查询字段相关，‘SCORE_’开头的统计项英文名仅作为得分字段使用，请谨慎添加）</span></div>
        <div id="items-add-div">
            <p>
                <span class="item-span"><span class="orangered">★ </span>中文名：</span>
                <input class="add-valid common-input" data-options="required:true" type="text"/>
                <span class="item-span"><span class="orangered">★ </span>英文名：</span>
                <input class="add-valid common-input itemE" data-options="required:true,validType:'itemEnglish'" type="text"><i class="icon-plus items-plus"></i>
            </p>
        </div>
        <div class="report-info-add-title stick-title-bar">已有统计项</div>
        <div id="items-div" tpsource="#items"></div>
    </div>
    <p class="tcenter mt20 mb10">
        <b id="save-report-info" class="cm-save-btn mr15"></b>
        <b id="report-info-add-cancel" class="cm-cancel-btn"></b>
    </p>
</div>
<div id="report-info-edit-div" class="hide">
    <div class="report-info-add-title stick-title-bar">所属模块</div>
    <div>
        <span class="item-span"><span class="orangered">★ </span>大类：</span>
        <dict id="dict-report-info-edit-dl" dict-id="report-info-edit-dl" dict-name="editDl" dict-type="select" dict-root="KHDLDM" class="dict"></dict>
        <span class="item-span"><span class="orangered">★ </span>考核模块：</span>
        <dict id="dict-report-info-edit-mk" dict-id="report-info-edit-mk" dict-name="editMk" dict-type="select" dict-root="KHMKDM" class="dict"></dict>
    </div>
    <div class="report-info-add-title stick-title-bar">统计项<span class="report-info-points">（统计项英文名和后台查询字段相关，‘SCORE_’开头的统计项英文名仅作为得分字段使用，请谨慎修改）</span></div>
    <div id="items-edit-div">{{items:#items-edit}}</div>
    <p class="tcenter mt20">
        <b id="update-report-info" class="cm-save-btn mr15"></b>
        <b id="report-info-edit-cancel" class="cm-cancel-btn"></b>
    </p>
    <input class="edit-valid" type="hidden" id="oldMkdm"/>
    <input class="edit-valid" type="hidden" id="oldDldm"/>
</div>
</body>
<script type="text/template" id="report-info-list">
    <tr>
        <td>{rn}</td>
        <td>{dlmc}</td>
        <td>{mkmc}</td>
        <td>
            {{items:#<div><span class="tjx-itemc">{itemc}：</span><span class="tjx-iteme">{iteme}</span></div>#}}
        </td>
        <td>
            <a class="into-report-info-edit icon-edit-btn hidePlus{editLimit}" param="{id}" title="修改"></a>
            <a class="delete-report-info icon-remove-btn hidePlus{deleteLimit}"  param="{dlid}" param2="{mkdm}" paramName="{mkmc}" title="删除"></a><br>
        </td>
    </tr>
</script>
<script type="text/template" id="items">
    <p>
        <span class="item-span">中文名：</span>
        <input class="common-input" unselectable="on" readonly="true" type="text" value="{itemc}"/>
        <span class="item-span">英文名：</span>
        <input class="common-input itemE" unselectable="on" readonly="true" type="text" value="{iteme}"/>
    </p>
</script>
<script type="text/template" id="items-edit">
    <p>
        <span class="item-span"><span class="orangered">★ </span>中文名：</span>
        <input class="edit-valid common-input" data-options="required:true" type="text" value="{itemc}" param="{id}"/>
        <span class="item-span"><span class="orangered">★ </span>英文名：</span>
        <input class="edit-valid common-input itemE" data-options="required:true,validType:'itemEnglish'" type="text" value="{iteme}"/><i param="{id}" class="icon-remove items-remove"></i>
    </p>
</script>
<script src="../js/base.js?version=0.99"></script>
<script>
    importing('dict',function(){
        var queryDataAction = top.path+'/api/0/system/report/list',
            addQueryAction = top.path+'/api/0/system/report/query',
            addDataAction = top.path+'/api/0/system/report/add',
            deleteDataAction = top.path+'/api/0/system/report/del',
            initMkdmDictAction = top.path+'/api/0/system/report/mkdm_info',
            updateAction = top.path+'/api/0/system/report/edit';
        var queryMkObj = $('#dict-query-mk');
        var addMkObj = $('#dict-report-info-add-mk');
        var editId = '';//存放修改的id
        var editDeleteId = [];

        var addLimit = top.ops['sys-report-info-add'],
            editLimit = top.ops['sys-report-info-edit'],
            deleteLimit = top.ops['sys-report-info-delete'];

        //新增权限设置
        if(addLimit){$('#into-report-info-add').removeClass('hidePlus');}

        //初始化字典
        $('#dict-query-dl').dict();
        $('#dict-report-info-add-dl').dict();

        addMkObj.dict();

        //设定默认ajax开始和结束时的loading遮罩效果($post自带,paginglist没有自带)
        $.ajaxSetup({
            beforeSend:showLoading,
            complete:hideLoading
        });

        //设置统计项英文名填写规范
        $.extend($.fn.validatebox.defaults.rules, {
            itemEnglish: {
                validator: function(val) {
                    return /^[a-zA-Z][a-zA-Z0-9_]{0,40}$/.test(val);
                },
                message: '请以字母开头，只能包含字母、数字和下划线，长度小于40'
            }
        });

        //模块代码自定义字典
        function queryForMkdmDict(obj, init, value){
            //初始化(init:true)考核模块字典时，模块字典下拉列表无值
            if(init){
                obj.dict(null);
            }else{
                obj.resetDict();
                $get(initMkdmDictAction,{dldm:value},function(res){
                    obj.dict(res.data.unitInfo);
                },false,false);
            }
        }
        //查询列表
        function queryForReportInfo(currentPage){
            top.registry.sys.reportInfoData = [];//存放查询之后页面展示的数据
            $('#report-info-query-result').pagingList({
                action:queryDataAction,
                currentPage:currentPage,
                jsonObj:{
                    dldm:$('#query-dl').val(),
                    mkdm:$('#query-mk').val()
                },
                callback:function(data){
                    var queryData = [];
                    $template('#report-info-table tbody',data, function(item, i){
                        //权限设置
                        item.editLimit = editLimit;
                        item.deleteLimit = deleteLimit;

                        queryData[i] = {};
                        queryData[i].id = item.id;
                        queryData[i].dldm = item.dldm;
                        queryData[i].mkdm = item.mkdm;
                        queryData[i].items = item.items;
                    });
                    top.registry.sys.reportInfoData = queryData;
                }
            });
        }
        //进入新增页面
        function intoReportInfoAdd(){
            if($('.other-p')) {$('.other-p').remove();}
            if($('#items-div p')){$('#items-div p').remove();}
            $('#report-info-add-div input').val('');
            $('#report-info-add-div select').val('');

            //字典添加必填项
            $('#report-info-add-dl').addClass('add-valid').attr('data-options','required:true');
            $('#report-info-add-mk').addClass('add-valid').attr('data-options','required:true');

            $open('#report-info-add-div',{width:820,title:'新增'});
            /*queryForMkdmDict(addMkObj, true);*/
        }
        //进入修改页面
        function intoReportInfoEdit(id){
            top.registry.sys.reportInfoData.each(function(e, i){
                if(e.id == id){
                    $open('#report-info-edit-div',{width:820,title:'修改'});
                    $('#dict-report-info-edit-dl').dict().dictSelect(e.dldm);
                    $('#dict-report-info-edit-mk').dict().dictSelect(e.mkdm);
                    //字典添加必填项
                    $('#report-info-edit-dl').addClass('edit-valid').attr('data-options','required:true');
                    $('#report-info-edit-mk').addClass('edit-valid').attr('data-options','required:true');

                    $template('#items-edit-div',e);
                    $('#oldDldm').val($('#report-info-edit-dl').val());
                    $('#oldMkdm').val($('#report-info-edit-mk').val());
                    return false;
                }
            });
        }
        //新增onchange查询事件
        function queryForReportInfoByAdd(){
            if($('#report-info-add-dl').val().isEmpty() && $('#report-info-add-mk').val().isEmpty()){
                $template('#items-div',null);
            }else {
                $post(addQueryAction, {
                    dldm: $('#report-info-add-dl').val(),
                    mkdm: $('#report-info-add-mk').val()
                }, function (res) {
                    $template('#items-div', res.data);
                }, true);
            }
        }
        //新增保存
        function saveReportInfo(){
            //必填项判断
            $('.add-valid').validatebox();
            if($('.validatebox-invalid').length > 0){
                return false;
            }

            //验证通过后 处理需要传入后台的数据
            var dl = $('#report-info-add-dl').val();//新增的大类
            var mk = $('#report-info-add-mk').val();//新增的考核模块
            var p = $('#items-add-div p');
            var itemsArray = [];//存放新增的统计项
            var inputs;
            p.each(function(i,e){
                itemsArray[i] = {};
                inputs = e.getElementsByTagName('input');
                for(var j=0;j<inputs.length;j=j+2){
                    itemsArray[i].itemc = inputs[j].value;//存放统计项中文
                    itemsArray[i].iteme = inputs[j+1].value;//存放统计项英文
                }
            });
            //定义新增传入后台的数据对象
            var saveObj = {
                dldm:dl,
                mkdm:mk,
                items:itemsArray
            };

            //将数据传入后台，执行保存方法
            $post(addDataAction,saveObj,function(res){
                toast('保存成功！').ok();
                reportInfoCloseWin('report-info-add-div');
                queryForReportInfo();
            },true);
        }
        //修改保存
        function updateReportInfo(){
            //必填项判断
            $('.edit-valid').validatebox();
            if($('.validatebox-invalid').length > 0){
                return false;
            }

            //通过验证后 处理需要传入后台的数据
            var dl = $('#report-info-edit-dl').val();//修改的大类
            var mk = $('#report-info-edit-mk').val();//修改的考核模块
            var p = $('#items-edit-div p');
            var itemsArray = [];//存放统计项
            var inputs;
            p.each(function(i,e){
                itemsArray[i] = {};
                inputs = e.getElementsByTagName('input');
                for(var j=0;j<inputs.length;j=j+2){
                    itemsArray[i].id = inputs[j].getAttribute('param');
                    itemsArray[i].itemc = inputs[j].value;//存放统计项中文
                    itemsArray[i].iteme = inputs[j+1].value;//存放统计项英文
                }
            });
            //定义修改传入后台的数据对象
            var updateObj = {
                oldMkdm:$('#oldMkdm').val(),
                oldDldm:$('#oldDldm').val(),
                dldm:dl,
                mkdm:mk,
                items:itemsArray,
                editDeleteId:editDeleteId
            };

            if(itemsArray.length == 0){
                $confirm('统计项个数小于1，该操作会导致当前考核模块被删除，确定要进行保存吗？', function(bol){
                    if(bol){
                        //将数据传入后台，执行保存方法
                        $post(updateAction,updateObj,function(res){
                            toast('保存成功！').ok();
                            reportInfoCloseWin('report-info-edit-div');
                            queryForReportInfo($('.paging').data('currentPage'));
                        },true);
                        return false;
                    }
                });
            }else {
                //将数据传入后台，执行保存方法
                $post(updateAction, updateObj, function (res) {
                    toast('保存成功！').ok();
                    reportInfoCloseWin('report-info-edit-div');
                    queryForReportInfo($('.paging').data('currentPage'));
                }, true);
            }
        }
        //列表删除方法
        function deleteReportInfo(dlid, mkdm, mkmc){
            $confirm('确定删除【'+mkmc+'】考核模块吗？',function(bol){
                if(bol){
                    $post(deleteDataAction,{dlid:dlid,mkdm:mkdm},function(res){
                        toast('删除成功！').ok();
                        queryForReportInfo($('.paging').data('currentPage'));
                    });
                }
            });
        }
        //英文字段名判断重复
        function judegReportItemE(obj, type){
            $('.itemE').removeClass('current-itemE');
            obj.removeAttr('placeholder');
            obj.addClass('current-itemE');
            var inputsObj = type == 'add' ? $('#report-info-add-value .itemE:not(.current-itemE)') : $('#items-edit-div .itemE:not(.current-itemE)');
            inputsObj.each(function(){
                if(this.value.trim()!='' && this.value.toUpperCase() == obj.val().trim().toUpperCase()){
                    obj.val('');
                    obj.focus();
                    obj.attr('placeholder','统计项英文名已存在，请重新输入');
                    return false;
                }
            });
        }
        //关闭弹窗
        function reportInfoCloseWin(id){
            $('#'+id).$close();
            $('.add-valid').removeClass('validatebox-invalid');
            $('.edit-valid').removeClass('validatebox-invalid');
        }

        //初始化 考核模块字典
        queryForMkdmDict(queryMkObj, true);
        //初始化 执行查询列表方法
        queryForReportInfo();


        //注册列表页面的click事件
        $('#query-dl').on('change',function(){
            queryForMkdmDict(queryMkObj, false, $(this).val());//根据大类查询对应的模块字典信息
        });
        $('.cm-query-btn').on('click',function(){
            queryForReportInfo();//查询记录日志
        });
        $('.cm-reset-btn').on('click',function(){
            $('#query-dl').val('');
            $('#query-mk').val('');
            queryForMkdmDict(queryMkObj, true);//重置后，考核模块字典下拉列表显示全部的考核模块
        });
        $('#report-info-table').on('click','.into-report-info-edit',function(){
            intoReportInfoEdit(this.getAttribute('param'));
        }).on('click','.delete-report-info',function(){
            deleteReportInfo(this.getAttribute('param'),this.getAttribute('param2'),this.getAttribute('paramName'));
        });


        //注册新增页面的click事件
        $('#into-report-info-add').on('click',function(){
            intoReportInfoAdd();
        });
        $('.items-plus').on('click',function(){
            var addItemsHtml = '<p class="other-p">'+
                    '<span class="item-span"><span class="orangered">★ </span>中文名：</span> <input class="add-valid common-input" data-options="required:true" type="text"/> '+
                    '<span class="item-span"><span class="orangered">★ </span>英文名：</span> <input class="add-valid common-input itemE" data-options="required:true,validType:\'itemEnglish\'" type="text"/><i class="icon-remove items-remove"></i>'+
                    '</p>';
            $('#items-add-div').append(addItemsHtml);
        });
        $('#report-info-add-div').on('click','.items-remove',function(){
            $(this).parent().remove();
        }).on('blur','#items-add-div .itemE',function(){
            judegReportItemE($(this), 'add');
            /*$('.itemE').removeClass('current-itemE');
            $(this).removeAttr('placeholder');
            $(this).addClass('current-itemE');
            var obj = $(this);
            var inputsObj = $('#report-info-add-value .itemE:not(.current-itemE)');
            inputsObj.each(function(){
                if(this.value.trim()!='' && this.value.toUpperCase() == obj.val().toUpperCase()){
                    obj.val('');
                    obj.focus();
                    obj.attr('placeholder','统计项英文名已存在，请重新输入');
                    return false;
                }
            });*/
        });
        $('#save-report-info').on('click',function(){
            saveReportInfo();
        });
        $('#report-info-add-cancel').on('click',function(){
            reportInfoCloseWin('report-info-add-div');
        });


        //注册修改页面的click事件
        $('#report-info-edit-div').on('click','.items-remove',function(){
            editDeleteId.push(this.getAttribute('param'));
            $(this).parent().remove();
        }).on('blur','#items-edit-div .itemE',function(){
            judegReportItemE($(this), 'edit');
            /*$('.itemE').removeClass('current-itemE');
            $(this).removeAttr('placeholder');
            $(this).addClass('current-itemE');
            var obj = $(this);
            var inputsObj = $('#items-edit-div .itemE:not(.current-itemE)');
            inputsObj.each(function(){
                if(this.value.trim()!='' && this.value.toUpperCase() == obj.val().toUpperCase()){
                    obj.val('');
                    obj.focus();
                    obj.attr('placeholder','统计项英文名已存在，请重新输入');
                    return false;
                }
            });*/
        });
        $('#update-report-info').on('click',function(){
            updateReportInfo();
        });
        $('#report-info-edit-cancel').on('click',function(){
            reportInfoCloseWin('report-info-edit-div');
        });


        $('#report-info-add-dl').on('change',function(){
            queryForReportInfoByAdd();
        });
        $('#report-info-add-mk').on('change',function(){
            queryForReportInfoByAdd();
        });

    });
</script>
</html>