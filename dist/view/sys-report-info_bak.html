<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>报表信息维护</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/sys.css?version=0.99">
</head>
<body>

<div id="report-info-query" class="query-condition">
    <p class="query-condition-p">
        <span class="common-field w38">大类：</span><dict id="query-dl" dict-type="select" dict-root="KHDLDM" class="dict mr15"></dict>
        <span class="common-field">考核模块：</span><dict id="query-mk" dict-type="select" dict-root="KHMKDM" class="dict mr15"></dict>
    </p>
</div>
<div id="report-info-query-result">
    <div class="new-color-bar">
        <span class="title">报表信息维护列表（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div">
            <b id="into-report-info-add" class="cm-add-btn"></b>
        </div>
    </div>
    <table id="report-info-table" class="typical-tb" cellpadding="3">
        <thead>
        <th width="20%">大类</th>
        <th width="20%">考核模块</th>
        <th width="50%">统计项</th>
        <th width="10%">操作</th>
        </thead>
        <tbody tpsource="#report-info-list"></tbody>
    </table>
</div>
</body>
<script type="text/template" id="report-info-list">
    <tr>
        <td class="view-report">{dlmc}</td>
        <td class="view-report">{mkmc}</td>
        <td class="view-report">
            {{items:#items-list}}
        </td>

        <td class="edit-report hidePlus">
            <dict name="dlDict" dict-type="select" dict-root="KHDLDM" class="dl-dict dict"></dict>
        </td>
        <td class="edit-report hidePlus">
            <dict name="mkDict" dict-type="select" dict-root="KHMKDM" class="mk-dict dict"></dict>
        </td>
        <td class="edit-report hidePlus">
            <div>
                <input class="common-input w150 no-edit tcenter" value="统计项中文名"/>
                <input class="common-input w150 no-edit tcenter" value="统计项英文名"/><i class="icon-plus items items-plus"></i>
            </div>
            <form>
                <input type="hidden" name="editId"  value="{id}"/>
                <input type="hidden" name="dldm" />
                <input type="hidden" name="mkdm" />
                <input type="hidden" name="itemes" />
                {{items:#items-list}}
            </form>
        </td>

        <td>
            <a class="update-report-info icon-save-btn hidePlus" title="保存"></a>
            <a class="into-report-info-edit icon-edit-btn" param="{id}" title="修改"></a>
            <a class="delete-report-info icon-remove-btn" param="{dlid}" param2="{mkdm}" title="删除"></a><br>
        </td>
    </tr>
</script>
<script type="text/template" id="items-list">
    <div class="items-edit-div">
        <input class="w150 common-input no-edit itemC" value="{itemc}"/><span class="view-report">：</span>
        <input class="w150 common-input no-edit itemE" value="{iteme}"/><i class="edit-report hidePlus icon-remove items items-remove"></i>
    </div>
</script>


<script type="text/template" id="items">
    <p>
        <span>字段中文名：</span>
        <input class="common-input" unselectable="on" readonly="true" type="text" value="{itemc}"/>
        <span>字段英文名：</span>
        <input class="common-input" unselectable="on" readonly="true" type="text" value="{iteme}"/>
    </p>
</script>
<script type="text/template" id="items-edit">
    <p>
        <span>字段中文名：</span>
        <input class="common-input" type="text" value="{itemc}"/>
        <span>字段英文名：</span>
        <input class="common-input" type="text" value="{iteme}"/>
    </p>
</script>

<script src="../js/base.js?version=0.99"></script>
<script>
    importing('dict',function(){

        var initDataAction = top.path+'/api/0/system/report/list',
                queryDataAction = top.path+'/api/1/system/report/list',
                addDataAction = top.path+'/api/0/system/report/add',
                deleteDataAction = top.path+'/api/0/system/report/del';


        var searchAction = '', updateAction = '', saveAction = '', deleteAction = '';
        $('.dict').dict();

        //查询列表
        function queryForReportInfo(type){
            $post(type?queryDataAction:initDataAction,{dldm: $('#query-dl').val(),mkdm: $('#query-mk').val()},function(res){
                $template('#report-info-table tbody',res.data);
                $('#report-info-query-result .total-count').html(res.totalCount);
            },true);
        }
        //修改保存
        function updateReportInfo(obj){
            $post(updateAction,obj.serializeObject(),function(res){
                toast('保存成功！').ok();
                queryForReportInfo(false);
            },true);
        }
        //新增保存
        function saveReportInfo(obj,addBtn){
            $post(addDataAction,obj.serializeObject(),function(res){
                addBtn.addClass('hidePlus');//保存成功后，保存按钮隐藏
                toast('保存成功！').ok();
                queryForReportInfo(false);
            },true);
        }
        //删除
        function deleteReportInfo(dlid,mkdm){
            $post(deleteDataAction,{dlid:dlid,mkdm:mkdm},function(res){
                toast('删除成功！').ok();
                queryForReportInfo(false);
            });
        }

        //进入页面查询,不需要记录日志，故传入false
        queryForReportInfo(false);

        $('#into-report-info-add').on('click',function(){ //注册新增点击事件
            //intoReportInfoAdd();
            var t_obj = $(this).parent().parent().next().children('tbody');
            t_obj.append('<tr><td><dict name="dlDict" dict-type="select" dict-root="KHDLDM" class="dict"></dict></td><td><dict name="mkDict" dict-type="select" dict-root="KHMKDM" class="dict"></dict></td><td><div><input class="common-input w150 no-edit tcenter" value="统计项中文名"/><input class="common-input w150 no-edit tcenter" value="统计项英文名"/><i class="icon-plus items items-plus"></i></div><form><input type="hidden" name="dldm"/><input type="hidden" name="mkdm"/><input type="hidden" name="itemes"/></form></td><td><a class="save-report-info icon-save-btn" title="保存"></a> <a class="remove-tr icon-remove-btn" title="删除"></a><br></td></tr>');
            t_obj.find('tr:last .dict').dict();
        });
        $('#report-info-table').on('click','.into-report-info-edit',function(){ //注册修改点击事件
            var t_obj = $(this).parent().parent();
            t_obj.find('.view-report').addClass('hidePlus');
            t_obj.find('.edit-report').removeClass('hidePlus');
            t_obj.find('.items-edit-div input').removeClass('no-edit');
            //修改保存按钮显示
            $(this).prev('.update-report-info').removeClass('hidePlus');
            //修改按钮隐藏
            $(this).addClass('hidePlus');
            //dict
            t_obj.find('.dl-dict').dictSelect('02');
            t_obj.find('.mk-dict').dictSelect('0102');
        }).on('click','.items-plus',function(){ //注册添加统计项点击事件
            $(this).parent().next('form').append('<div class="items-edit-div"><input type="text" class="w150 common-input itemc"/> <input type="text" class="w150 common-input iteme"/><i class="icon-remove items items-remove"></i></div>');
        }).on('click','.items-remove',function(){
            $(this).parent().remove();
        }).on('click','.remove-tr',function(){
            $(this).parent().parent().remove();
        }).on('click','.update-report-info',function(){ //注册修改保存点击事件
            //数据存储
            var t_tr = $(this).parent().parent();
            var t_divs = $(this).parent().parent().find('form .items-edit-div');
            var itemsArray = [];
            var inputs;
            t_divs.each(function(i,e){
                itemsArray[i] = {};
                inputs = e.getElementsByTagName('input');
                for(var j=0;j<inputs.length;j=j+2){
                    itemsArray[i].itemc = inputs[j].value;
                    itemsArray[i].iteme = inputs[j+1].value;
                }
            });
            $('form>input[name="dldm"]').val(t_tr.find('select[name="dlDict"]').val());
            $('form>input[name="mkdm"]').val(t_tr.find('select[name="mkDict"]').val());
            $('form>input[name="itemes"]').val(obj2str(itemsArray));


            //样式调整
            var t_obj = $(this).parent().parent();
            t_obj.find('.edit-report').addClass('hidePlus');
            t_obj.find('.view-report').removeClass('hidePlus');
            t_obj.find('.items-edit-div input').addClass('no-edit');
            //修改按钮显示
            $(this).next('.into-report-info-edit').removeClass('hidePlus');
            //保存按钮隐藏
            $(this).addClass('hidePlus');


            //执行修改保存方法
            updateReportInfo($(this).parent().parent().find('form'));
            console.log(obj2str($(this).parent().parent().find('form').serializeObject()));
        }).on('click','.save-report-info',function(){ //注册新增保存点击事件
            //数据存储
            var t_tr = $(this).parent().parent();
            var t_divs = $(this).parent().parent().find('form .items-edit-div');
            var itemsArray = [];
            var inputs;
            t_divs.each(function(i,e){
                itemsArray[i] = {};
                inputs = e.getElementsByTagName('input');
                for(var j=0;j<inputs.length;j=j+2){
                    itemsArray[i].itemc = inputs[j].value;
                    itemsArray[i].iteme = inputs[j+1].value;
                }
            });

            //新增时必填项判断
            if(t_tr.find('select[name="dlDict"]').val().isEmpty()){
                toast('请选择大类').err();
                return false;
            }
            if(t_tr.find('select[name="mkDict"]').val().isEmpty()){
                toast('请选择考核模块').err();
                return false;
            }
            if(itemsArray.length == 0){
                toast('请输入统计项').err();
                return false;
            }
            for(var k=0;k<itemsArray.length;k++){
                if(itemsArray[k].iteme.isEmpty() || itemsArray[k].itemc.isEmpty()){
                    toast('统计项请填写完整').err();
                    return false;
                }
            }

            $('form>input[name="dldm"]').val(t_tr.find('select[name="dlDict"]').val());
            $('form>input[name="mkdm"]').val(t_tr.find('select[name="mkDict"]').val());
            $('form>input[name="itemes"]').val(obj2str(itemsArray));

            //样式调整
            var t_obj = $(this).parent().parent();
            t_obj.find('.edit-report').addClass('hidePlus');
            t_obj.find('.view-report').removeClass('hidePlus');
            t_obj.find('.items-edit-div input').addClass('no-edit');
            //修改按钮显示
            $(this).next('.into-report-info-edit').removeClass('hidePlus');
            saveReportInfo($(this).parent().parent().find('form'),$(this));
            //保存按钮隐藏
            // $(this).addClass('hidePlus');
            console.log(obj2str($(this).parent().parent().find('form').serializeObject()));
        }).on('click','.delete-report-info',function(){
            deleteReportInfo(this.getAttribute('param'),this.getAttribute('param2'))
        });
        $('#query-dl').on('change',function(){
            queryForReportInfo(true);//查询记录日志
        });
        $('#query-mk').on('change',function(){
            queryForReportInfo(true);//查询记录日志
        });

    });
</script>
</html>