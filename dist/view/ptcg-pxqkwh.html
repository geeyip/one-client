<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta name="author" content="xiaohuiwen" />
    <meta name="date" content="2016-06-16 09:33:01" />
    <title>培训情况维护</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/ptcg.css?version=0.99">
</head>
<body>


<div id="training-query-condition" class="query-condition mt10">
    <div class="query-condition-p">
        <p class="query-reset">
            <b id="training-query-btn" class="cm-query-btn"></b>
            <b id="training-reset-btn" class="cm-reset-btn"></b>
        </p>
        <span class="common-field w65">项目单位：</span>
        <dict id="pxdw" dict-type="tree" dict-root="custom" dict-name="xmdwdm" dict-id="xmdwdmdict" class="xmdwdm dict"></dict>
        <span class="common-field w100">培训人：</span>
        <dict id="pxr" dict-type="select" dict-root="custom" dict-name="pxr" dict-id="pxrdict" return-value="true" class="gxr dict mr15"></dict>
        <span class="common-field w100">培训日期：</span>
        <input id="pxrqBeginDate" type="text" class="query-date" />~<input id="pxrqEndDate" type="text" class="query-date"/>
    </div>
</div>
<div id="training-query-result">
    <div class="new-color-bar">
        <span class="title">培训情况维护列表（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div" id="add-btu-limt">
            <b id="into-training-add" class="cm-add-btn hideplus"></b>
        </div>
    </div>
    <table id="training-table" class="typical-tb" cellpadding="3">
        <thead>
        <th width="5%">序号</th>
        <th width="12%" >项目代码</th>
        <th width="12%" >项目单位</th>
        <th width="26%" >培训主题</th>
        <th width="15%" >培训规模</th>
        <th width="10%" >培训人</th>
        <th width="10%" sort-name="pxrqStr">培训日期</th>
        <th width="10%" >操作</th>
        </thead>
        <tbody tpsource="#training-list"></tbody>
    </table>
    <div class="paging"></div>
</div>
<div id="add-training-div" class="hide">
    <form id="add-training-form">
        <input type="hidden" id="xmdwmc-add" name="xmdwmc"/>
        <p class="mt10">
            <span class="common-field"><span class="orangered">★ </span>项目单位：</span>
            <dict id="xmdwdm-add" dict-id="xmdwdm-add-dict" dict-name="xmdwdm" name="xmdwdm" dict-type="tree" dict-root="custom" class="xmdwdm dict"></dict>
            <span class="common-field"><span class="orangered">★ </span>培训规模：</span>
            <input id="pxgm-add" name="pxgm" class="validate common-input" type="text" data-options="required:true,validType:'extLength[0,100]'"/>
        </p>
        <p class="mt10">
            <span class="common-field fl"><span class="orangered">★ </span>培训主题：</span>
            <textarea id="pxzt-add" dict-id="pxzt-add-dict" name="pxzt" rows="3" class="validate" data-options="required:true,validType:'extLength[0,1000]'" ></textarea>
            <span class="common-field"><span class="orangered">★ </span>培训人：</span>
            <dict id="pxr-add" dict-id="pxr-add-dict" dict-name="pxr" dict-name="pxr" dict-type="select" dict-root="pxr" return-value="true" class="gxr dict mr15 validate" data-options="required:true"></dict>
            <span class="common-field"><span class="orangered">★ </span>培训日期：</span>
            <input id="pxrq-add" name="pxrqStr" type="text" class="validate query-date w253" data-options="required:true"/>
        </p>
        <p class="hide">
            <input id="id-add" name="id" class="common-input" type="text" data-options="required:true"/>
        </p>
    </form>
    <p class="tcenter mt20">
        <b id="save-training" class="cm-save-btn mr15"></b>
        <b id="add-training-cancel" class="cm-cancel-btn"></b>
    </p>
</div>
<div id="view-training-div" class="hide">
    <form id="view-training-form">
        <p class="mt10">
            <span class="common-field">项目单位：</span>
            <input id="xmdwdm-view" name="xmdwdm" class="common-input" unselectable="on" readonly="true" type="text" />
            <span class="common-field">培训规模：</span>
            <input id="pxgm-view" name="pxgm" class="common-input" unselectable="on" readonly="true" type="text" />
        </p>
        <p class="mt10">
            <span class="common-field fl">培训主题：</span>
            <textarea id="pxzt-view" name="pxzt" rows="3" unselectable="on" readonly="true" ></textarea>
            <span class="common-field">培训人：</span>
            <input id="pxr-view" name="pxr" class="common-input" unselectable="on" readonly="true" type="text" />
            <span class="common-field">培训日期：</span>
            <input id="pxrq-view" name="pxrqStr" type="text" class="common-input" unselectable="on" readonly="true" />
        </p>
    </form>
    <p class="tcenter mt20">
        <b id="view-training-cancel" class="cm-close-btn"></b>
    </p>
</div>
<script type="text/template" id="training-list">
    <tr>
        <td>{rn}</td>
        <td>{xmdwdm}</td>
        <td>{xmdwmc}</td>
        <td>{pxzt}</td>
        <td>{pxgm}</td>
        <td>{pxr}</td>
        <td>{pxrqStr}</td>
        <td>
            <a class="view-pxqkwh  icon-show-btn "  param="{id}" title="查看"></a>
            <a class="modify-pxqkwh icon-edit-btn hidden{editLimit}"  param="{id}" title="修改"></a>
            <a class="delete-pxqkwh icon-remove-btn hidden{deleteLimit}"  param="{id}" param2="{pxzt}" title="删除"></a>
        </td>
    </tr>
    <tr class="hide">
        <td>当前日期隐藏域</td><td><input name="dqrq" value="{dqrq}" id="dqrq-hide" type="text" class="common-input"></td>
    </tr>
</script>


</body>
<script src="../js/base.js?version=0.99"></script>
<script>
    importing('datepicker','dict',function () {
        var initPageAction = top.path + '/api/0/ptcg/pxqk/query',
            queryReportsAction = top.path + '/api/1/ptcg/pxqk/query',
            deleteReportsAction = top.path + '/api/1/ptcg/pxqk/delete',
            saveReportsAction = top.path + '/api/1/ptcg/pxqk/add',
            updateReportsAction = top.path + '/api/1/ptcg/pxqk/edit',
            xmdwAction = top.path + '/api/0/basic/project/project_unit',
            pxrAction = top.path + '/api/0/basic/project/user_info';
        var deleteLimit=top.ops['ptcg-pxqkwh-delete'],
            editLimit=top.ops['ptcg-pxqkwh-edit'],
            addLimit=top.ops['ptcg-pxqkwh-add'];
        var pxqkPageDate,//页面数据
            saveType;//保存类型

        if(addLimit){
            $('#into-training-add').removeClass('hideplus');
        }
        $('.query-date').datepicker();

        //查询
        function queryPageData(isFirst,currentPage){
            var action;
            var t_beginDate = $('#pxrqBeginDate').val();
            var t_endDate = $('#pxrqEndDate').val();
            if(!t_beginDate.isEmpty() && !t_endDate.isEmpty() && t_beginDate > t_endDate){
                toast('培训日期开始时间不能大于结束时间！').css('width','300px').err();
                return false;
            }
            if(isFirst){//判断是都第一次进入
                action = initPageAction;
            }else{
                action = queryReportsAction;
            }
            $('#training-query-result').pagingList({
                action: action,
                currentPage:currentPage,
                jsonObj: {
                    pxdw: $('#xmdwdmdict').val(),
                    pxr: $('#pxrdict').val(),
                    pxrqBeginDate: $('#pxrqBeginDate').val(),
                    pxrqEndDate: $('#pxrqEndDate').val()
                },
                callback: function (data) {
                    pxqkPageDate = data;
                    $template('#training-table tbody', data,function (item) {
                        item.deleteLimit = deleteLimit;
                        item.editLimit = editLimit;
                        if(item.pxr == localData.get('login-truename')){
                            item.deleteLimit = '1';
                            item.editLimit = '1';
                        }
                    });
                }
            });
        }

        //项目单位
        function queryForXmdw(){
            $get(xmdwAction,{},function(res){
                $('#pxdw').dict(res.data.unitInfo);
                $('#xmdwdm-add').dict(res.data.unitInfo);
            });
        }

        //共享人(项目经理)
        function queryForPxr(){
            $get(pxrAction,{type:'1'},function(res){
                $('#pxr').dict(res.data);
                $('#pxr-add').dict(res.data);
            })
        }

        //参数去空格
        function trimAll(selector) {
            $(selector+' input,'+selector+' textarea').each(function (i,el) {
                var value = $(el).val();
                $(el).val(value.trim());
            });
        }

        //重置
        function resetQuerycondition(){
            $('#xmdwdmdict').val('');
            $('#xmdwdmdict_displayValue').val('');
            $('#pxrdict').val('');
            $('#pxrqBeginDate').val('');
            $('#pxrqEndDate').val('');
        }

        //删除数据
        function deleteTraining(id,zt){
            $confirm('确认删除【'+zt+'】培训主题？',function(bol) {
                if (bol) {
                    $get(deleteReportsAction, {id: id}, function (res) {
                        toast(res.msg, 600).ok();
                        if (res.flag == 1) {
                            queryPageData(false,$('.paging').data('currentPage'));
                        }else{
                        }
                    }, true);
                }
            });
        }

        //新增数据
        function addTraining(){
            removeVlidatebox();
            saveType=1;
            $("#add-training-form")[0].reset();
            if(null!=$('#dqrq-hide').val()&&''!=$('#dqrq-hide').val()){
                $('#pxrq-add').val($('#dqrq-hide').val());
            }else{
                $('#pxrq-add').val(getNowDate());
            }
            $('#pxr-add-dict').val(localData.get('login-truename'));
            $('#xmdwdm-add-dict').addClass('validate').attr('data-options','required:true');;
            $('#xmdwdm-add-dict_displayValue').addClass('validate').attr('data-options','required:true');
            if($('#pxr-add-dict').val() == null){$('#pxr-add-dict').val('');}
            $open('#add-training-div', {width: 780, height: 260, title: '培训情况新增'});
        }

        //新增保存角色
        function saveTraining(){
            trimAll('#add-training-div');
            //添加必选样式
            $('#xmdwmc-add').val($('#xmdwdm-add-dict_displayValue').val());
            $('#add-training-form .validate').validatebox();
            if($('#add-training-form .validatebox-invalid').length>0){
                return false;
            }
            if(saveType==1){
                $post(saveReportsAction,$("#add-training-form").serializeObject(),function(res){
                    roleCloseWin('add-training-div');
                    toast('保存成功！').ok();
                    queryPageData(true,$('.paging').data('currentPage'));
                },true);
            }else if(saveType==2){
                $post(updateReportsAction,$("#add-training-form").serializeObject(),function(res){
                    roleCloseWin('add-training-div');
                    toast('保存成功！').ok();
                    queryPageData(true,$('.paging').data('currentPage'));
                },true);
            }
        }

        //关闭窗口
        function roleCloseWin(id){
            $('#'+id).$close();
        }

        //修改数据
        function editTraining(id){
            removeVlidatebox();
            saveType=2;
            for(var i=0;i<pxqkPageDate.length;i++){
                if(pxqkPageDate[i].id==id){
                    $('#pxrq-add').val(pxqkPageDate[i].pxrqStr);
                    $('#xmdwmc-add').val(pxqkPageDate[i].xmdwmc)
                    $('#xmdwdm-add-dict').val(pxqkPageDate[i].xmdwdm);
                    $('#xmdwdm-add-dict_displayValue').val(pxqkPageDate[i].xmdwmc);
                    $('#pxzt-add').val(pxqkPageDate[i].pxzt);
                    $('#pxgm-add').val(pxqkPageDate[i].pxgm);
                    $('#pxr-add').dictSelect(pxqkPageDate[i].pxr);
                    $('#id-add').val(id);
                }
            }
            //添加必选样式
            $('#xmdwdm-add-dict').addClass('validate').attr('data-options','required:true');;
            $('#xmdwdm-add-dict_displayValue').addClass('validate').attr('data-options','required:true');
            $('#pxr-add-dict').addClass('validate').attr('data-options','required:true');
            $open('#add-training-div', {width: 780, height: 260, title: '培训情况修改'});
        }

        function getNowDate(){
            var myDate = new Date();
            var year = myDate.getFullYear();    //获取完整的年份(4位,1970-????)
            var month = myDate.getMonth()+1;       //获取当前月份(0-11,0代表1月)
            var day = myDate.getDate();
            var dataStr = year+"-"+month+"-"+day;
            return dataStr;
        }

        //查看
        function viewTraining(id){
            for(var i=0;i<pxqkPageDate.length;i++){
                if(pxqkPageDate[i].id==id){
                    $('#pxrq-view').val(pxqkPageDate[i].pxrqStr);
                    $('#xmdwdm-view').val(pxqkPageDate[i].xmdwmc);
                    $('#pxzt-view').val(pxqkPageDate[i].pxzt);
                    $('#pxgm-view').val(pxqkPageDate[i].pxgm);
                    $('#pxr-view').val(pxqkPageDate[i].pxr);
                    $('#id-view').val(pxqkPageDate[i].id);
                }
            }
            $open('#view-training-div', {width: 780, height: 260, title: '培训情况查看'});
        }

        //移除判断样式
        function removeVlidatebox(){
            $('.validate').removeClass('validatebox-invalid');
        }


        //自定义培训人字典数据
        queryForPxr();
        //自定义项目单位字典数据
        queryForXmdw();
        //查询数据
        queryPageData(true);

        //注册事件
        $('#training-query-btn').on('click',function(){
            if($('.sort-arrow')) $('.sort-arrow').remove();
            queryPageData(false);
        });
        $('#training-reset-btn').on('click',function(){
            resetQuerycondition();
        });
        $('#add-training-cancel').on('click',function(){
            roleCloseWin('add-training-div');
        });
        $('#view-training-cancel').on('click',function(){
            roleCloseWin('view-training-div');
        });
        $('#into-training-add').on('click',function(){
            addTraining();
        });
        $('#save-training').on('click',function(){
            saveTraining();
        });
        $('#training-table').on('click','.delete-pxqkwh:not(.hide)',function(){
            deleteTraining(this.getAttribute('param'),this.getAttribute('param2'));
        }).on('click','.modify-pxqkwh:not(.hide)',function(){
            editTraining(this.getAttribute('param'));
        }).on('click','.view-pxqkwh',function(){
            viewTraining(this.getAttribute('param'),'');
        });

    });
</script>
</html>