<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>系统参数管理</title>
    <link rel="stylesheet" href="../../dist/css/base.css">
    <link rel="stylesheet" href="../../dist/css/info-mng.css"/>
</head>
<body>
    <!--查询条件-->
    <div class="query-condition mt10">
        <form id="parameter-form">
            <div class="query-condition-p">
                <span class="common-field w65">参数类别：</span>
                <dict dict-id="paramLb-dict" id="paramLb" dict-name="paramLb" dict-type="select" dict-root="CSLBDM" class="dict"></dict>
                <span class="common-field w100">参数英文名：</span>
                <input id="paramEname" name="paramEname" type="text" class="common-input"/>
                <span class="common-field w100">参数中文名：</span>
                <input id="paramCname" name="paramCname" type="text" class="common-input"/>
                <p class="query-reset">
                    <b class="cm-query-btn" id="query-btn"></b>
                    <b class="cm-reset-btn" id="reset-btn"></b>
                </p>
            </div>
        </form>
    </div>
    <!--参数列表-->
    <div id="query-result" class="mt20">
        <div class="new-color-bar">
            <span class="title">系统参数列表（共找到<span class="total-count"></span>条数据）</span>
            <div class="bar-btn-div">
                <b id="into-param-add" class="cm-add-btn hidePlus"></b>
            </div>
        </div>
        <table id="parameter-info-table" class="typical-tb" cellpadding="3">
            <thead>
            <th width="5%">序号</th>
            <th width="15%">参数类别</th>
            <th width="15%">参数英文名</th>
            <th width="15%">参数中文名</th>
            <th width="30%">参数值</th>
            <th width="10%">版本号</th>
            <th width="10%">操作</th>
            </thead>
            <tbody tpsource="#parameter-info-list"></tbody>
        </table>
        <div class="paging"></div>
    </div>
    <!--新增弹窗-->
    <div id="add-parameter-block" class="hide">
        <form id="add-form">
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>参数类别：</span>
                <dict dict-id="paramLb-dict-add" dict-name="paramLb" dict-type="select" dict-root="CSLBDM" class="dict" empty="false"></dict>
                <span class="common-field w115">版本号：</span>
                <dict id="xtbbh-add" dict-name="xtbbh" dict-id="xtbbh-add-dict" dict-type="select" dict-root="custom" return-value="true"  class="xtbbh mr15" ></dict>
            </p>
            <p>
                <span class="common-field w65"><span class="orangered">★ </span>参数英文名：</span>
                <input name="paramEname" id="add-paramEname" class="common-input mr15 validate messager-p-msg mt4" data-options="required:true,validType:'paramEname'">
                <span class="common-field w65"><span class="orangered">★ </span>参数中文名：</span>
                <input name="paramCname" id="add-paramCname" class="common-input mr15 validate" data-options="required:true,validType:'extLength[0,50]'">
            </p>
            <p>
                <span class="common-field">参数值：</span>
                <input name="paramValue"  class="common-input mr15 validate messager-p-msg w647" data-options="validType:'length[0,500]'">
            </p>
            <p>
                <span class="common-field fl">参数说明：</span>
                <textarea name="paramDesc" class="common-textarea sql-text validate" data-options="validType:'length[0,2000]'"></textarea>
            </p>
            <p class="mt20 mb20 tcenter mb15">
                <b id="add-save-btn" class="cm-save-btn mr15"></b>
                <b id="add-close-btn" class="cm-cancel-btn "></b>
            </p>
        </form>
    </div>
    <!--修改弹窗-->
    <div id="edit-parameter-block" class="hide">
        <form id="edit-form">
            <input id="edit-id" name="mainId" type="hidden"/>
            <input id="oldParamEname" name="oldParamEname" type="hidden"/>
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>参数类别：</span>
                <dict id="edit-paramLb" dict-id="paramLb-dict-edit" dict-name="paramLb" dict-type="select" dict-root="CSLBDM" class="dict" empty="false"></dict>
                <span class="common-field w115">版本号：</span>
                <dict id="edit-xtbbh" dict-name="xtbbh" dict-id="edit-xtbbh-dict" dict-type="select" dict-root="custom" return-value="true"  class="xtbbh mr15" ></dict>
            </p>
            <p>
                <span class="common-field"><span class="orangered">★ </span>参数英文名：</span>
                <input name="paramEname" id="edit-paramEname" class="common-input mr15 validate messager-p-msg mt4" data-options="required:true,validType:'paramEname'">
                <span class="common-field w65"><span class="orangered">★ </span>参数中文名：</span>
                <input name="paramCname" id="edit-paramCname" class="common-input mr15 validate" data-options="required:true,validType:'extLength[0,50]'">
            </p>
            <p>
                <span class="common-field">参数值：</span>
                <input name="paramValue" id="edit-paramValue"  class="common-input mr15 validate messager-p-msg w647" data-options="validType:'length[0,500]'">
            </p>
            <p>
                <span class="common-field fl">参数说明：</span>
                <textarea name="paramDesc" id="edit-paramDesc" class="common-textarea  sql-text validate" data-options="validType:'length[0,2000]'"></textarea>
            </p>
            <p class="mt20 mb20 tcenter mb15">
                <b id="edit-save-btn" class="cm-save-btn mr15 "></b>
                <b id="edit-close-btn" class="cm-cancel-btn"></b>
            </p>
        </form>
    </div>
    <!--查看弹窗-->
    <div id="check-parameter-block" class="hide">
        <form id="check-form">
            <p class="mt30">
                <span class="common-field w65">参数类别：</span>
                <input name="paramCname" id="check-paramLb" class="common-input mr15 " readonly>
                <span class="common-field w100">版本号：</span>
                <input name="xtbbh" id="check-xtbbh" class="common-input mr15 " readonly>
            </p>
            <p>
                <span class="common-field w65">参数英文名：</span>
                <input name="paramEname" id="check-paramEname" class="common-input mr15  messager-p-msg mt4" readonly>
                <span class="common-field w65">参数中文名：</span>
                <input name="paramCname" id="check-paramCname" class="common-input mr15 " readonly>
            </p>
            <p>
                <span class="common-field">参数值：</span>
                <input name="paramValue" id="check-paramValue" class="common-input mr15 messager-p-msg w647" readonly>
            </p>
            <p>
                <span class="common-field fl">参数说明：</span>
                <textarea name="paramDesc" id="check-paramDesc" class="common-textarea sql-text " readonly></textarea>
            </p>
            <p class="mt20 mb20 tcenter mb15">
                <b id="check-close-btn" class="cm-close-btn "></b>
            </p>
        </form>
    </div>
</body>
<!--列表数据-->
<script type="text/template" id="parameter-info-list">
    <tr class="{$nth2}">
        <td>{rownum}</td>
        <td class="paramLbZw">{paramLbZw}</td>
        <td class="paramEname">
            <a class="search-project" dataId="{id}" paramDesc="{paramDesc}">{paramEname}</a>
        </td>
        <td class="paramCname">{paramCname}</td>
        <td class="paramValue">
            <p class="brief-content" readonly>{paramValue}</p>
            <a class="more-a" href="javascript:void(0);" moreId="{id}u">更多</a>
        </td>
        <td class="xtbbh">{xtbbh}</td>
        <td>
            <a class="icon-edit-btn modify-project  hidePlus{editLimit}" paramDesc="{paramDesc}" paramLb="{paramLb}" dataId="{id}" oldParamEname="{paramEname}"></a>
            <a class="icon-remove-btn delete-project  hidePlus{deleteLimit}" paramId = "{id}" paramEname="{paramEname}"></a>
        </td>
    </tr>
</script>
<script src="../../dist/js/base.js"></script>
<script src="../../dist/js/info-mng.js"></script>
<script>
    importing('dict',function () {
        var parameterListAction = top.path+'/api/0/basic/parameter/list',
            parameterAddAction = top.path+'/api/0/basic/parameter/add',
            parameterEditAction = top.path+'/api/0/basic/parameter/edit',
            parameterDeleteAction = top.path+'/api/0/basic/parameter/delete',
            versionInfoAction = top.path+'/api/0/basic/version/version_info',
                pageData = [];

        var deleteLimit=top.ops['basic-param-delete'],
                editLimit=top.ops['basic-param-update'],
                addLimit=top.ops['basic-param-add'];

        $('.dict').dict();

        function loadParameterList(currentPage) {
            $encode.allowHTML = true;
            $('#query-result').pagingList({
                action:parameterListAction,
                currentPage:currentPage,
                jsonObj:$('#parameter-form').serializeObject(),
                callback:pageBack
            });
        }
        //回调函数
        function pageBack(data) {
            pageData = data;
            $template('#parameter-info-table tbody', data, function(item, i){
                item.deleteLimit = deleteLimit;
                item.editLimit = editLimit;
            });
            //内容在4行内的不显示“更多”
            isShowMore();
            //修改
            $('.modify-project').on('click',function () {
                $open('#edit-parameter-block',{title:'系统参数修改',width:820});
                //初始化修改弹窗数据
                initWinData.call(this,'#edit-paramLb','#edit-paramCname','#edit-paramEname','#edit-paramValue','#edit-paramDesc','#edit-xtbbh-dict','');
            });
            //删除
            $('.delete-project').on('click',function () {
                var id = $(this).attr('paramId');
                var paramEname = $(this).attr('paramEname');
                $confirm('确定删除参数'+paramEname+'吗？',function (del) {
                    if(del){
                        $post(parameterDeleteAction,{id:id},function (res) {
                            var msg = res.msg?res.msg:'删除成功！';
                            toast(msg,600).ok();
                            //加载系统参数列表数据
                            loadParameterList($('.paging').data('currentPage'));
                        });
                    }
                });
            });
            //查看
            $('#parameter-info-table').on('click','.search-project',function(){
                $open('#check-parameter-block',{title:'系统参数查看',width:820});
                //初始化修改弹窗数据
                initWinData.call(this,'#check-paramLb','#check-paramCname','#check-paramEname','#check-paramValue','#check-paramDesc','#check-xtbbh','1');
            });
        }
        //初始化方法
        function init() {
            //加载系统版本列表数据
            loadParameterList();
        }
        //版本信息
        function getVersionInfo(){
            $get(versionInfoAction,{type:"0", xmId:null},function(res){
                console.log(res.data);
                $('.xtbbh').dict(res.data);
                $('#xtbbh-add').dictSelect(res.data[0].key);
            })
        }
        //保存
        function saveParameter(action,params,winId,formId) {
            //验证
            $(winId+' .validate').validatebox();
            if($('.validatebox-invalid').length>0){
                return false;
            }
            //保存
            $post(action,params,function (res) {
                var msg = res.msg?res.msg:'保存成功！';
                closeWin(winId,formId);
                toast(msg,600).ok();
                //加载模块语句列表数据
                loadParameterList($('.paging').data('currentPage'));
            },true);

        }
        //关闭弹窗
        function closeWin(winId,formId) {
            $(winId).$close();
            $(formId)[0].reset();
            $('.validate').removeClass('validatebox-invalid');
        }
        //初始化窗口数据
        function initWinData(paramLbId,paramCnameId,paramEnameId,paramValueId,paramDescId,xtbbhId,viewFLag) {
            var that = $(this),
                    id = that.attr('dataId');
                    thatArr = pageData.where('o=>o.id=="'+id+'"'),
                    paramValue= thatArr.select('o=>o.paramValue'),
                    pTd = that.parent();
            var xtbbh = pTd.siblings('.xtbbh').html();
            $(paramLbId).val(pTd.siblings('.paramLbZw').html());
            $('#edit-paramLb').val(that.attr('paramLb'));
            $('#edit-id').val(id);
            $('#oldParamEname').val(that.attr('oldParamEname'));
            $(paramCnameId).val(pTd.siblings('.paramCname').html());
            $(xtbbhId).val(xtbbh);
            $(paramValueId).val(paramValue);
            $(paramDescId).html(that.attr('paramDesc'));
            if(viewFLag) {
                $(paramEnameId).val(that.html());
            } else {
                $(paramEnameId).val(pTd.siblings('.paramEname').children('a').html());
            }
        }
        //设置参数英文名填写规则
        $.extend($.fn.validatebox.defaults.rules, {
            paramEname: {
                validator: function (val) {
                    return /^\w{0,50}$/.test(val);
                },
                message: '参数英文名只能包含字符、数字和下划线，且长度不能大于50'
            },
            paramCname: {
                validator: function (val) {
                    return /^[\u4E00-\u9FA5]{0,25}$/.test(val);
                },
                message: '参数中文名只能包含中文，且长度不能大于25'
            }
        });
        //查询
        $('#query-btn').on('click',function () {
            if($('.sort-arrow')) $('.sort-arrow').remove();
            loadParameterList();
        });
        //重置
        $('#reset-btn').on('click',function () {
            $('#parameter-form')[0].reset();
        });
        //新增
        $('.cm-add-btn').on('click',function () {
            $open('#add-parameter-block',{title:'系统参数新增',width:820});
        });
        //关闭新增弹窗
        $('#add-close-btn').on('click',function () {
            closeWin('#add-parameter-block','#add-form');
        });
        //保存新增内容
        $('#add-save-btn').on('click',function () {
            saveParameter(parameterAddAction,$('#add-form').serializeObject(),'#add-parameter-block','#add-form');
        });
        //关闭修改弹窗
        $('#edit-close-btn').on('click',function () {
            closeWin('#edit-parameter-block','#edit-form');
        });
        //保存修改内容
        $('#edit-save-btn').on('click',function () {
            saveParameter(parameterEditAction,$('#edit-form').serializeObject(),'#edit-parameter-block','#edit-form');
        });
        //关闭查看弹窗
        $('#check-close-btn').on('click',function () {
            $('#check-parameter-block').$close();
        });
        //新增走权限控制
        if(addLimit){$('#into-param-add').removeClass('hidePlus');}
        //初始化
        init();
        //版本信息
        getVersionInfo();
    });
</script>
</html>