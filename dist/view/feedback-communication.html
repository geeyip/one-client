<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>协作交流</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/feedback.css?version=0.99">
</head>
<body>

<div id="word-image-upload" style="display: none"></div>

<div id="fb-communicate-query-result">
    <div class="new-color-bar">
        <!--<span class="title">交流协作中心（共<span class="total-count"></span>条数据）</span>-->
        <div class="task-topic-tabs">
            <div class="task-tab current-tab">任 务</div>
            <div class="topic-tab">话 题</div>
        </div>
        <div class="bar-btn-div">
            <div id="add-btns" class="add-btn-group">
                <!--<div><span class="add-topic-span add-topic"><i class="icon-list-alt"></i> 发起话题</span><span class="add-down down-show"><i class="icon-caret-down"></i></span></div>-->
                <div class="topic-btn hide"><span class="add-topic-span add-topic"><i class="icon-list-alt"></i> 发起话题</span></div>
                <div class="task-btn"><span class="add-task-span add-task"><i class="icon-tasks"></i> 新增任务</span></div>
                <!--<ul class="add-ul hide">-->
                    <!--<li class="add-topic"><i class="icon-list-alt"></i> 发起话题</li>-->
                    <!--<li class="add-task"><i class="icon-tasks"></i> 新增任务</li>-->
                <!--</ul>-->
            </div>
        </div>
    </div>
    <div id="communicate-list">
        <div class="communicate-rows" tpsource="#communicate-list-data"></div>
    </div>
    <div class="paging"></div>
</div>

<div id="add-topic-div" class="hide">
    <form id="add-topic-form">
        <div>
            <span class="common-field"><span class="orangered">★ </span>话题标题：</span><input name="title" class="common-input add-topic-title validate" data-options="required:true, validType:'length[0,150]'" type="text"/>
        </div>
        <div>
            <span class="common-field fl"><span class="orangered">★ </span>话题内容：</span>
            <textarea id="add-topic-textarea" class="common-textarea"></textarea>
        </div>
        <div class="mt10">
            <span class="common-field fl">关注人：</span>
            <div class="communicate-attention-user">
                <div id="gzrList-add">
                    {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                    <div class="add-name ellipsis items-plus" paramId="gzrList-add" title="添加话题关注人"><i class="icon-plus"></i></div>
                </div>
            </div>
        </div>
    </form>
    <div class="tcenter mt15">
        <b id="save-topic" class="cm-save-btn mr15"></b>
        <b id="add-topic-cancel" class="cm-cancel-btn"></b>
    </div>
</div>
<div id="add-task-div" class="hide">
    <form id="add-task-form">
        <div>
            <span class="common-field"><span class="orangered">★ </span>任务标题：</span><input name="title" class="validate common-input w750" data-options="required:true, validType:'length[0,150]'" type="text"/>
        </div>
        <div>
            <span class="common-field fl"><span class="orangered">★ </span>任务描述：</span>
            <textarea id="add-task-textarea" class="common-textarea"></textarea>
        </div>
        <div class="mt10">
            <span class="common-field fl">分配给：</span>
            <div class="communicate-attention-user">
                <div id="gzrList-add-task">
                    {{jsrList:#<div class="name ellipsis">{name}</div>#}}
                    <div class="add-name ellipsis items-plus-task" paramId="gzrList-add-task" title="添加任务接收人"><i class="icon-plus"></i></div>
                </div>
            </div>
        </div>
        <div class="mt10">
            <span class="common-field fl">关注人：</span>
            <div class="communicate-attention-user">
                <div id="gzrList-add-ht">
                    {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                    <div class="add-name ellipsis items-plus" paramId="gzrList-add-ht" title="添加任务关注人"><i class="icon-plus"></i></div>
                </div>
            </div>
        </div>
        <div class="mt10">
            <span class="common-field">截止时间：</span><input name="endDate" class="common-input task-end-date" type="text"/>
        </div>
    </form>
    <form id="upload-form" method="post" enctype='multipart/form-data' target="for-uploaded">
        <div class="mt10">
            <span class="common-field">上传附件：</span><input type="file" name="upload"/><div class="file-input-shade"></div>
            <span class="exist-judge red hide ml15"><i class="icon-warning-sign"></i> 文件已经存在，请删除后再上传</span>
        </div>
        <div class="upload-files-show"></div>
    </form>
    <iframe src="workbench.html" name="for-uploaded"></iframe>
    <div class="tcenter mt15">
        <b id="save-task" class="cm-save-btn mr15"></b>
        <b id="add-task-cancel" class="cm-cancel-btn"></b>
    </div>
</div>
<div id="edit-topic-div" class="hide">
    <form id="edit-topic-form">
        <input type="hidden" name="editId"/>
        <div>
            <span class="common-field"><span class="orangered">★ </span>话题标题：</span><input name="title" class="common-input add-topic-title validate" data-options="required:true, validType:'length[0,150]'" type="text"/>
        </div>
        <div>
            <span class="common-field fl"><span class="orangered">★ </span>话题内容：</span>
            <textarea id="edit-topic-textarea" class="common-textarea"></textarea>
        </div>
        <div class="mt10">
            <div class="attention">
                <div class="w720" >
                    <span class="common-field fl">关注人：</span>
                    <div class="communicate-attention-user">
                        <div id="gzrList-edit">
                            {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                            <div class="add-name ellipsis items-plus" paramId="gzrList-edit" title="添加话题关注人"><i class="icon-plus"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="tcenter mt15">
        <b id="update-topic" class="cm-save-btn mr15"></b>
        <b id="edit-topic-cancel" class="cm-cancel-btn"></b>
    </div>
</div>
<div id="edit-task-div" class="hide">
    <form id="edit-task-form">
        <input type="hidden" name="editId"/>
        <div>
            <span class="common-field"><span class="orangered">★ </span>任务标题：</span><input name="title" class="validate common-input w750" data-options="required:true, validType:'length[0,150]'" type="text"/>
        </div>
        <div>
            <span class="common-field fl"><span class="orangered">★ </span>任务描述：</span>
            <textarea id="edit-task-textarea" class="common-textarea"></textarea>
        </div>
        <div class="mt10">
            <span class="common-field fl">分配给：</span>
            <div class="communicate-attention-user">
                <div id="gzrList-edit-task">
                    {{jsrList:#<div class="name ellipsis">{name}</div>#}}
                    <div class="add-name ellipsis items-plus-task" paramId="gzrList-edit-task" title="添加任务接收人"><i class="icon-plus"></i></div>
                </div>
            </div>
        </div>
        <div class="mt10">
            <span class="common-field fl">关注人：</span>
            <div class="communicate-attention-user">
                <div id="gzrList-edit-ht">
                    {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                    <div class="add-name ellipsis items-plus" paramId="gzrList-edit-ht" title="添加任务关注人"><i class="icon-plus"></i></div>
                </div>
            </div>
        </div>
        <div class="mt10">
            <span class="common-field">截止时间：</span><input name="endDate" class="common-input task-end-date" type="text"/>
        </div>
    </form>
    <form id="edit-upload-form" method="post" enctype='multipart/form-data' target="for-uploaded">
        <div class="mt10">
            <span class="common-field">上传附件：</span><input type="file" name="upload"/><div class="file-input-shade"></div>
            <span class="exist-judge red hide ml15"><i class="icon-warning-sign"></i> 文件已经存在，请删除后再上传</span>
        </div>
        <div id="edit-upload-files-show" class="upload-files-show" tpsource="#file-list"></div>
    </form>
    <iframe src="uploaded.html" name="for-uploaded"></iframe>
    <div class="tcenter mt15">
        <b id="update-task" class="cm-save-btn mr15"></b>
        <b id="edit-task-cancel" class="cm-cancel-btn"></b>
    </div>
</div>
<div id="topic-task-view-div" class="hide">
    <div id="topic-task-content">
        <div class="title">{title}</div>
        <div class="issue-info">{createPid}  发起于 {createDateTxt}</div>
        <div class="content">

        </div>
        <div class="attachments hide{file}">{{fileList:#<div><span><i class="icon-paper-clip"></i></span> <a class="file-download" title="点击下载" paramName="{FILENAME}">{FILENAME}</a></div>#}}</div>
    </div>
    <div id="topic-task-members">
        <div class="showTopic hide{showTopic}">
            <div class="attention">
                <span class="title">关注的人</span>
                <div class="attention-names w720">
                    {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                </div>
            </div>
        </div>
        <div class="showTask hide{showTask}">
            <div class="given">
                <span class="title">分配任务给</span>
                <div class="given-names">
                    {{jsrList:#<div class="name ellipsis">{name}</div>#}}
                </div>
            </div>
            <div class="attention">
                <span class="title">关注的人</span>
                <div class="attention-names">
                    {{gzrList:#<div class="name ellipsis">{name}</div>#}}
                </div>
            </div>
        </div>
    </div>
    <div id="topic-task-comments">
        <h3 class="nav">评 论</h3>
        <dl id="comments-dl" class="mt10" tpsource="#comments-data"></dl>
        <form id="comment-form">
            <textarea id="comment-detail" name="replyContent" class="validate" data-options="required:true,validType:'length[0,1500]'" placeholder="说点什么..."></textarea>
        </form>
    </div>
    <div class="tcenter mt15">
        <b class="save-comment cm-save-btn mr15"></b>
        <b id="topic-task-cancel" class="cm-cancel-btn"></b>
    </div>
</div>
<div id="topic-task-choose-div" class="hide">
    <input id="choose-tGzr" name="serachGzr" type="text" class="common-input pos" placeholder="搜索用户" />
    <div id="communicate-choose">
        <div class="user-rows" tpsource="#communicate-choose-data"></div>
    </div>
    <div class="tcenter">
        <b id="sure-choose-btn" class="cm-save-btn"></b>
    </div>
</div>
</body>
<script type="text/template" id="communicate-list-data">
    <div class="communicate-row stick-row-{ifStick}">
        <div class="row-detail">
            <div class="topic-task-cir {typeCir}" title="{typeTxt}"><i class="icon-{typeCir}"></i><span class="topic-task-text">{typeTxt}</span></div>
            <div class="Ju hide{attachShow}"></div><h4 class="a-topic-task-title task-{line} ellipsis" paramId="{id}" title="{title}">{title}</h4>
            <div class="report-reply-info ellipsis">
                <div class="report-info task-{line}">{createPid} 发表于 {createDateTxt} </div> <div class="reply-info hideplus{lastReply} task-{line}"><span class="mr15">|</span>{lastModifyPid} 最后回复于 {lastModifyDateTxt}</div>
            </div>
            <div class="reply-count">
                <span class="total-comment" title="有 {replyCount} 个评论">{replyCount}</span>
            </div>
            <div class="communicate-opt">
                <a class="{ifFinish} hideplus{hi}" paramId="{id}" title="{ifFinishTxt}"><i class="{icon}"></i></a>
                <a class="into-edit-communication icon-edit-btn hideplus{hi2}" param="{type}" paramId="{id}" title="修改"></a>
                <a class="delete-communication icon-remove-btn hideplus{hi3}" paramId="{id}" paramType="{type}" paramTitle="{title}" title="删除"></a>
                <a class="stick-{ifStick}" paramId="{id}" paramType="{type}" title="{stickTitle}"><i class="icon-pushpin"></i></a>
            </div>
        </div>
    </div>
</script>
<script type="text/template" id="comments-data">
    <div class="md">
        <dt class="mp">
            <i class="icon-user"></i>
            <p>
                <span>{createPid}</span>
                <span class="r-date">{createDateStrTxt}</span>
                <a class="reply hide">回复</a>
            </p>
        </dt>
        <dd class="mc" paramId="{id}">
            <span>{replyContent}</span>
            <div class="mc-reply">
                {{replyList:#<p><span class="bold">{createPid}<span class="mc-reply-date"> {createDateStrTxt}</span>：</span>{replyContent}</p>#}}
            </div>
            <div class="mc-reply-input-div hide">
                <textarea class="reply-detail validate" data-options="validType:'length[0,1500]'" placeholder="说点什么..."></textarea>
                <div class="report-btn-div"><b class="cm-save-btn"></b></div>
            </div>
        </dd>
    </div>
</script>
<script type="text/template" id="file-list">
    <div>
        <span><i class="icon-paper-clip"></i></span>
        <span class="file-name">{FILENAME}</span><span class="file-remove" paramId="{ID}">删除</span>
    </div>
</script>
<script type="text/template" id="communicate-choose-data">
    <div class="user-row">
        <div class="{ifSelect}" paramId="{id}" paramTrueName="{trueName}" paramName="{userName}" paramIcon="{iconId}">
            <span class="pic-user"><i class="icon-user"></i></span>
            <span class="user-name">{trueName}</span>
            <span class="select-user"><i id="{iconId}" class="{icon}"></i></span>
        </div>
    </div>
</script>
<script src="../js/base.js?version=0.99"></script>
<script>
    importing('dict', 'datepicker', 'ckeditor', function(){

        var focusUserAction = top.path + '/api/0/basic/project/user_info',
                searchAction = top.path + '/api/0/feedback/collaborative/query', //列表查询action
                saveAction = top.path + '/api/0/feedback/collaborative/add', //新增话题or任务action
                updateAction = top.path + '/api/0/feedback/collaborative/edit', //修改更新话题or任务action
                deleteAction = top.path + '/api/0/feedback/collaborative/delete', //删除话题or任务action
                stickAction = top.path + '/api/0/feedback/collaborative/top', //置顶操作action
                replyAction = top.path + '/api/0/feedback/collaborative/reply', //评论or回复action
                searchCommentsAction =  top.path + '/api/0/feedback/collaborative/view', //查询任务or话题下的所有评论
                finishAction = top.path + '/api/0/feedback/collaborative/close', //任务是否关闭action
                searchUserNameAction =  top.path + '/api/0/feedback/collaborative/choose'; //查询关注人、分配者的action

        //附件上传、下载的action
        var fileUploadPath = top.uploadPath + '/api/upload/file?host='+localData.get('userInfo').serverIp+'&port='+localData.get('userInfo').serverPort+'&project='+top.path,
            fileDownloadPath = top.uploadPath + '/api/upload/download/';

        var thisYear = Date.format('YYYY');//今年

        var addTaskId; //新增的任务的id，因为i附件上传时需要传入id，故进入新增页面时需要设置id

        var addEditor, editEditor, addTaskEditor, editTaskEditor;//ckeditor变量

        var oldTaskJsr, oldTaskGzr;//修改时保存原有的任务关注人和任务接收人

        var topicOrTaskId; //评论的话题or任务的id
        var ifReply; //是否进行了评论 默认为false

        var deleteLimit=top.ops['feedback-communication-delete'],
            editLimit=top.ops['feedback-communication-edit'];

        var oldInput ,isJsr ,fileList = [],
                gzrSubList = [] /*关注用户提交list*/,jsrSubList = [] /*接收用户提交list*/,isSave = 0 /*是否保存标志*/,
                deleteIds = []  /*删除id*/,gzrList = []/*关注用户缓存list*/,jsrList = [] /*接收用户缓存list*/,
                gzrTrueList = [] /*中文关注用户缓存list*/,jsrTrueList = [] /*中文接收用户缓存list*/,
                gzrSubTrueList = [] /*中文关注用户list*/,jsrSubTrueList = [] /*中文接收用户list*/,
                pageType=0 /*页面标签0：任务1：话题*/,pageId /*全局id缓存*/ ,isEdit /*修改禁入标志*/,showId/*显示模块*/;

        var tryCount = 0, fileName, fileObj;//附件上传需要的变量
        var tryQuery = function(obj) {
            setTimeout(function () {
                if (typeof top.fileTypeId !='undefined') {
                    var t_fileId = getGuid();
                    obj.find('.upload-files-show').append('<div><span><i class="icon-paper-clip"></i></span> <span class="file-name">'+fileName+'</span> <span class="file-remove" paramType="add" paramId="'+t_fileId+'">删除</span></div>');
                    obj.find('input[name="upload"]').val('');
                    fileObj = {id:t_fileId,name:fileName};
                    fileList.push(fileObj);
                } else {
                    if(tryCount>15){
                        toast('上传附件服务器未连接').err();
                        return false;
                    }
                    tryQuery(obj);
                    tryCount++;
                }
            }, 80);
        };

        $('.task-end-date').datepicker();

        //设定默认ajax开始和结束时的loading遮罩效果(#post自带,paginglist没有自带)
        $.ajaxSetup({
            beforeSend:showLoading,
            complete:hideLoading
        });

        //生成32位的id
        function getGuid(){
            function S4() {
                return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
            }
            return (S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4());
        }
        //关注人字典
        function queryForFocusUser(){
            $get(focusUserAction,{type:'1,2,3'},function(res){
                $('.focus-user').dict(res.data);
            }, false, false);
        }
        //查询列表 @type 1:话题， 0:任务
        function queryForList(currentPage, type){
            var admin = false, taskFinish = false;
            if(top.roles.select('item=>item.en').indexOf('administrator') > -1){
                admin = true;
            }
            top.registry.feedBack.communicationList = [];
            $('#fb-communicate-query-result').pagingList({
                action: searchAction,
                currentPage: currentPage,
                jsonObj: {
                    type:type
                },
                callback: function(data){
                    var t_c_date, t_m_date; //创建时间 回复时间
                    $('#communicate-list .communicate-rows').template(data, function(item, i){
                        item.replyCount = item.replyCount + ''; //回复数量
                        item.lastReply = item.replyCount == '0' ? null : 'no'; //是否显示最后回复人的信息
                        item.typeCir = item.type == '0' ? 'tasks' : 'list-alt'; //列表区分话题、任务的图标样式
                        item.typeTxt = item.type == '0' ? '任务' : '话题'; //列表区分话题、任务
                        item.ifStick = (item.zdDate == null || item.zdDate.isEmpty()) ? 'no' : 'yes'; //置顶样式
                        item.stickTitle = (item.zdDate == null || item.zdDate.isEmpty()) ? '置顶' : '取消置顶'; //置顶移上去显示的title

                        //发表、回复时间格式修改，显示 年月日 时分  今年的时间不显示年份
                        t_c_date = new Date(item.createDate), t_m_date = new Date(item.lastModifyDate);
                        item.createDateTxt = thisYear == t_c_date.format('YYYY') ? t_c_date.format('MM-DD hh:mm') : t_c_date.format('YYYY-MM-DD hh:mm');
                        item.lastModifyDateTxt = thisYear == t_m_date.format('YYYY') ? t_m_date.format('MM-DD hh:mm') : t_m_date.format('YYYY-MM-DD hh:mm');

                        //任务完成按钮  任务&&(当前用户属于任务的分配者||当前用户是任务的创建者) 显示完成按钮
                        if((item.type == '0' && admin) || (item.type == '0'
                                                            && item.jsr.length > 0
                                                            && (item.jsr.indexOf(localData.get('login-username')) > -1 || item.createPid == localData.get('login-truename')))){
                            item.hi = '1';//显示完成按钮
                            item.ifFinish = item.taskState == '0' ? 'unfinish' : 'finish';   //0表示打开
                            item.ifFinishTxt = item.taskState == '0' ? '完成任务' : '重新打开任务';
                            item.icon = item.taskState == '0' ? 'icon-check-empty' : 'icon-check';  //判断关闭or重新打开按钮样式
                        }

                        //已关闭的任务样式
                        item.line = item.taskState == '0' ? 'unfinish' : 'finish';   //0表示打开

                        //修改和删除权限 本人及管理员角色才能删除
                        if(admin){
                            item.hi2 = '1';
                            item.hi3 = '1';
                        }else{
                            if(item.createPid == localData.get('login-truename')){
                                item.hi2 = '1';
                                item.hi3 = '1';
                            }else{
                                if(deleteLimit){
                                    item.hi3 = '1';
                                }
                                if(editLimit){
                                    item.hi2 = '1';
                                }
                            }
                        }

                        if(item.fileList.length > 0){
                            item.attachShow = '1';  //是否存在附件 图标是否显示
                        }

                        top.registry.feedBack.communicationList.push(item);
                    });
                }
            });
        }
        //进入发起话题页面
        function intoAddTopic(){
            isEdit = false;
            gzrList =[];
            gzrTrueList = [];
            gzrSubTrueList = [];
            gzrSubList = [];
            jsrSubTrueList = [];
            //进入页面之前将页面中input的值置空
            $('#add-topic-form input').val('');

            //移除必填项
            $('#add-topic-form .validate').removeClass('validatebox-invalid');
            //ckeditor移除必填项判断样式
            $('#cke_add-topic-textarea').removeClass('validatebox-invalid');

            $open('#add-topic-div', {width: 920, title: '发起话题'});

            //右上角下拉列表样式修改
            $('.add-down').removeClass('down-hide').addClass('down-show');
            $('.add-ul').addClass('hide');

            //ckEditor加载到editor
            if(typeof addEditor == 'undefined'){
                addEditor = CKEDITOR.replace('add-topic-textarea');
                CKEDITOR.instances['add-topic-textarea'].on('change', function() {
                    copyImgUpload(addEditor);
                });
            }else{
                addEditor.setData('');
            }
            inputPerson('gzrList-add')
        }
        //新增保存话题
        function saveTopic(){
            var formObj = $('#add-topic-form');
            var saveObj;

            formObj.find('.validate').validatebox();

            //对ckeditor必填项特殊处理
            if(addEditor.getData().isEmpty()){
                $('#cke_add-topic-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_add-topic-textarea').removeClass('validatebox-invalid');
            }
            if(formObj.find('.validatebox-invalid').length > 0){
                return false;
            }

            //传入后台的数据
            saveObj = {
                type: '1',
                title: formObj.find('input[name="title"]').val(),
                content: addEditor.getData(),
                gzr: gzrSubList
            };


            $post(saveAction,saveObj,function(res){
                closeWin('add-topic-div');
                toast('话题保存成功！').ok();
                queryForList(null,pageType);
            }, true);
        }
        //进入新增任务页面
        function intoAddTask(){
            isEdit = false;
            jsrList = [];
            jsrTrueList = [];
            jsrSubList = [];
            jsrSubTrueList = [];
            gzrList = [];
            gzrTrueList = [];
            gzrSubTrueList = [];
            gzrSubList = [];
            var taskFormObj = $('#add-task-form'), uploadFormObj = $('#upload-form');
            taskFormObj.find('input').val('');
            taskFormObj.find('textarea').val('');
            uploadFormObj.find('input').val('');
            uploadFormObj.find('.upload-files-show').empty();
            fileList = [];//清空存放附件对象的数组
            addTaskId = getGuid();//生成新增任务的id
            uploadFormObj.attr('action', fileUploadPath + '&typeId=' + addTaskId);

            taskFormObj.find('.validate').removeClass('validatebox-invalid');
            //ckeditor移除必填项判断样式
            $('#cke_add-task-textarea').removeClass('validatebox-invalid');
            $open('#add-task-div', {width: 920, title: '新增任务'});

            //右上角下拉列表样式修改
            $('.add-down').removeClass('down-hide').addClass('down-show');
            $('.add-ul').addClass('hide');

            //ckEditor加载到editor
            if(typeof addTaskEditor == 'undefined'){
                addTaskEditor = CKEDITOR.replace('add-task-textarea');
                CKEDITOR.instances['add-task-textarea'].on('change', function() {
                    copyImgUpload(addTaskEditor);
                });
            }else{
                addTaskEditor.setData('');
            }

            inputPerson('gzrList-add-task');
            inputPerson('gzrList-add-ht');
        }
        //新增保存任务
        function saveTask(){
            var taskFormObj = $('#add-task-form');
            var saveTaskObj;

            //必填项判断
            taskFormObj.find('.validate').validatebox();

            //对ckeditor必填项特殊处理
            if(addTaskEditor.getData().isEmpty()){
                $('#cke_add-task-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_add-task-textarea').removeClass('validatebox-invalid');
            }

            if(taskFormObj.find('.validatebox-invalid').length > 0){
                return false;
            }

            //传入后台的数据
            saveTaskObj = {
                id: addTaskId,
                type: '0',
                title: taskFormObj.find('input[name="title"]').val(),
//                content: taskFormObj.find('textarea[name="content"]').val(),
                content: addTaskEditor.getData(),
                jsr: jsrSubList,
                gzr: gzrSubList,
                endDate: taskFormObj.find('input[name="endDate"]').val(),
                addFileList: fileList  //文件上传数组
            };

            $post(saveAction,saveTaskObj,function(res){
                closeWin('add-task-div');
                toast('任务保存成功！').ok();
                queryForList(null,pageType);
            }, true);

        }
        //进入话题修改页面
        function intoEditTopic(id){
            isSave = 0;
            isEdit = true;
            var editTopicForm = $('#edit-topic-form');

            editTopicForm.find('.validate').removeClass('validatebox-invalide');
            //ckeditor移除必填项判断样式
            $('#cke_edit-topic-textarea').removeClass('validatebox-invalid');

            $open('#edit-topic-div', {width: 920, title: '修改话题'});

            top.registry.feedBack.communicationList.each(function(o, i){
                if(id == o.id){
                    //设置话题内容的值
                    if(typeof editEditor == 'undefined'){
                        editEditor = CKEDITOR.replace('edit-topic-textarea');
                        CKEDITOR.instances['edit-topic-textarea'].on('change', function() {
                            copyImgUpload(editEditor);
                        });
                        editEditor.setData(o.content);
                    }else{
                        editEditor.setData(o.content);
                    }
                    editTopicForm.find('input[name="editId"]').val(o.id);
                    editTopicForm.find('input[name="title"]').val(o.title);
                    gzrList = o.gzr.concat();
                    gzrSubList = o.gzr.concat();
                    gzrTrueList = o.gzrName.concat();//关注人中文名
                    gzrSubTrueList = o.gzrName.concat();//关注人中文名
                    oldTaskGzr = o.gzr.join();
                    inputPerson('gzrList-edit');
                    return false;
                }
            });
            pageId = id
        }
        //话题修改保存
        function updateTopic(){
            var editTopicForm = $('#edit-topic-form');
            var updateTopicObj;

            //必填项判断
            editTopicForm.find('.validate').validatebox();
            //对ckeditor必填项特殊处理
            if(editEditor.getData().isEmpty()){
                $('#cke_edit-topic-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_edit-topic-textarea').removeClass('validatebox-invalid');
            }
            if(editTopicForm.find('.validatebox-invalid').length > 0){
                return false;
            }

            updateTopicObj = {
                id: editTopicForm.find('input[name="editId"]').val(),
                title: editTopicForm.find('input[name="title"]').val(),
                content: editEditor.getData(),
                gzr: gzrSubList,
                type:'1',
                oldGzr:oldTaskGzr.split(',')
            };

            $post(updateAction, updateTopicObj, function(res){
                closeWin('edit-topic-div');
                toast('话题修改成功！').ok();
                queryForList($('.paging').data('currentPage'),pageType);
            }, true);

        }
        //进入任务修改
        function intoEditTask(id){
            isSave = 0;
            isEdit = true;

            var editTaskForm = $('#edit-task-form'), uploadFormObj = $('#edit-upload-form');

            editTaskForm.find('.validate').removeClass('validatebox-invalid');
            //ckeditor移除必填项判断样式
            $('#cke_edit-task-textarea').removeClass('validatebox-invalid');

            $open('#edit-task-div', {width: 920, title: '修改任务'});

            uploadFormObj.find('input').val('');
            uploadFormObj.find('.upload-files-show').empty();
            fileList = [];//清空存放附件对象的数组
            uploadFormObj.attr('action', fileUploadPath + '&typeId=' + id);


            top.registry.feedBack.communicationList.each(function(o, i){
                if(id == o.id){
                    editTaskForm.find('input[name="editId"]').val(o.id);
                    editTaskForm.find('input[name="title"]').val(o.title);
                    //设置任务内容的值
                    if(typeof editTaskEditor == 'undefined'){
                        editTaskEditor = CKEDITOR.replace('edit-task-textarea');
                        CKEDITOR.instances['edit-task-textarea'].on('change', function() {
                            copyImgUpload(editTaskEditor);
                        });
                        editTaskEditor.setData(o.content);
                    }else{
                        editTaskEditor.setData(o.content);
                    }
//                    editTaskForm.find('textarea[name="content"]').val(o.content);
                    jsrList = o.jsr.concat();//分配者英文
                    jsrSubList = o.jsr.concat();//分配者英文
                    jsrTrueList = o.jsrName.concat();//分配者中文
                    jsrSubTrueList = o.jsrName.concat();//关注人中文名
                    gzrList = o.gzr.concat();//关注者英文
                    gzrSubList = o.gzr.concat();//关注者英文
                    gzrTrueList = o.gzrName.concat();//关注者中文
                    gzrSubTrueList = o.gzrName.concat();//关注人中文名
                    editTaskForm.find('input[name="endDate"]').val(o.endDate);//截止时间

                    oldTaskGzr = o.gzr.join();
                    oldTaskJsr = o.jsr.join();

                    $('#edit-upload-files-show').template(o.fileList);
                }
                pageId=id;
                return false;
            });
            inputPerson('gzrList-edit-task');
            inputPerson('gzrList-edit-ht');
        }
        //任务修改保存
        function updateTask(){
            var updateTaskForm = $('#edit-task-form');
            var updateTaskObj;

            //必填项验证
            updateTaskForm.find('.validate').validatebox();
            //对ckeditor必填项特殊处理
            if(editTaskEditor.getData().isEmpty()){
                $('#cke_edit-task-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_edit-task-textarea').removeClass('validatebox-invalid');
            }

            if(updateTaskForm.find('.validatebox-invalid').length > 0){
                return false;
            }

            //
            updateTaskObj = {
                id: updateTaskForm.find('input[name="editId"]').val(),
                title: updateTaskForm.find('input[name="title"]').val(),
//                content: updateTaskForm.find('textarea[name="content"]').val(),
                content: editTaskEditor.getData(),
                jsr: jsrSubList,
                gzr: gzrSubList,
                endDate: updateTaskForm.find('input[name="endDate"]').val(),
                type:'0',
                oldGzr: oldTaskGzr.split(','),
                oldJsr: oldTaskJsr.split(','),
                deleteFileId:deleteIds,
                addFileList:fileList
            };

            $post(updateAction, updateTaskObj, function(res){
                closeWin('edit-task-div');
                toast('任务修改成功！').ok();
                queryForList($('.paging').data('currentPage'),pageType);
            }, true);
        }
        //删除话题or任务
        function deleteCommunication(id,type,title){
            var rwType;
            if(type == '0'){
                rwType = '任务';
            }else{
                rwType = '话题';
            }
            $confirm('确定删除'+rwType+'【'+title+'】这条数据吗？', function(bol){
                if(bol){
                    $post(deleteAction,{id:id},function(res){
                        toast('删除成功！').ok();
                        queryForList($('.paging').data('currentPage'),pageType);
                    });
                }
            });
        }
        //置顶or取消置顶 @type 1:置顶，0：取消置顶
        function stickOpt(type,id){
            $post(stickAction, {stickType:type,id:id}, function(res){
                queryForList(null,pageType);
                type == '1' ? toast('已置顶').ok() : toast('已取消置顶').ok();
            }, false, false);
        }
        //进入查看和评论页面
        function intoTopicTaskView(id){
            ifReply = false; //每次进入页面 重置为false
            var commentsDiv = $('#topic-task-comments');
            $open('#topic-task-view-div', {width: 800, title: '查看评论页面', onClose:function(){if(ifReply){queryForList($('.paging').data('currentPagr'), pageType);}}});
            commentsDiv.find('textarea').css('border', 'none').removeClass('validatebox-invalid').val('');

            top.registry.feedBack.communicationList.each(function(o, i){
                if(id == o.id){

                    topicOrTaskId = id; //保存任务or话题的id

                    var jsrLength, gzrLength;
                    $('#topic-task-content').template(o, function(item, i){
                        item.file = item.fileList.length > 0 ? "1" : null;   //判断是否存在需要下载的文件
                    });
                    $('#topic-task-content .content').html(o.content);
                    $('#topic-task-members').template(o, function(item, i){
                        jsrLength = item.jsrName.length;
                        gzrLength = item.gzrName.length;
                        //接收人
                        if(jsrLength > 0){
                            item.jsrList = [];
                            for(var j = 0; j < jsrLength; j++){
                                item.jsrList[j] = {};
                                item.jsrList[j].name = item.jsrName[j];
                            }
                        }
                        //关注人
                        if(gzrLength > 0){
                            item.gzrList = [];
                            for(var j = 0; j < gzrLength; j++){
                                item.gzrList[j] = {};
                                item.gzrList[j].name = item.gzrName[j];
                            }
                        }
                        //分配者和关注者的不同显示
                        if(item.type == '1'){  //表示话题
                            item.showTopic = '1';  //显示话题的关注人
                        }else{
                            item.showTask = '1';  //显示任务的分配者和关注者
                        }
                    });
                    queryComments();
                    return false;
                }
            });
        }
        //查询所有评论
        function queryComments(){
            $post(searchCommentsAction, {id:topicOrTaskId}, function(res){
                var t_date, t_c_date;
                $('#comments-dl').template(res.data, function(item, i){
                    t_date = new Date(item.createDateStr);
                    item.createDateStrTxt = thisYear == t_date.format('YYYY') ? t_date.format('MM-DD hh:mm') : t_date.format('YYYY-MM-DD hh:mm');
                    item.replyList.each(function(o, j){
                        t_c_date = new Date(o.createDateStr);
                        o.createDateStrTxt = thisYear == t_c_date.format('YYYY') ? t_c_date.format('MM-DD hh:mm') : t_c_date.format('YYYY-MM-DD hh:mm');
                    });
                });
            },true,false);
        }
        //评论or回复   @id 话题or任务的id，，@replyId 评论的id，，@content 评论or回复的内容
        function replyOpt(id, replyId, content){
            $post(replyAction, {id:id, replyId:replyId, replyContent:content}, function(res){
                ifReply = true;
                var textareaObj = $('#topic-task-comments textarea');
                textareaObj.val('');//所有评论、回复的textarea值置空
                textareaObj.css('border', 'none').removeClass('validatebox-invalid');
                queryComments();
//                $('#comments-dl').template(res.data);
            }, true, false);
        }
        //完成or取消完成 @type 1:关闭 0:打开 @id 任务的id
        function finishOpt(type, id){
            $post(finishAction, {taskState:type, id:id}, function(res){
                queryForList($('.paging').data('currentPage'),pageType);
                type == '1' ? toast('已完成任务').ok() : toast('已重新打开任务').ok();
            }, false, false);
        }
        //选取不同tab页需要执行的方法  @type 1:话题 topic-tab, 0:任务 task-tab
        function switchTab(type){
            var tabs = $('.task-topic-tabs'), addBtns = $('#add-btns');
            var tabName;
            if(type == '1'){
                tabName = '.topic-tab';
                addBtns.find('.topic-btn').removeClass('hide');
                addBtns.find('.task-btn').addClass('hide');
            }else if(type == '0'){
                tabName = '.task-tab';
                addBtns.find('.task-btn').removeClass('hide');
                addBtns.find('.topic-btn').addClass('hide');
            }
            tabs.find('div').removeClass('current-tab');
            tabs.find(tabName).addClass('current-tab');
            pageType = type;
            queryForList(null, type);
        }
        //文件上传
        function fileUpload(form){
            var inputObj = form.find('input[name="upload"]');
            var fileNameObj = form.find('.upload-files-show').find('.file-name');
            var t_fileName = [];

            if(!inputObj.val().isEmpty()){

                fileName = inputObj.val().split('\\')[inputObj.val().split('\\').length-1];

                fileNameObj.each(function(i){
                    t_fileName.push($(this).text());
                });

                if(t_fileName.length > 0 && t_fileName.indexOf(fileName) > -1){
                    inputObj.val('');
                    form.find('.exist-judge').fadeIn(); setTimeout(function(){form.find('.exist-judge').fadeOut();}, 1500);
                }else{
                    form.submit();
                    tryQuery(form);
                }
            }
        }
        //关闭窗口
        function closeWin(id){
            $('#'+id).$close();
            $('.validate').removeClass('validatebox-invalid');
        }
        //获取用户列表
        function serachUserName(id,type){
            var userName = $('#choose-tGzr').val();
            if(oldInput == userName){
                return;
            }
            oldInput = userName;
            $post(searchUserNameAction, {userName:userName,id:id}, function(res){
                var t_data = [];
                for(var i=0;i<res.data.length;i++){
                    t_data[i] = {};
                    t_data[i].name = res.data[i].VALUE;
                    t_data[i].key = res.data[i].KEY;
                }
                $('#communicate-choose .user-rows').template(t_data, function(item, i){
                    item.trueName= item.name;
                    item.userName= item.key;
                    item.iconId = 'icon-edit-'+i;
                    if(type) {//修改
                        item.id = id;
                        for (var n = 0; n < top.registry.feedBack.communicationList.length; n++) {
                            if (id == top.registry.feedBack.communicationList[n].id) {
                                if(isJsr) {
                                    if(isSave==0){
                                        jsrList = top.registry.feedBack.communicationList[n].jsr.concat();
                                    }else{
                                        jsrList = jsrSubList;
                                    }
                                    if(jsrList.length==0){
                                        item.icon = 'hidden';
                                        item.ifSelect = 'unselect';
                                    }
                                    for (var j = 0; j < jsrList.length; j++) {
                                        if (item.userName == jsrList[j]) {
                                            item.icon = 'icon-ok';
                                            item.ifSelect = 'select';
                                            break;
                                        } else {
                                            item.icon = 'hidden';
                                            item.ifSelect = 'unselect';
                                        }
                                    }
                                }else{
                                    if(isSave==0){
                                        gzrList = top.registry.feedBack.communicationList[n].gzr.concat();
                                    }else{
                                        gzrList = gzrSubList;
                                    }
                                    if(gzrList.length==0){
                                        item.icon = 'hidden';
                                        item.ifSelect = 'unselect';
                                    }
                                    for (var j = 0; j < gzrList.length; j++) {
                                        if (item.userName == gzrList[j]) {
                                            item.icon = 'icon-ok';
                                            item.ifSelect = 'select';
                                            break;
                                        } else {
                                            item.icon = 'hidden';
                                            item.ifSelect = 'unselect';
                                        }
                                    }
                                }
                            }
                        }
                    }else{//新增
                        if(isJsr){//接收人选择处理
                            if(jsrList.length==0){
                                item.ifSelect = 'unselect';
                                item.icon = 'hidden';
                                return;
                            }
                            for (var j = 0; j < jsrList.length; j++) {
                                if (item.userName == jsrList[j]) {
                                    item.icon = 'icon-ok';
                                    break;
                                } else {
                                    item.icon = 'hidden';
                                }
                            }
                            if (item.icon == 'icon-ok') {
                                item.ifSelect = 'select';
                            } else {
                                item.ifSelect = 'unselect';
                            }
                        }else{//关注人选择处理
                            if(gzrList.length==0){
                                item.ifSelect = 'unselect';
                                item.icon = 'hidden';
                                return;
                            }
                            for (var j = 0; j < gzrList.length; j++) {
                                if (item.userName == gzrList[j]) {
                                    item.icon = 'icon-ok';
                                    break;
                                } else {
                                    item.icon = 'hidden';
                                }
                            }
                            if (item.icon == 'icon-ok') {
                                item.ifSelect = 'select';
                            } else {
                                item.ifSelect = 'unselect';
                            }
                        }
                    }
                });
            }, false, false);
        }
        //变更关注人和接收人
        function changeUserNameToList(userName,trueName,id){
            if(byid(id).className=='icon-ok') {
                if(isJsr) {
                    for (var i = 0; i < jsrList.length; i++) {
                        if (userName == jsrList[i]) {
                            jsrList.remove(i);
                            jsrTrueList.remove(i);
                        }
                    }
                }else{
                    for (var i = 0; i < gzrList.length; i++) {
                        if (userName == gzrList[i]) {
                            gzrList.remove(i);
                            gzrTrueList.remove(i);
                        }
                    }
                }
                $('#' + id).removeClass('icon-ok').addClass('hidden');
            }else{
                if(isJsr){
                    jsrList.push(userName);
                    jsrTrueList.push(trueName);
                }else{
                    gzrList.push(userName);
                    gzrTrueList.push(trueName);
                }
                $('#' + id).removeClass('hidden').addClass('icon-ok');
            }
        }
        //id:人员id ,type：true 话题   false 任务 ,jsFlag：true 接收人  false 关注人
        function chooseGzrInfo(jsFlag,id){
            oldInput = "   ";
            showId= id;
            $('#choose-tGzr').val('');
            isJsr = jsFlag;
            var type = isEdit;
            serachUserName(pageId,type);
            $open('#topic-task-choose-div', {width: 235, title: '选择用户',mask:'no-top'});
            $('#choose-tGzr').focus();
        }
        //提交人员选择
        function submitChoosePerson(){
            gzrSubList = gzrList;
            jsrSubList = jsrList;
            jsrSubTrueList = jsrTrueList;
            gzrSubTrueList = gzrTrueList;
            isSave = 1;
            inputPerson('000')
            closeWin('topic-task-choose-div');
        }
        //关注人、分配者选择后显示数据拼接
        function inputPerson(id){
            if(id=='000'){
                id = showId;
            }
            $('#'+id).addClass('hide');
            var t_data = {};
            if(id=='gzrList-edit-task'||id=='gzrList-add-task'){
                t_data.jsrList = [];
                for(var i=0;i<jsrSubTrueList.length;i++){
                    t_data.jsrList[i]={};
                    t_data.jsrList[i].name=jsrSubTrueList[i];
                }
                if(jsrSubTrueList.length>0){
                    $('#'+id).removeClass('hide');
                }
            }else {
                t_data.gzrList = [];
                for(var i=0;i<gzrSubTrueList.length;i++){
                    t_data.gzrList[i]={};
                    t_data.gzrList[i].name=gzrSubTrueList[i];
                }
                if (gzrSubTrueList.length > 0) {
                    $('#' + id).removeClass('hide');
                }
            }
            $('#'+id).template(t_data);
        }


        //字典初始化
        queryForFocusUser();
        //默认进入的时候，查询所有任务
        queryForList(null, '0');

        //注册任务、话题tab页切换的点击事件
        $('.task-topic-tabs').on('click', '.topic-tab', function(){
            switchTab('1'); //查询话题
        }).on('click', '.task-tab', function(){
            switchTab('0'); //查询任务
        });

        $('#add-btns').on('click', '.down-show', function(){ //点击显示下拉列表
            $('#add-btns .add-ul').removeClass('hide');
            $(this).removeClass('down-show').addClass('down-hide');
        }).on('click', '.down-hide', function(){ //点击隐藏下拉列表
            $('#add-btns .add-ul').addClass('hide');
            $(this).removeClass('down-hide').addClass('down-show');
        });

        $('.add-topic').on('click', function(){
            intoAddTopic();
        });
        $('.add-task').on('click', function(){
            intoAddTask();
        });

        $('#save-topic').on('click', function(){
            saveTopic();
        });
        $('#add-topic-cancel').on('click', function(){
            closeWin('add-topic-div');
        });

        $('#save-task').on('click', function(){
            saveTask();
        });
        $('#add-task-cancel').on('click', function(){
            closeWin('add-task-div');
        });

        $('#communicate-list').on('click', '.into-edit-communication', function(){
            var type = this.getAttribute('param');
            //type==1表示话题
            if(type == '1'){
                intoEditTopic(this.getAttribute('paramId'));
            }else if(type == '0'){
                intoEditTask(this.getAttribute('paramId'));
            }
        }).on('click', '.delete-communication', function(){
            deleteCommunication(this.getAttribute('paramId'),this.getAttribute('paramType'),this.getAttribute('paramTitle'));
        }).on('click', '.stick-no', function(){ //未置顶，点击置顶
            stickOpt('1',this.getAttribute('paramId')); //1表示置顶
        }).on('click', '.stick-yes', function(){ //已经置顶，点击取消置顶
            stickOpt('0',this.getAttribute('paramId')); //0表示取消置顶
        }).on('click', '.a-topic-task-title', function(){
            intoTopicTaskView(this.getAttribute('paramId'));
        }).on('click', '.unfinish', function(){//未关闭，点击关闭任务
            finishOpt('1', this.getAttribute('paramId')); //1表示关闭任务
        }).on('click', '.finish', function(){//关闭，点击打开任务
            finishOpt('0', this.getAttribute('paramId')); //0表示打开任务
        });

        $('#update-topic').on('click', function(){
            updateTopic();
        });
        $('#edit-topic-cancel').on('click', function(){
            closeWin('edit-topic-div')
        });

        $('#update-task').on('click', function(){
            updateTask();
        });
        $('#edit-task-cancel').on('click', function(){
            closeWin('edit-task-div');
        });

        $('#communicate-choose').on('click', '.unselect', function(){
            changeUserNameToList(this.getAttribute('paramName'),this.getAttribute('paramTrueName'),this.getAttribute('paramIcon'));
        }).on('click', '.select', function(){
            changeUserNameToList(this.getAttribute('paramName'),this.getAttribute('paramTrueName'),this.getAttribute('paramIcon'));
        });

        $('#topic-task-view-div').on('mouseenter', '.md', function(){
            $(this).find('.reply').removeClass('hide');
        }).on('mouseleave', '.md', function(){
            $(this).find('.reply').addClass('hide');
        }).on('click', '.reply', function(){
            var replyInputDiv = $(this).parent().parent().next().find('.mc-reply-input-div');
            replyInputDiv.removeClass('hide');
            replyInputDiv.find('.reply-detail').focus();
        }).on('blur', '.reply-detail', function(){
            var replyContent = this.value;
            if(replyContent == null || replyContent.isEmpty()){
                $(this).parent().addClass('hide');
                $('#topic-task-comments textarea').css('border', 'none').removeClass('validatebox-invalid');
            }
        }).on('click', '.save-comment', function(){
            var t_area = $('#comment-detail'), t_form = $('#comment-form');
            t_form.find('.validate').validatebox();
            if(t_form.find('.validatebox-invalid').length > 0){
                return false;
            }
            /*if(t_area.val().isEmpty()){
                t_area.css('border', '1px solid').addClass('validatebox-invalid');
                t_area.focus();
                return false;
            }*/
            replyOpt(topicOrTaskId, '', t_area.val());

        }).on('click', '.report-btn-div .cm-save-btn', function(){
            var t_area =  $(this).parent().prev('textarea'), t_div = $(this).parents('.mc-reply-input-div');
            if(t_area.val().isEmpty()){
                t_area.css('border', '1px solid').addClass('validatebox-invalid');
                t_area.focus();
                return false;
            }else{
                t_div.find('.validate').validatebox();
                if(t_div.find('.validatebox-invalid').length > 0){
                    return false;
                }
            }
            replyOpt(topicOrTaskId, $(this).parents('.mc').attr('paramId'), t_area.val());

        });
        $('#topic-task-cancel').on('click', function(){
            if(ifReply) {
                queryForList($('.paging').data('currentPage'), pageType);
            }
            closeWin('topic-task-view-div');
        });

        //新增页面附件上传
        $('#upload-form').on('change', 'input[name="upload"]', function(){
            var form = $('#upload-form');
            fileUpload(form);
        });
        //修改页面附件上传
        $('#edit-upload-form').on('change', function(){
            var form = $('#edit-upload-form');
            fileUpload(form);
        });
        //新增页面 附件删除
        $('#add-task-div').on('click', '.file-remove', function(){
            $(this).parent().remove();
            fileList.splice(fileList.select('item=>item.id').indexOf(this.getAttribute('paramId')), 1);
        });
        //修改页面附件删除
        $('#edit-task-div').on('click', '.file-remove', function(){
            var id = this.getAttribute('paramId');
            var type = this.getAttribute('paramType');
           $(this).parent().remove();
            if(type != null && type == 'add'){ //表示重新上传的附件，type='add'
                fileList.splice(fileList.select('item=>item.id').indexOf(this.getAttribute('paramId')), 1);
            }else{
                deleteIds.push(id);
            }
        });
        //查看页面下载附件
        $('#topic-task-content').on('click', '.file-download', function(){
            location.href=action2link(fileDownloadPath + topicOrTaskId+'/' + this.getAttribute('paramName') + '');
        });

        //选择关注人和接收人
        $('.communicate-attention-user').on('click', '.items-plus', function(){
            chooseGzrInfo(false,this.getAttribute('paramId'));//关注人
        }).on('click', '.items-plus-task', function(){
            chooseGzrInfo(true,this.getAttribute('paramId'));//接收人
        });
        $('#choose-tGzr').on('keyup',function(){
            serachUserName(null,false);
        });

        $('#sure-choose-btn').on('click', function(){
            submitChoosePerson();
        });
    });
</script>
</html>