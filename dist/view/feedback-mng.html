<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta name="author" content="xiaohuiwen" />
    <meta name="date" content="2016-06-21 09:33:01" />
    <title>反馈共享</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/feedback.css"/>
</head>
<body>
    <div class="query-condition mt10">
        <div class="query-condition-p">
            <span class="common-field w65">项目单位：</span>
            <dict dict-type="tree" dict-id="fkdwdmdict" dict-name="fkdwdm" id="fkdwdm" dict-root="custom" class="xmdwdm dict"></dict>
            <span class="common-field w100">问题类别：</span>
            <dict dict-type="select" dict-root="wtlxdm" dict-id="wtlxdmdict" id ="wtlxdm" dict-name="wtlxdm" empty="true" ></dict>
            <span class="common-field w100">处理状态：</span>
            <dict dict-type="select" dict-root="clztdm" dict-id="clztdmdict" id="clztdm" dict-name="clztdm" empty="true" class="mr15"></dict>
            <p class="query-reset">
                <b class="cm-query-btn" id="cm-query-btn-fkxx"></b>
                <b class="cm-reset-btn" id="reset-btn-fkxx"></b>
            </p>
        </div>
        <div class="query-condition-p">
            <span class="common-field w65">反馈时间：</span>
            <input id="fksjStart" type="text" class="query-date"/>~<input id="fksjEnd" type="text" class="query-date mr15"/>
        </div>
    </div>
    <div id="fkxx-query-result">
        <div class="new-color-bar">
            <span class="title">反馈信息列表（共找到<span class="total-count"></span>条数据）</span>
        </div>
        <table id="implement-fkxx-table" class="typical-tb" cellpadding="3">
            <thead>
            <th width="5%">序号</th>
            <th width="15%">反馈单位</th>
            <th width="30%">反馈内容</th>
            <th width="8%" sort-name="FKSJ" >反馈日期</th>
            <th width="8%">问题类别</th>
            <th width="8%">处理状态</th>
            <th width="8%">处理人</th>
            <th width="8%" sort-name="CLSJ" >处理日期</th>
            <th >操作</th>
            </thead>
            <tbody tpsource="#implement-fkxx-list"></tbody>
        </table>
        <div class="paging"></div>
    </div>
</body>
<script type="text/template" id="implement-fkxx-list">
    <tr>
        <td>{rn}</td>
        <td>{fkdwmc}</td>
        <td>
            <p class="brief-content tleft" readonly>{fknr}</p>
            <a class="more-a" href="javascript:void(0);" moreId="{id}u">更多</a>
        </td>
        <td>{fksj}</td>
        <td>{wtlxdm}</td>
        <td>{clztdm}</td>
        <td>{clr}</td>
        <td>{clsj}</td>
        <td class="fkxx-btns-cell">
            <a href="javascript:void(0)" class="view-fkxx icon-show-btn " title="查看" param="{id}" picId="{pictureId}"></a>
            {{this.edit && #<a href="javascript:void(0)" id="handel{id}" class="handle-fkxx icon-edit-btn" param="{id}" picId="{pictureId}" title="处理"></a>#}}
        </td>
    </tr>
</script>
<script src="../js/base.js?version=0.99"></script>
<script src="../js/feedback.js?version=0.99"></script>
<script>

    var pxqkPageData;//页面数据
    var initPageDateAction = top.path + '/api/0/feedback/userfeed/list',
        queryPageDataAction = top.path + '/api/1/feedback/userfeed/list';
    var editLimit=top.ops['feedback-mng-handl'],//权限控制
        viewLimit=top.ops['feedback-mng-view'];

    importing('datepicker','dict',function(){
        var xmdwAction = top.path + '/api/0/basic/project/project_unit';
        $('.query-date').datepicker();
        $('#wtlxdm').dict();
        $('#clztdm').dict();

        //项目单位
        function queryForXmdw(){
            $get(xmdwAction,{},function(res){
                $('.xmdwdm').dict(res.data.unitInfo);
            });
        }

        //重置
        function resetQuerycondition(){
            $('#fkdwdmdict').val('');
            $('#fkdwdmdict_displayValue').val('');
            $('#wtlxdmdict').val('');
            $('#clztdmdict').val('');
            $('#fksjEnd').val('');
            $('#fksjStart').val('');
        }

        //处理用户反馈信息
        function editFeedBack(id){
            var editWin = $open('feedback-mng-edit.html', {width: 800, title: '反馈信息处理'},true,function () {
                intoEditFeedBack(id,editWin,"fkxx",$('.paging').data('currentPage'))
            });
        }

        //查看用户反馈信息
        function viewFeedBack(id){
            var viewWin=$open('feedback-mng-view.html', {width: 800, title: '反馈信息查看'},true,function (){
                intoViewFeedBack(id,viewWin)
            });
        }

        //关闭窗口
        function commCloseWin(id){
            $('#'+id).$close();
        }

        queryForXmdw();

        queryPageData(true);

        //注册事件
        $('#cm-query-btn-fkxx').on('click',function(){
            if($('.sort-arrow')) $('.sort-arrow').remove();
            queryPageData(false);
        });
        $('#reset-btn-fkxx').on('click',function(){
            resetQuerycondition();
        });
        $('#implement-fkxx-table').on('click','.handle-fkxx:not(.hide)',function(){
            editFeedBack(this.getAttribute('param'),this.getAttribute('picId'));
        }).on('click','.view-fkxx:not(.hide)',function(){
            viewFeedBack(this.getAttribute('param'),this.getAttribute('picId'));
        });
    });

    //查询
    function queryPageData(type,currentPage){
        var roles = '0';
        for(var i=0;i<top.roles.length;i++){
            if(top.roles[i].en=="administrator"||top.roles[i].en==null){
                roles = '1';
                break;
            }
        }
        var action ;
        var t_beginDate = $('#fksjStart').val();
        var t_endDate = $('#fksjEnd').val();
        if(!t_beginDate.isEmpty() && !t_endDate.isEmpty() && t_beginDate > t_endDate){
            toast('反馈时间开始时间不能大于结束时间！').css('width','300px').err();
            return false;
        }
        if(type){
            action = initPageDateAction;
        }else{
            action = queryPageDataAction;
        }
        $('#fkxx-query-result').pagingList({
            action: action,
            currentPage:currentPage,
            jsonObj: {
                fkdwdm: $('#fkdwdmdict').val(),
                wtlxdm: $('#wtlxdmdict').val(),
                clztdm: $('#clztdmdict').val(),
                fksjStart: $('#fksjStart').val(),
                fksjEnd: $('#fksjEnd').val(),
                type:roles,
            },
            callback: function (data) {
                pxqkPageData = data;
                $('#wtlxdm').addClass("w100");
                $('#clztdm').addClass("w100");
                $('#implement-fkxx-table tbody').fixData({view:viewLimit,edit:editLimit}).template(data);
                showHandel();
                //内容在4行内的不显示“更多”
                isShowMore2();
            }
        });
    }

    //显示未处理的节点
    function showHandel(){
        for(var i=0;i<pxqkPageData.length;i++){
            if(''!=pxqkPageData[i].clsj&&null!=pxqkPageData[i].clsj){
                $('#handel'+pxqkPageData[i].id).addClass("hide");
            }
        }
    }

</script>
</html>