<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>案例情况维护</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/ptcg.css">
</head>
<body>

<div id="word-image-upload" style="display: none"></div>

<div class="query-condition">
    <div class="query-condition-p">
        <span class="common-field w65">项目单位：</span><div dict-id="query-xmdwdm" dict-name="xmdwdm" dict-type="tree" dict-root="custom" class="xmdwdm dict"></div>
        <span class="common-field w80">共享者：</span><div dict-id="query-gxr" dict-name="gxr" dict-type="select" dict-root="custom" class="gxr dict mr15"></div>
        <span class="common-field w65">共享日期：</span><input id="gxDateBegin" type="text" class="query-date"/>~<input id="gxDateEnd" type="text" class="query-date mr15"/>
        <p class="query-reset">
            <b id="case-query-btn" class="cm-query-btn"></b>
            <b id="case-reset-btn" class="cm-reset-btn"></b>
        </p>
    </div>
    <div class="query-condition-p">
        <span class="common-field w65">关键字：</span><input id="gjz" type="text" class="common-input"/>
    </div>
</div>
<div id="case-query-result">
    <div class="new-color-bar">
        <span class="title">案例情况列表（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div">
            <b id="into-case-add" class="cm-add-btn hidePlus"></b>
        </div>
    </div>
    <table id="case-table" class="typical-tb" cellpadding="3">
        <thead>
        <th width="5%">序号</th>
        <th width="15%">项目代码</th>
        <th width="15%">项目单位</th>
        <th width="25%">案例标题</th>
        <th width="10%">共享者</th>
        <th width="15%" sort-name="createDateStr">共享日期</th>
        <th width="15%">操作</th>
        </thead>
        <tbody tpsource="#case-list"></tbody>
    </table>
    <div class="paging"></div>
</div>
<div id="case-add-div" class="hide">
    <form id="case-add-form">
        <input type="hidden" name="alnr"/>
        <input type="hidden" name="xmdwmc"/>
        <p class="mt10">
            <span class="common-field"><span class="orangered">★ </span>案例标题：</span>
            <input id="add-albt" name="albt" class="case-add-valid common-input mr100" type="text" data-options="required:true"/>
            <span class="common-field"><span class="orangered">★ </span>项目单位：</span>
            <dict dict-id="add-xmdwdm" dict-name="xmdwdm" dict-type="tree" dict-root="custom" class="xmdwdm dict"></dict>
        </p>
        <p class="mt10">
            <span class="common-field"><span class="orangered">★ </span>共享人：</span>
            <dict dict-id="add-gxr" dict-name="algxr" dict-type="select" dict-root="custom" class="gxr dict mr100"></dict>
            <!--<span class="common-field"><span class="orangered">★ </span>共享日期：</span>-->
            <!--<input id="add-create-date" name="createDateStr" class="case-add-valid query-date" type="text" data-options="required:true"/>-->
        </p>
        <p class="mt10">
            <span class="common-field fl"><span class="orangered">★ </span>案例内容：</span>
            <textarea id="add-alnr-textarea" class="common-textarea"></textarea>
        </p>
    </form>
    <p class="tcenter mt15 mb10">
        <b id="save-case" class="cm-save-btn mr15"></b>
        <b id="case-add-cancel" class="cm-cancel-btn"></b>
    </p>
</div>
<div id="case-view-div" class="hide">
    <div id="case-view-value">
        <p class="mt10">
            <span class="common-field">案例标题：</span>
            <input name="albt" class="common-input" unselectable="on" readonly="true" type="text" value="{albt}"/>
            <span class="common-field">项目单位：</span>
            <input name="xmdwmc" class="common-input" unselectable="on" readonly="true" type="text" value="{xmdwmc}"/>
        </p>
        <p class="mt10">
            <span class="common-field">共享人：</span>
            <input name="algxr" class="common-input" unselectable="on" readonly="true" type="text" value="{algxr}"/>
            <span class="common-field">共享日期：</span>
            <input name="createDateStr" class="common-input" unselectable="on" readonly="true" type="text" value="{createDateStr}"/>
        </p>
    </div>
    <p class="mt10">
        <span class="common-field fl">案例内容：</span>
        <div class="view-alnr"></div>
    </p>
    <p class="tcenter mt20 mb10">
        <b id="case-view-cancel" class="cm-close-btn"></b>
    </p>
</div>
<div id="case-edit-div" class="hide">
    <form id="case-edit-form">
        <input type="hidden" name="alnr"/>
        <input type="hidden" name="caseId"/>
        <input type="hidden" name="xmdwmc"/>
        <p class="mt10">
            <span class="common-field"><span class="orangered">★ </span>案例标题：</span>
            <input id="edit-albt" name="albt" class="case-edit-valid common-input mr100" type="text" data-options="required:true"/>
            <span class="common-field"><span class="orangered">★ </span>项目单位：</span>
            <dict dict-id="edit-xmdwdm" dict-name="xmdwdm" dict-type="tree" dict-root="custom" class="xmdwdm dict"></dict>
        </p>
        <p class="mt10">
            <span class="common-field"><span class="orangered">★ </span>共享人：</span>
            <dict dict-id="edit-gxr" dict-name="algxr" dict-type="select" dict-root="custom" class="gxr dict mr100"></dict>
            <!--<span class="common-field"><span class="orangered">★ </span>共享日期：</span>-->
            <!--<input id="edit-create-date" name="createDateStr" class="case-edit-valid query-date" type="text" data-options="required:true"/>-->
        </p>
        <p class="mt10">
            <span class="common-field fl"><span class="orangered">★ </span>案例内容：</span>
            <textarea id="edit-alnr-textarea" class="common-textarea"></textarea>
        </p>
    </form>
    <p class="tcenter mt15 mb10">
        <b id="update-case" class="cm-save-btn mr15"></b>
        <b id="case-edit-cancel" class="cm-cancel-btn"></b>
    </p>
</div>
</body>
<script type="text/template" id="case-list">
    <tr>
        <td>{rownum}</td>
        <td>{xmdwdm}</td>
        <td>{xmdwmc}</td>
        <td>{albt}</td>
        <td>{algxr}</td>
        <td>{createDateStr}</td>
        <td>
            <a class="into-case-view icon-show-btn" param="{id}" title="查看"></a>
            <a class="into-case-edit icon-edit-btn hidden{editLimit}" param="{id}" title="修改"></a>
            <a class="delete-case icon-remove-btn hidden{deleteLimit}" param="{id}" paramTj="{albt}" title="删除"></a>
            <br>
        </td>
    </tr>
</script>
<script src="../js/base.js"></script>
<script>
    importing('datepicker','dict','ckeditor',function(){

        var xmdwAction = top.path + '/api/0/basic/project/project_unit',
            gxrAction = top.path + '/api/0/basic/project/user_info',
            searchAction = top.path + '/api/0/ptcg/case/list',
            getDetailAction = top.path + '/api/0/ptcg/case/view',
            saveAction = top.path + '/api/0/ptcg/case/save',
            updateAction = top.path + '/api/0/ptcg/case/update',
            deleteAction = top.path + '/api/0/ptcg/case/delete';
        var addEditor,
            editEditor;
        var deleteLimit=top.ops['ptcg-alqkwh-delete'],
            editLimit=top.ops['ptcg-alqkwh-edit'],
            addLimit=top.ops['ptcg-alqkwh-add'];

        //设定默认ajax开始和结束时的loading遮罩效果($post自带,paginglist没有自带)
        $.ajaxSetup({
            beforeSend:showLoading,
            complete:hideLoading
        });

        $('.query-date').datepicker();

        //项目单位
        function queryForXmdw(){
            $get(xmdwAction,{},function(res){
                $('.xmdwdm').dict(res.data.unitInfo);
            });
        }
        //共享人(项目经理)
        function queryForGxr(){
            $get(gxrAction,{type:'1'},function(res){
                $('.gxr').dict(res.data);
            })
        }
        //查询案例列表
        function queryForCase(currentPage){
            $('#case-query-result').pagingList({
                action:searchAction,
                currentPage:currentPage,
                jsonObj:{
                    xmdwdm:$('#query-xmdwdm').val(),
                    algxr:$('#query-gxr').val(),
                    beginDateStr:$('#gxDateBegin').val(),
                    endDateStr:$('#gxDateEnd').val(),
                    keyWord:$('#gjz').val().trim()
                },
                callback:function(data){
                    $template('#case-table tbody', data, function(item, i){
                        item.deleteLimit = deleteLimit;
                        item.editLimit = editLimit;
                        if(item.algxr == localData.get('login-truename')){
                            item.deleteLimit = '1';
                            item.editLimit = '1';
                        }
                    });
                }
            });
        }
        //查询案例详细信息
        function intoCaseView(id){
            $get(getDetailAction,{id:id},function(res){
                $open('#case-view-div',{width:800, title:'查看信息'});
                $template('#case-view-value',res.data,function(item, i){
                    $('#case-view-div .view-alnr').html(item.alnr);
                });
            });
        }
        //进入案例新增页面
        function intoCaseAdd(){
            $('.case-add-valid').removeClass('validatebox-invalid');
            $open('#case-add-div',{width:920, title:'案例情况新增', onClose:function(){resetCaseAdd();}});

            //设置默认共享人和共享时间
            $('#add-gxr').val(localData.get('login-username'));
            $('#add-create-date').val(Date.format('YYYY-MM-DD'));
            if($('#add-gxr').val() == null){$('#add-gxr').val('');}

            //字典添加必填项
            $('#add-gxr').addClass('case-add-valid').attr('data-options','required:true');
            $('#add-xmdwdm_displayValue').addClass('case-add-valid').attr('data-options','required:true');

            //ckEditor加载到editor
            if(typeof addEditor == 'undefined'){
                addEditor = CKEDITOR.replace('add-alnr-textarea');
                CKEDITOR.instances['add-alnr-textarea'].on('change', function() {
                    copyImgUpload(addEditor);
                });
            }else{
                addEditor.setData('');
            }
            //$('.cke_dialog_ui_input_file').src='_blank';
            /*top.$('body').on('click',function(){
             console.log(frames)
             });*/
        }
        //进入案例修改页面
        function intoCaseEdit(id){
            $('.case-edit-valid').removeClass('validatebox-invalid');
            $get(getDetailAction,{id:id},function(res){
                $open('#case-edit-div',{width:920, title:'修改信息'});
                //$template('#case-edit-form',res.data);
                //手动赋值  用$template模板赋值时，dict的click事件会出问题
                $('#edit-albt').val(res.data.albt);
                $('#edit-create-date').val(res.data.createDateStr);
                $('#edit-alnr-textarea').val(res.data.alnr);

                $('#case-edit-form input[name="caseId"]').val(res.data.id);
                $('#edit-xmdwdm').val(res.data.xmdwdm);
                $('#edit-xmdwdm_displayValue').val(res.data.xmdwmc);
                $('#edit-gxr').val(res.data.algxrUsername);

                //字典添加必填项
                $('#edit-gxr').addClass('case-edit-valid').attr('data-options','required:true');
                $('#edit-xmdwdm_displayValue').addClass('case-edit-valid').attr('data-options','required:true');

                if(typeof editEditor == 'undefined'){
                    editEditor = CKEDITOR.replace('edit-alnr-textarea');
                    CKEDITOR.instances['edit-alnr-textarea'].on('change', function() {
                        copyImgUpload(editEditor);
                    });
                }else{
                    editEditor.setData(res.data.alnr);
                }
            });
        }
        //新增保存案例
        function saveCase(){
            $('.case-add-valid').validatebox();
            //对ckeditor必填项特殊处理
            if(addEditor.getData().isEmpty()){
                $('#cke_add-alnr-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_add-alnr-textarea').removeClass('validatebox-invalid');
            }

            if($('.validatebox-invalid').length > 0){
                return false;
            }

            $('#case-add-form input[name="alnr"]').val(addEditor.getData());
            $('#case-add-form input[name="xmdwmc"]').val($('#add-xmdwdm_displayValue').val());
            $post(saveAction,$('#case-add-form').serializeObject(),function(res){
                queryForCase();
                toast('保存成功！').ok();
                caseCloseWin('case-add-div');
            })
        }
        //修改保存案例
        function updateCase(){
            if($('#edit-gxr').val() == null){$('#edit-gxr').val('');}
            $('.case-edit-valid').validatebox();
            //对ckeditor必填项做特殊判断
            if(editEditor.getData().isEmpty()){
                $('#cke_edit-alnr-textarea').addClass('validatebox-invalid');
            }else{
                $('#cke_edit-alnr-textarea').removeClass('validatebox-invalid');
            }

            if($('.validatebox-invalid').length > 0){
                return false;
            }

            $('#case-edit-form input[name="alnr"]').val(editEditor.getData());
            $('#case-edit-form input[name="xmdwmc"]').val($('#edit-xmdwdm_displayValue').val());

            $post(updateAction,$('#case-edit-form').serializeObject(),function(res){
                queryForCase($('.paging').data('currentPage'));
                toast('保存成功！').ok();
                caseCloseWin('case-edit-div');
            });
        }
        //删除案例
        function deleteCase(id,albt){
            $confirm('确定删除【'+albt+'】案例吗？',function(bol){
                if(bol){
                    $post(deleteAction,{id:id},function(res){
                        toast('删除成功！').ok();
                        queryForCase($('.paging').data('currentPage'));
                    });
                }
            });
        }
        //关闭弹窗
        function caseCloseWin(id){
            $('#'+id).$close();
            $('.case-add-valid').removeClass('validatebox-invalid');
            $('.case-edit-valid').removeClass('validatebox-invalid');
        }
        //清除新增页面input中的值 并清除ckeditor的验证
        function resetCaseAdd(){
            $('#add-albt').val('');
            $('#add-xmdwdm').val('');
            $('#add-xmdwdm_displayValue').val('');
            $('#cke_add-alnr-textarea').removeClass('validatebox-invalid');
        }

        if(addLimit){$('#into-case-add').removeClass('hidePlus');}

        //自定义项目单位字典数据
        queryForXmdw();
        //自定义共享人字典数据
        queryForGxr();
        //执行查询
        queryForCase();

        $('#case-query-btn').on('click',function(){
            if($('.sort-arrow')) $('.sort-arrow').remove();
            var t_beginDate = $('#gxDateBegin').val();
            var t_endDate = $('#gxDateEnd').val();
            if(!t_beginDate.isEmpty() && !t_endDate.isEmpty() && t_beginDate > t_endDate){
                toast('共享开始日期不能大于结束日期！').css('width','300px').err();
                return false;
            }
            queryForCase();
        });
        $('#case-reset-btn').on('click',function(){
            $('#query-xmdwdm').val('');
            $('#query-xmdwdm_displayValue').val('');
            $('#gjz').val('');
            $('#query-gxr').val('');
            $('#gxDateBegin').val('');
            $('#gxDateEnd').val('');
        });
        $('#into-case-add').on('click',function(){
            intoCaseAdd();
        });
        $('#save-case').on('click',function(){
            saveCase();
        });
        $('#update-case').on('click',function(){
            updateCase();
        });
        $('#case-add-cancel').on('click',function(){
            caseCloseWin('case-add-div');
            resetCaseAdd();
        });
        $('#case-view-cancel').on('click',function(){
            caseCloseWin('case-view-div');
        });
        $('#case-edit-cancel').on('click',function(){
            caseCloseWin('case-edit-div');
        });
        $('#case-table').on('click','.delete-case',function(){
            deleteCase(this.getAttribute('param'),this.getAttribute('paramTj'));
        }).on('click','.into-case-view',function(){
            intoCaseView(this.getAttribute('param'));
        }).on('click','.into-case-edit',function(){
            intoCaseEdit(this.getAttribute('param'));
        });
    });
</script>
</html>