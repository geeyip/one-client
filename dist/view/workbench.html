<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta name="author" content="Xiong Ying" />
    <meta name="date" content="2016-07-08 10:44:26" />
    <title>工作台</title>
    <link rel="stylesheet" href="../css/base.css?version=0.99">
    <link rel="stylesheet" href="../css/workbench.css?version=0.99">
</head>
<body>
    <div id="app-service" class="workbench-wrap pr">
        <!--<div class="ladder"></div>-->
        <h2>应用服务监控</h2>
        <i id="get-monitor-btn" class="icon-refresh" title="最新监控结果"></i>
        <div class="tb-scroll-helper" tpsource="#app-service-tp">
        </div>
    </div>
    <div id="data-extraction" class="workbench-wrap">
        <!--<div class="ladder"></div>-->
        <h2>数据抽取监控</h2>
        <div class="tb-scroll-helper">
            <table tpsource="#data-extraction-tp">
            </table>
        </div>
    </div>
    <div id="user-feedback" class="workbench-wrap">
        <h2>用户反馈问题</h2>
        <table class="workbench-tb-thead">
            <tr>
                <td>反馈内容</td>
                <td width="188">反馈单位</td>
                <td width="138">反馈时间</td>
                <td width="48">操作</td>
            </tr>
        </table>
        <div class="tb-scroll-helper">
            <table class="workbench-tb" tpsource="#user-feedback-tp"></table>
        </div>
    </div>
    <div id="implementer-share" class="workbench-wrap">
        <h2>实施人员共享问题</h2>
        <i class="icon-list" title="更多"></i>
        <div class="tb-scroll-helper">
            <table class="workbench-tb">
                <thead>
                    <tr>
                        <td>问题描述</td>
                        <td>解决方法</td>
                        <td>共享人</td>
                        <td>共享日期</td>
                        <td>操作</td>
                    </tr>
                </thead>
                <tbody tpsource="#implementer-share-tp"></tbody>
            </table>
        </div>
    </div>
</body>
<script type="text/template" id="data-extraction-tp">
    <tr>
        <td>{xmdwmc}</td>
        <td>
            <a class="cq-data hide{isGetCqData} data-extract-link" xmdwdm="{xmdwdm}"><i class="icon-exclamation-sign{cqResult} icon-ok-sign"></i> 数据抽取<span class="hide{cqResult}">正常</span><span class="hide inline{cqResult}">异常</span></a>
            <span class="hide inline{isGetCqData}"><i class="icon-question-sign lakeblue"></i> 未抽取数据</span>
        </td>
        <td>
            <a class="zl-data hide{isGetZlData} data-extract-link" xmdwdm="{xmdwdm}"><i class="icon-exclamation-sign{zlResult} icon-ok-sign"></i> 质量校验<span class="hide{zlResult}">正常</span><span class="hide inline{zlResult}">异常</span></a>
            <span class="hide inline{isGetZlData}"><i class="icon-question-sign lakeblue"></i> 未抽取数据</span>
        </td>
    </tr>
</script>
<script type="text/template" id="comments">
    <dt class="pr">
        <i class="icon-user"></i>
    <p>
        <span>{trueName}</span>
        <span>{createDate}</span>
    </p>
    </dt>
    <dd class="comments-pjnr">{pjnr}</dd>
</script>
<script type="text/template" id="app-service-tp">
    <div class="monitor-msg-div">
        <img src="../img/{picName}">
        <div class="monitor-msg">
            <h3>{xmdwmc}</h3>
            <p>应用服务器IP地址：<a href="javascript:void(0);" class="remote-desktop" yczmzhmm="{yczmzhmm}" yyfwqdkh="{yyfwqdkh}">{yyfwqip}</a></p>
            <span class="mr15">实施负责人：{sswhry}</span>
            <a href="###" class="icon-time fs16 linkblue mr15" title="历史异常处理" xmdwdm="{xmdwdm}"></a>
            <a href="###" class="icon-info-sign fs16 linkblue hideplus{showFeedBack}" title="异常处理反馈" xmdwdm="{xmdwdm}" xmId = {xmId}></a>
        </div>
    </div>
</script>
<script type="text/template" id="user-feedback-tp">
    <tr>
        <td>
            <div class="workbench-ellipsis" title="{fknr}">{fknr}</div>
        </td>
        <td width="188" class="tcenter">{fkdwmc}</td>
        <td width="138" class="tcenter">{fksj}</td>
        <td width="48" class="tcenter">
            <!--<a href="#" class="view-fkxx icon-show-btn " title="查看" param="{id}" picId="{pictureId}"></a>-->
            <a href="#" id="handel{id}" class="handle-fkxx icon-edit-btn no-edit{this.feedbackEditLimit}" param="{id}" picId="{pictureId}" title="处理"></a>
        </td>
    </tr>
</script>
<script type="text/template" id="implementer-share-tp">
    <tr>
        <!--<td width="50" class="issueTypeZw">{issueTypeZw}</td>-->
        <td class="issueContent"><div class="workbench-ellipsis" title="{issueContent}">{issueContent}</div></td>
        <td class="sloveDesc"><div class="workbench-ellipsis" title="{sloveDesc}">{sloveDesc}</div></td>
        <td width="60" class="tcenter">{shareUwer}</td>
        <td width="74">{shareDateStr}</td>
        <td width="98">
            <a class="search-share icon-show-btn" title="查看" pid="{id}" shareUwer="{shareUwer}" shareDate="{shareDateStr}"></a>
            <i class="hit icon-like-before-btn{sfyz} icon-like-after-btn" title="赞" type="1" ssgxwtxxId="{id}">{wtdzs.toString}</i>
            <i class="hit icon-unlike-before-btn{sfyc} icon-unlike-after-btn" title="踩" type="2" ssgxwtxxId="{id}">{wtcs.toString}</i>
            <i class="icon-comments-btn hidePlus{this.commentLimit}" title="评论" pid="{id}" shareUwer="{shareUwer}" shareDate="{shareDateStr}"></i>
        </td>
    </tr>
</script>
<script src="../js/base.js?version=0.99"></script>
<!--<script src="../js/workbench.js?version=0.99"></script>-->
<script>
    (function(fn){
        fn && typeof window[fn]=='function' && window[fn]();
    })('@@pageFn');
    var userFeedbackListAction = top.path + '/api/0/feedback/userfeed/list',
            defaultHtml = '<div class="workbench-tip"><img src="../img/sys-module-default.png"><p>暂无数据</p></div>',
            feedbackEditLimit=top.ops['feedback-mng-handl'];//反馈修改权限

    importing('dict',function () {
        var appServiceListAction = top.path + '/api/0/xmjk/server/list',
                dataExtractionListAction = top.path + '/api/0/xmjk/extract/query',
                impleShareListAction = top.path + '/api/0/feedback/share/list',
                shareHitAction = top.path+'/api/0/feedback/share/hit',
                monitorStateAction = top.path + '/api/0/xmjk/server/monitor_state',
                latestMonitorAction = top.path + '/api/0/xmjk/server/monitor',
                commentLimit=top.ops['feedback-share-comment'],
                alreadyClicked = false,
                getMonitorBtn = $('#get-monitor-btn');

        $get(monitorStateAction,{},function (res) {
            if(res.data === '1'){
                alreadyClicked  = true;
                getMonitorBtn.addClass('disabled-refresh');
            }
        });
        $get(appServiceListAction,{'appResult':'0,2'},function (res) {
//                log('appservice:'+obj2str(res.data));
            var appData = res.data;
            if(appData.length<1){
                $('#app-service').find('.tb-scroll-helper').append(defaultHtml);
            }else{
                $('#app-service').find('.tb-scroll-helper').template(appData,function (item) {
                    var appResult = item.appResult;
                    if(appResult === '0'){//异常
                        item.picName = 'server_notok.png';
                        item.showFeedBack = 1;
                    }else if(appResult === '1'){//正常
                        item.picName = 'server_ok.png';
                        item.showFeedBack = 0;
                    }else if(appResult === '2'){//未监控
                        item.picName = 'server_unkown.png';
                        item.showFeedBack = 0;
                    }
                });
            }
        });
        getdataExtractionList();
        getUserFeedbackList();
        getImpleShareList();

        function getdataExtractionList() {
            var rolesEn = top.roles.select('item=>item.en');
            var obj = {};
            if(rolesEn.indexOf('administrator') > -1){
                obj = {'work':1,'end':1000};
            }else if(rolesEn.indexOf('manager') > -1){
                obj = {'work':1,'end':1000,'xmjl':localData.get('login-username')};
            }else if(rolesEn.indexOf('implement') > -1){
                obj = {'work':1,'end':1000,'ssry':localData.get('login-username')};
            }else{
                obj = {'work':1,'end':1000};
            }
            $get(dataExtractionListAction,obj,function (res) {
                var extractData = res.data;
                if(extractData.length<1){
                    $('#data-extraction').find('.tb-scroll-helper').append(defaultHtml);
                }else{
                    $('#data-extraction').find('table').template(extractData,function (item) {
                        if(item.cqResult === '0'){
                            item.cqResult = 0
                        }
                        if(item.zlResult === '0'){
                            item.zlResult = 0
                        }
                        if(item.cqResult === '1'){
                            item.cqResult = 1;
                        }
                        if(item.zlResult === '1'){
                            item.zlResult = 1;
                        }
                        if(item.cqResult === null){
                            item.isGetCqData = 0;
                        }else{
                            item.isGetCqData = 1;
                        }
                        if(item.zlResult === null){
                            item.isGetZlData = 0;
                        }else{
                            item.isGetZlData = 1;
                        }
                    });
                }
            });
        }
        function getImpleShareList(){
            $post(impleShareListAction,{'end':7},function (res) {
//                log('impleShare:'+obj2str(res.data));
                var impleData = res.data;
                if(impleData.length<1){
                    $('#implementer-share').find('.tb-scroll-helper').append(defaultHtml);
                }else{
                    $('#implementer-share').find('tbody').fixData({commentLimit:commentLimit}).template(impleData).find('.workbench-ellipsis').each(function () {
                        $(this).width($(this).parent().width()-20);
                    });
                }
            });
        }

        $('#app-service').on('click','.icon-time',function () {//打开历史异常处理弹窗
            var xmdwdm = $(this).attr('xmdwdm');
            var historyWin = $open(top.getViewPath('prj-watch-yyfwjk-history.html'),{width:780,title:'历史异常处理'},true,function () {
                intoHandleHistory(xmdwdm,historyWin);
            });
        }).on('click','.icon-info-sign',function () {//打开异常处理反馈弹窗
            var xmdwdm = $(this).attr('xmdwdm'),
                    xmId = $(this).attr('xmId');
            var handleWin = $open(top.getViewPath('prj-watch-yyfwjk-add.html'),{width:820,title:'异常处理反馈'},true,function () {
                addHandleFeedBack(xmdwdm,xmId,handleWin);
            });
        }).on('click','.remote-desktop',function () {//打开远程桌面
            var that = $(this),
                    yczmzhmmArr = that.attr('yczmzhmm').split(/\/|<br>|<br\/>/),
                    yyfwqip = that.html();
            if(yczmzhmmArr.length<2){
                yczmzhmmArr[1] = '';
            }
            if(!top.openRemoteDesktop){return false;}
            top.openRemoteDesktop(yyfwqip,yczmzhmmArr[0],yczmzhmmArr[1]);
        });

        //实施人员共享问题查看 实施人员共享问题赞踩
        $('#implementer-share').on('click','.search-share',function () {
            var pid = $(this).attr('pid');
            var viewWin=$open(top.getViewPath('feedback-share-view.html'), {width: 820, title: '共享问题查看'},true,function (){
                intoViewShare(pid,viewWin);
            });
        }).on('click','.hit',function () {
            var type = $(this).attr('type');
            if(type == 1 && $(this).hasClass('icon-like-before-btn1')){
                toast('已经赞过了！').addClass('ok');
                return false;
            }
            if(type == 2 && $(this).hasClass('icon-unlike-before-btn1')){
                toast('已经踩过了！');
                return false;
            }
            var ssgxwtxxId = $(this).attr('ssgxwtxxId');
            $post(shareHitAction,{type:type,ssgxwtxxId:ssgxwtxxId},function (res) {
                toast(res.msg,600).ok();
                //加载问题列表数据
                getImpleShareList();
            });
        }).on('click','.icon-comments-btn',function () {//评论
            var pid = $(this).attr('pid');
            var commentWin=$open(top.getViewPath('feedback-share-comment.html'), {width: 820, title: '共享问题评论'},true,function (){
                intoCommentShare(pid,commentWin);
            });
        }).on('click','.icon-list',function () {
            //如果已经打开过,并且没有被关闭清除, 那就直接选中现在这个
            if(typeof window.feedbackShare=='object' && window.feedbackShare.children().length>0){
                window.feedbackShare.$select();
            }else{
                window.feedbackShare=$open(top.getViewPath('feedback-share.html'),'实施共享问题');
            }
        });
//        //参数去空格
//        function trimAll(selector) {
//            $(selector+' input,'+selector+' textarea').each(function (i,el) {
//                var value = $(el).val();
//                $(el).val(value.trim());
//            });
//        }

//        //保存事件
//        function saveFeedBack(){
//            trimAll('#handel-fkxx-block');
//            $('.validate').validatebox();
//            if($('.validatebox-invalid').length>0){
//                return false;
//            }
//            $post(saveFeedBackAction,$("#handel-fkxx-from").serializeObject(),function(res){
//                commCloseWin('handel-fkxx-block');
//                toast('保存成功！').ok();
//                getUserFeedbackList();
//            },true);
//        }
//        //关闭窗口
//        function commCloseWin(id){
//            $('#'+id).$close();
//        }

        //处理反馈、查看反馈
        $('#user-feedback').on('click','.handle-fkxx:not(.hide)',function(){
            if(!feedbackEditLimit) return false;
            var id = this.getAttribute('param');
            var msgEditWin = $open(top.getViewPath('feedback-mng-edit.html'), {width: 800, title: '反馈信息处理'},true,function () {
                intoEditFeedBack(id, msgEditWin, 'workbench', null);
            });
        });
//                .on('click','.view-fkxx:not(.hide)',function(){
//            var id = this.getAttribute('param');
//            var msgViewWin = $open(top.getViewPath('feedback-mng-view.html'), {width: 800, title: '反馈信息查看'},true,function () {
//                intoViewFeedBack(id, msgViewWin);
//            });
//        });

        //获取最新监控结果
        getMonitorBtn.on('click',function () {
            if(alreadyClicked){
                return false;
            }
            alreadyClicked = true;
            getMonitorBtn.addClass('disabled-refresh');
            $get(latestMonitorAction,{},function (res) {
                var msg = res.msg ? res.msg : '更新成功！';
                toast(msg,600).ok();
                getMonitorBtn.removeClass('disabled-refresh');
                alreadyClicked = false;
            },false,false);
        });
        $('#data-extraction').on('click','.cq-data',function () {
            var xmdwdm = this.getAttribute('xmdwdm');
            var extractWin = $open(top.getViewPath('prj-watch-sjcqjk-extract.html'), {width:760, title:'数据抽取异常'}, true, function(){
                intoExtractQuestion(xmdwdm, extractWin);
            });
        }).on('click','.zl-data',function () {
            var xmdwdm = this.getAttribute('xmdwdm');
            var qualityWin = $open(top.getViewPath('prj-watch-sjcqjk-quality.html'), {width:760, title:'数据质量异常'}, true, function(){
                intoQualityQuestion(xmdwdm, qualityWin);
            });
        });

        $('#wtlxdm-cl').dict();
        $(window).resize(function () {
            $('.workbench-ellipsis').each(function () {
                $(this).width($(this).parent().width()-20);
            });
        });
    });
    function  getUserFeedbackList() {
//        var type = top.roles.select('o=>o.en').toString().indexOf('administrator')>-1 ? 1 : 0;
        var type;
        for(var i=0;i<top.roles.length;i++){
            if(top.roles[i].en=="administrator"||top.roles[i].en==null){
                type = '1';
                break;
            }
        }
        $post(userFeedbackListAction,{'clztdm':0,'type':type},function (res) {
            var pxqkPageData = res.data;
            if(pxqkPageData.length<1){
                $('#user-feedback').find('.tb-scroll-helper').append(defaultHtml).find('.workbench-tb').template(pxqkPageData);
            }else{
                $('#user-feedback').find('.workbench-tb').fixData({feedbackEditLimit:feedbackEditLimit}).template(pxqkPageData).find('.workbench-ellipsis').each(function () {
                    $(this).width($(this).parent().width()-20);
                });
            }
        });
    }
//    function  getUserFeedbackList() {
//        var type;
//        for(var i=0;i<top.roles.length;i++){
//            if(top.roles[i].en=="administrator"||top.roles[i].en==null){
//                type = '1';
//                break;
//            }
//        }
//        console.log(top.roles)
//        $post(userFeedbackListAction,{'clztdm':0,'type':type},function (res) {
//            pxqkPageData = res.data;
//            if(pxqkPageData.length<1){
//                $('#user-feedback').append(defaultHtml);
//            }else{
//                $('#user-feedback').find('.workbench-tb').template(pxqkPageData);
//                if(typeof(editLimit)=='undefined'){
//                    $('.icon-edit-btn').addClass('hidePlus');
//                }
//            }
//        });
//    }
</script>
</html>