<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>实施共享问题</title>
    <link rel="stylesheet" href="../../dist/css/base.css">
    <link rel="stylesheet" href="../css/feedback.css"/>
</head>
<body>
    <!--查询条件-->
    <div class="query-condition mt10">
        <form id="share-form">
            <div class="query-condition-p">
                <span class="common-field w65">问题类别：</span>
                <dict dict-id="issueType" dict-name="issueType" dict-type="select" dict-root="GXWTLBDM" class="dict mr15"></dict>
                <span class="common-field w75">共享日期：</span>
                <input type="text" name="shareDateBegin" id="shareDateBegin" class="query-date"/>~<input type="text" name="shareDateEnd" id="shareDateEnd" class="query-date mr15"/>
                <span class="common-field w65">共享人：</span>
                <dict dict-id="shareUwer" dict-name="shareUwer" dict-type="select" dict-root="custom"  class="share-user mr15" ></dict>
                <p class="query-reset">
                    <b class="cm-query-btn" id="query-btn"></b>
                    <b class="cm-reset-btn" id="reset-btn"></b>
                </p>
            </div>
            <div class="query-condition-p">
                <span class="common-field w65">问题描述：</span>
                <input id="issueContent" name="issueContent" type="text" class="common-input" placeholder="问题描述或解决方法的关键字"/>
            </div>
        </form>
    </div>
    <!--列表-->
    <div id="query-result" class="mt20">
        <div class="new-color-bar">
            <span class="title">问题共享列表（共找到<span class="total-count"></span>条数据）</span>
            <div class="bar-btn-div">
                <b id="into-share-add" class="cm-add-btn hidePlus"></b>
                <b class="cm-add-btn share-dz"></b>
            </div>
        </div>
        <table id="share-info-table" class="typical-tb" cellpadding="3">
            <thead>
            <th width="5%">序号</th>
            <th width="10%">问题类别</th>
            <th width="25%">问题描述</th>
            <th width="27%">解决方法</th>
            <th width="9%">共享人</th>
            <th width="10%" sort-name="shareDate">共享日期</th>
            <th width="14%">操作</th>
            </thead>
            <tbody tpsource="#share-info-list"></tbody>
        </table>
        <div class="paging"></div>
    </div>
    <!--新增弹窗-->
    <div id="add-share-block" class="hide">
        <form id="add-form">
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>问题类别：</span>
                <dict dict-id="add-issueType" dict-name="issueType" dict-type="select" dict-root="GXWTLBDM" class="dict mr15 validate" data-options="required:true"></dict>
            </p>
            <p>
                <span class="common-field fl"><span class="orangered">★ </span>问题描述：</span>
                <textarea id="add-issueContent" name="issueContent" class="common-textarea share-text validate" data-options="required:true,validType:'length[1,2000]'"></textarea>
            </p>
            <p>
                <span class="common-field fl"><span class="orangered">★ </span>解决方法：</span>
                <textarea id="add-sloveDesc" name="sloveDesc" class="common-textarea share-text validate" data-options="required:true,validType:'length[1,2000]'"></textarea>
            </p>
            <p>
                <span class="common-field w115"><span class="orangered">★ </span>共享人：</span>
                <dict dict-id="add-shareUwer" id="add-shareUwer-dict" dict-name="shareUwer" dict-type="select" dict-root="custom" class="share-user validate" data-options="required:true" ></dict>
                <span class="common-field w65"><span class="orangered">★ </span>共享日期：</span>
                <input type="text" name="shareDate" id="add-shareDate" class="common-input query-date validate" data-options="required:true">
            </p>
            <p class="mt20 tcenter mb15">
                <b id="add-save-btn" class="cm-save-btn mr15"></b>
                <b id="add-close-btn" class="cm-cancel-btn"></b>
            </p>
        </form>
    </div>
    <!--修改弹窗-->
    <div id="edit-share-block" class="hide">
        <form id="edit-form">
            <input id="edit-id" name="mainId" type="hidden"/>
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>问题类别：</span>
                <dict id="edit-issueType-dict" dict-id="edit-issueType" dict-name="issueType" dict-type="select" dict-root="GXWTLBDM" empty="false" class="dict mr15 validate" data-options="required:true"></dict>
            </p>
            <p>
                <span class="common-field fl"><span class="orangered">★ </span>问题描述：</span>
                <textarea id="edit-issueContent" name="issueContent" class="common-textarea share-text validate" data-options="required:true,validType:'length[1,2000]'"></textarea>
            </p>
            <p>
                <span class="common-field fl"><span class="orangered">★ </span>解决方法：</span>
                <textarea id="edit-sloveDesc" name="sloveDesc" class="common-textarea share-text validate" data-options="required:true,validType:'length[1,2000]'"></textarea>
            </p>
            <p>
                <span class="common-field w115"><span class="orangered">★ </span>共享人：</span>
                <dict id="edit-shareUwer-dict" dict-id="edit-shareUwer" dict-name="shareUwer" dict-type="select" dict-root="custom" class="share-user mr15 validate" data-options="required:true"></dict>
                <span class="common-field w65"><span class="orangered">★ </span>共享日期：</span>
                <input type="text" name="shareDate" id="edit-shareDate" class="common-input query-date validate" data-options="required:true">
            </p>
            <p class="mt20 tcenter mb15">
                <b id="edit-save-btn" class="cm-save-btn mr15"></b>
                <b id="edit-close-btn" class="cm-cancel-btn"></b>
            </p>
        </form>
    </div>

</body>
<!--列表内容-->
<script type="text/template" id="share-info-list">
    <tr class="{$nth2}">
        <td>{rownum}</td>
        <td class="issueTypeZw">{issueTypeZw}</td>
        <td class="issueContent">
            <p class="brief-content tleft" readonly>{issueContent}</p>
            <a class="more-a" href="javascript:void(0);" moreId="{id}u">更多</a>
        </td>
        <td class="sloveDesc">
            <p class="brief-content tleft" readonly>{sloveDesc}</p>
            <a class="more-a" href="javascript:void(0);" moreId="{id}c">更多</a>
        </td>
        <td class="shareUwerZw">{shareUwerZw}</td>
        <td>{shareDateStr}</td>
        <td>
            <a class="search-share icon-show-btn" title="查看" pid="{id}" shareUwer="{shareUwer}" shareDate="{shareDateStr}"></a>
            <a class="modify-share icon-edit-btn hidePlus{editLimit} " issueType="{issueType}" shareUwer="{shareUwer}" shareDate="{shareDateStr}" editId="{id}" title="修改"></a>
            <a class="remove-share icon-remove-btn hidePlus{deleteLimit}" title="删除" shareId="{id}" shareUwer="{shareUwer}" issueTypeZw="{issueTypeZw}"></a>
            <p>
            <i class="hit icon-like-before-btn{sfyz} icon-like-after-btn" title="赞" type="1" ssgxwtxxId="{id}">{wtdzs.toString}</i>
            <i class="hit icon-unlike-before-btn{sfyc} icon-unlike-after-btn" title="踩" type="2" ssgxwtxxId="{id}">{wtcs.toString}</i>
            <i class="icon-comments-btn hidePlus{commentLimit}" title="评论" pid="{id}" shareUwer="{shareUwer}" shareDate="{shareDateStr}"></i>
            </p>
        </td>
    </tr>
</script>
<script src="../../dist/js/base.js"></script>
<script>
    importing('datepicker','dict',function () {
        var shareListAction = top.path+'/api/0/feedback/share/list',
                shareCommentListAction = top.path+'/api/0/feedback/share/comment_list',
                shareAddAction = top.path+'/api/0/feedback/share/add',
                shareEditAction = top.path+'/api/0/feedback/share/edit',
                shareDeleteAction = top.path+'/api/0/feedback/share/delete',
                shareUserAction = top.path+'/api/0/basic/project/user_info',
                shareHitAction = top.path+'/api/0/feedback/share/hit';

        var deleteLimit=top.ops['feedback-share-delete'],
                editLimit=top.ops['feedback-share-edit'],
                addLimit=top.ops['feedback-share-add'],
                commentLimit=top.ops['feedback-share-comment'],
                shareUserData,
                pageData = [];

        $('.query-date').datepicker();
        $('.dict').dict();
        //加载问题列表
        function loadShareList(zdSort, currentPage) {
            var params = {};
            params = $('#share-form').serializeObject();
            if(zdSort) {
                params.sortOrder = zdSort;
                params.sortName = 'wtdzs';
            }
//            $encode.allowHTML = true;
            $('#query-result').pagingList({
                action:shareListAction,
                currentPage:currentPage,
                jsonObj:params,
                callback:pageBack
            });
        }
        //回调函数
        function pageBack(data) {
            pageData = data;
            $template('#share-info-table tbody', data, function(item, i){
                var issueContent = item.issueContent;
                var sloveDesc = item.sloveDesc;
                item.issueContent = issueContent?item.issueContent.replace(/\n/gm, '<br>'):'';
                item.sloveDesc = sloveDesc?item.sloveDesc.replace(/\n/gm, '<br>'):'';
                item.deleteLimit = deleteLimit;
                item.editLimit = editLimit;
                item.commentLimit = commentLimit;
                if(item.shareUwer == localData.get('login-username')){
                    item.deleteLimit = '1';
                    item.editLimit = '1';
                    item.commentLimit = '1';
                }
            },true);
            //内容在4行内的不显示“更多”
            isShowMore();
            //修改
            $('.modify-share').on('click',function () {
                $open('#edit-share-block',{title:'共享问题修改',width:820});
                //初始化修改弹窗数据
                initWinData.call(this,'#edit-issueType','#edit-issueContent','#edit-sloveDesc','#edit-shareUwer','#edit-shareDate');
            });
            //查看
            $('.search-share').on('click',function () {
                var pid = $(this).attr('pid');
                var viewWin=$open('feedback-share-view.html', {width: 820, title: '共享问题查看'},true,function (){
                    intoViewShare(pid,viewWin);
                });
            });
            //评论
            $('.icon-comments-btn').on('click',function () {
                var pid = $(this).attr('pid');
                var commentWin=$open('feedback-share-comment.html', {width: 820, title: '共享问题评论'},true,function (){
                    intoCommentShare(pid,commentWin);
                });
            });
            //赞踩
            $('.hit').on('click',function () {
                var type = $(this).attr('type');
                if(type == 1 && $(this).hasClass('icon-like-before-btn1')){
                    toast('已经赞过了！');
                    return false;
                }
                if(type == 2 && $(this).hasClass('icon-unlike-before-btn1')){
                    toast('已经踩过了！');
                    return false;
                }
                var ssgxwtxxId = $(this).attr('ssgxwtxxId');
                $post(shareHitAction,{type:type,ssgxwtxxId:ssgxwtxxId},function (res) {
                    toast(res.msg,600).ok();
                    //加载问题列表数据
                    loadShareList('', $('.paging').data('currentPage'));
                });
            });
            //删除
            $('.remove-share').on('click',function () {
                var id = $(this).attr('shareId');
                var shareUwer = $(this).attr('shareUwer');
                var issueTypeZw = $(this).attr('issueTypeZw');
                $confirm('确定删除'+shareUwer+'共享的'+issueTypeZw+'问题吗？',function (del) {
                    if(del){
                        $post(shareDeleteAction,{id:id},function (res) {
                            var msg = res.msg?res.msg:'删除成功！';
                            toast(msg,600).ok();
                            //加载问题列表数据
                            loadShareList('', $('.paging').data('currentPage'));
                        });
                    }
                });
            });
        }
        //初始化方法
        function init() {
            //加载系统版本列表数据
            loadShareList();
        }
        //共享人
        function getShareUser(){
            $get(shareUserAction,{type:'2'},function(res){
                shareUserData = res.data;
                $('.share-user').dict(shareUserData);
            })
        }
        //保存
        function saveShare(action,params,winId,formId) {
            //验证
            $(winId+' .validate').validatebox();
            if($('.validatebox-invalid').length>0){
                return false;
            }
            //保存
            $post(action,params,function (res) {
                var msg = res.msg?res.msg:'保存成功！';
                closeWin(winId,formId);
                toast(msg,600).ok();
                //加载问题列表数据
                loadShareList('', $('.paging').data('currentPage'));
            },true);
        }
        //关闭弹窗
        function closeWin(winId,formId) {
            $(winId).$close();
            $(formId)[0].reset();
            $('.validate').removeClass('validatebox-invalid');
        }
        //初始化窗口数据
        function initWinData(issueTypeZwId,issueContentId,sloveDescId,shareUwerId,shareDateId) {
            var that = $(this),
                    pTd = that.parent(),
                    thatArr = pageData.where('o=>o.id=="'+that.attr('editId')+'"'),
                    sqlArrDesc = thatArr.select('o=>o.sloveDesc'),
                    sqlArrContent = thatArr.select('o=>o.issueContent');
            $('#edit-id').val(that.attr('editId'));
            $(issueTypeZwId).val(pTd.siblings('.issueTypeZw').html());
            $('#edit-issueType').val(that.attr('issueType'));
            $(shareUwerId).dictSelect(that.attr('shareUwer'));
            $(shareDateId).val(that.attr('shareDate'));
            $(sloveDescId).val(sqlArrDesc.toString().replace(/<br>|br\/>/gm,''));
            $(issueContentId).val(sqlArrContent.toString().replace(/<br>|br\/>/gm,''));
        }
        //初始化
        init();
        //获得共享用户
        getShareUser();
        //新增权限设置
        if(addLimit){$('#into-share-add').removeClass('hidePlus');}
        //查询
        $('#query-btn').on('click',function () {
            var t_beginDate = $('#shareDateBegin').val();
            var t_endDate = $('#shareDateEnd').val();
            if(!t_beginDate.isEmpty() && !t_endDate.isEmpty() && t_beginDate > t_endDate){
                toast('共享开始日期不能大于结束日期！').css('width','300px').err();
                return false;
            }
            if($('.sort-arrow')) $('.sort-arrow').remove();
            $('.share-dz').removeClass('share-dz-desc');
            $('.share-dz').removeClass('share-dz-asc');
            loadShareList();
        });
        //重置
        $('#reset-btn').on('click',function () {
            $('#share-form')[0].reset();
        });
        //点赞排序
        $('.share-dz').on('click',function () {
            var that = $(this);
            if(that.hasClass('share-dz-desc')) {
                that.removeClass('share-dz-desc');
                that.addClass('share-dz-asc');
                loadShareList('asc');
            } else {
                that.removeClass('share-dz-asc');
                that.addClass('share-dz-desc');
                loadShareList('desc');
            }
        });
        //新增
        $('#into-share-add').on('click',function () {
            $open('#add-share-block',{title:'共享问题新增',width:820});
            $('#add-shareDate').val(new Date().format('yyyy-mm-dd'))
            $('#add-shareUwer').dictSelect(top.userName);
            $('#add-shareUwer').addClass('validate').attr('data-options','required:true');
        });
        //关闭新增弹窗
        $('#add-close-btn').on('click',function () {
            closeWin('#add-share-block','#add-form');
        });
        //保存新增内容
        $('#add-save-btn').on('click',function () {
            saveShare(shareAddAction,$('#add-form').serializeObject(),'#add-share-block','#add-form');
        });
        //关闭修改弹窗
        $('#edit-close-btn').on('click',function () {
            closeWin('#edit-share-block','#edit-form');
        });
        //保存修改内容
        $('#edit-save-btn').on('click',function () {
            saveShare(shareEditAction,$('#edit-form').serializeObject(),'#edit-share-block','#edit-form');
        });

    });
</script>
</html>